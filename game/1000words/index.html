const handleChoice = (choice) => {
    if (testFeedback) return;
    
    const currentKey = currentList[idx];

    if (choice === currentKey) {
        // --- 答對了 ---
        speak(currentKey);
        setTestFeedback('correct');
        
        if (!learnedWords.includes(currentKey)) {
            setLearnedWords(prev => [...prev, currentKey]);
        }

        setTimeout(() => {
            setTestFeedback(null);
            
            if (isChallenge) {
                // Survival 模式
                const newScore = score + 1;
                setScore(newScore);
                const nextWord = fullList[Math.floor(Math.random() * fullList.length)];
                const newList = [...currentList, nextWord];
                setCurrentList(newList);
                setIdx(idx + 1);
                localStorage.setItem('survival_score', newScore);
                localStorage.setItem('survival_list', JSON.stringify(newList));
            } else {
                // --- Test 模式：確保跳轉 ---
                const nextIdx = idx + 1;
                if (nextIdx < currentList.length) {
                    setIdx(nextIdx);
                } else {
                    // 全關完成
                    playSound('finish');
                    setShowGameOver(true);
                }
            }
        }, 800); 

    } else {
        // --- 答錯了 ---
        setTestFeedback('wrong');
        playSound('wrong');
        if (!wrongWords.includes(currentKey)) {
            setWrongWords(prev => [...prev, currentKey]);
        }

        if (isChallenge) {
            localStorage.removeItem('survival_score');
            localStorage.removeItem('survival_list');
            setTimeout(() => setShowGameOver(true), 600);
        } else {
            setTimeout(() => setTestFeedback(null), 600);
        }
    }
};
