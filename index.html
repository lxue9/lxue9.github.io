<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="vocabulary.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');
        body { 
            font-family: 'Nunito', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background: #fcfcfd; 
            color: #1e293b;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        .floating-nav { 
            position: fixed; bottom: 24px; left: 20px; right: 20px; 
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 32px; 
            z-index: 100; padding: 12px; box-shadow: 0 15px 35px -5px rgba(0,0,0,0.1);
        }

        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 500; padding: 20px; }
        .card-inner { transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); transform-style: preserve-3d; height: 420px; width: 100%; max-width: 340px; margin: 0 auto; position: relative; }
        .flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 48px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.04); border: 10px solid white; }
        .card-back { background: #6366F1; color: white; transform: rotateY(180deg); }
        .btn-active { transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .btn-active:active { transform: scale(0.95); opacity: 0.8; }
        .badge { position: absolute; top: -6px; right: -6px; background: #fb7185; color: white; font-size: 10px; font-weight: 900; padding: 2px 8px; border-radius: 10px; border: 2px solid white; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const App = () => {
            const [view, setView] = useState('menu');
            const [currentLevel, setCurrentLevel] = useState('1');
            const [idx, setIdx] = useState(0);
            const [flipped, setFlipped] = useState(false);
            const [testFeedback, setTestFeedback] = useState(null);
            const [isChecking, setIsChecking] = useState(false);
            const [userName, setUserName] = useState(() => localStorage.getItem('steve_name') || '');
            const [showNameModal, setShowNameModal] = useState(!localStorage.getItem('steve_name'));
            const [tempName, setTempName] = useState(localStorage.getItem('steve_name') || '');
            
            const [learnedWords, setLearnedWords] = useState(() => JSON.parse(localStorage.getItem('steve_learned') || '[]'));
            const [wrongWords, setWrongWords] = useState(() => JSON.parse(localStorage.getItem('steve_wrong') || '[]'));
            const [highScore, setHighScore] = useState(() => parseInt(localStorage.getItem('steve_highscore')) || 0);
            const [streak, setStreak] = useState(() => parseInt(localStorage.getItem('steve_streak')) || 0);

            const [isChallenge, setIsChallenge] = useState(false);
            const [isWrongSetMode, setIsWrongSetMode] = useState(false);
            const [currentList, setCurrentList] = useState([]);
            const [score, setScore] = useState(0);
            const [showGameOver, setShowGameOver] = useState(false);

            const audioRefs = {
                wrong: useRef(new Audio('https://public-assets.content-platform.envatousercontent.com/9361a9da-7e98-4686-895e-31ae5104a94f/c25e4b18-ce9e-4fb6-a71f-7d10d3bdf767/preview.mp3')),
                correct: useRef(new Audio('https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3')),
                finish: useRef(new Audio('https://assets.mixkit.co/active_storage/sfx/2017/2017-preview.mp3'))
            };

            const dbData = window.DB || (typeof DB !== 'undefined' ? DB : null);
            const fullList = useMemo(() => {
                if (!dbData) return [];
                let all = [];
                Object.values(dbData).forEach(lvl => { all = all.concat(Object.keys(lvl.words)); });
                return all;
            }, [dbData]);

            const [shuffledOptions, setShuffledOptions] = useState([]);
            const currentKey = currentList[idx];

            // å¢å¼ºç‰ˆè¯­éŸ³æ’­æ”¾ï¼šç¡®ä¿åœ¨ç§»åŠ¨ç«¯ä¹Ÿèƒ½è¢«è§¦å‘
            const speak = (text) => {
                if (!text) return;
                window.speechSynthesis.cancel();
                const utter = new SpeechSynthesisUtterance(text);
                utter.lang = 'en-US';
                utter.rate = 1.0;
                utter.pitch = 1.0;
                window.speechSynthesis.speak(utter);
            };

            const playSound = (type) => {
                const sound = audioRefs[type].current;
                if (sound) { sound.currentTime = 0; sound.play().catch(()=>{}); }
            };

            const resetProgress = () => {
                if (confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰è¿›åº¦å—ï¼Ÿ")) {
                    setLearnedWords([]); setWrongWords([]); setHighScore(0);
                    localStorage.setItem('steve_learned', '[]'); 
                    localStorage.setItem('steve_wrong', '[]'); 
                    localStorage.setItem('steve_highscore', '0');
                }
            };

            useEffect(() => {
                localStorage.setItem('steve_learned', JSON.stringify(learnedWords));
                localStorage.setItem('steve_wrong', JSON.stringify(wrongWords));
                localStorage.setItem('steve_highscore', highScore.toString());
            }, [learnedWords, wrongWords, highScore]);

            useEffect(() => {
                if (currentKey && fullList.length > 0) {
                    const distractors = fullList.filter(k => k !== currentKey).sort(() => 0.5 - Math.random()).slice(0, 3);
                    setShuffledOptions([currentKey, ...distractors].sort(() => 0.5 - Math.random()));
                    setTestFeedback(null);
                }
            }, [currentKey, currentList, fullList]);

            const handleChoice = (choice) => {
                if (testFeedback) return;
                
                if (choice === currentKey) {
                    // å…³é”®ä¿®å¤ï¼šå…ˆæ’­æ”¾å‘éŸ³ï¼Œå†æ›´æ–°çŠ¶æ€
                    speak(currentKey);
                    setTestFeedback('correct');
                    
                    if (isChallenge) setScore(s => s + 1);
                    if (isWrongSetMode) setWrongWords(prev => prev.filter(w => w !== currentKey));
                    if (!learnedWords.includes(currentKey)) setLearnedWords(prev => [...prev, currentKey]);
                    
                    setTimeout(() => {
                        setTestFeedback(null);
                        if (idx < currentList.length - 1) setIdx(idx + 1);
                        else {
                            if (isChallenge) {
                                const nextWord = fullList[Math.floor(Math.random() * fullList.length)];
                                setCurrentList(prev => [...prev, nextWord]);
                                setIdx(idx + 1);
                            } else { playSound('finish'); setShowGameOver(true); }
                        }
                    }, 800); // ç¨å¾®å»¶é•¿ç­‰å¾…æ—¶é—´ï¼Œè®©å•è¯è¯»å®Œ
                } else {
                    setTestFeedback('wrong');
                    playSound('wrong');
                    if (!wrongWords.includes(currentKey)) setWrongWords(prev => [...prev, currentKey]);
                    if (isChallenge) {
                        setTimeout(() => {
                            if (score > highScore) setHighScore(score);
                            playSound('finish');
                            setShowGameOver(true);
                        }, 600);
                    } else { setTimeout(() => setTestFeedback(null), 600); }
                }
            };

            const startMode = (mode, levelId = '1') => {
                setIsChallenge(false); setIsWrongSetMode(false); setIdx(0); setFlipped(false); setTestFeedback(null);
                playSound('correct');
                // ç§»åŠ¨ç«¯è¯­éŸ³æ¿€æ´»å°æŠ€å·§ï¼šåœ¨ç”¨æˆ·ç‚¹å‡»å¼€å§‹æ—¶ï¼Œå…ˆå°è¯•æ’­æ”¾ä¸€æ®µé™éŸ³
                speak('');
                
                if (mode === 'card') {
                    setCurrentList(Object.keys(dbData[levelId].words).filter(k => !learnedWords.includes(k)));
                    setCurrentLevel(levelId);
                    setView('card');
                } else if (mode === 'test') {
                    setCurrentList(Object.keys(dbData[levelId].words));
                    setCurrentLevel(levelId);
                    setView('test');
                } else if (mode === 'survival') {
                    setIsChallenge(true); setScore(0);
                    setCurrentList([fullList[Math.floor(Math.random() * fullList.length)]]);
                    setView('test');
                } else if (mode === 'wrong') {
                    if (wrongWords.length === 0) return alert('ç›®å‰æ²¡æœ‰é”™é¢˜ï¼');
                    setIsWrongSetMode(true);
                    setCurrentList([...wrongWords].sort(() => Math.random() - 0.5));
                    setView('test');
                }
            };

            if (view === 'menu') {
                return (
                    <div className="max-w-md mx-auto p-6 relative">
                        {showNameModal && (
                            <div className="modal-overlay">
                                <div className="bg-white p-8 rounded-[48px] text-center w-full max-w-[320px] shadow-2xl">
                                    <h2 className="text-2xl font-black mb-6">Hello! Steve?</h2>
                                    <input type="text" value={tempName} onChange={(e) => setTempName(e.target.value)} placeholder="è¾“å…¥åå­—..." className="w-full bg-slate-50 border-2 border-slate-100 rounded-3xl py-4 px-6 mb-6 font-black text-center outline-none focus:border-indigo-200" />
                                    <button onClick={() => { setUserName(tempName); localStorage.setItem('steve_name', tempName); setShowNameModal(false); playSound('correct'); }} className="w-full bg-indigo-600 text-white py-5 rounded-[28px] font-black btn-active">å¼€å§‹å­¦ä¹ </button>
                                </div>
                            </div>
                        )}
                        <header className="flex justify-between items-center mb-8 px-2 pt-4">
                            <div>
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">æ¬¢è¿å›æ¥</p>
                                <h1 className="text-2xl font-black text-slate-800 tracking-tight">
                                    <span className="text-indigo-600">{userName || 'Steve'}'s</span> English Master
                                </h1>
                            </div>
                            <button onClick={resetProgress} className="bg-white border border-slate-100 px-3 py-1 rounded-full text-[10px] font-black text-slate-400 shadow-sm btn-active uppercase">Reset</button>
                        </header>
                        
                        <div className="grid grid-cols-3 gap-3 mb-10">
                            <div className="bg-white p-4 rounded-3xl border border-slate-50 shadow-sm text-center">
                                <p className="text-[10px] font-black text-slate-300 uppercase mb-1">å·²å­¦ä¼š</p>
                                <p className="text-xl font-black text-indigo-600">{learnedWords.length} ğŸ“–</p>
                            </div>
                            <div className="bg-white p-4 rounded-3xl border border-slate-50 shadow-sm text-center">
                                <p className="text-[10px] font-black text-slate-300 uppercase mb-1">æœ€é«˜åˆ†</p>
                                <p className="text-xl font-black text-slate-700">{highScore} ğŸ†</p>
                            </div>
                            <div className="bg-white p-4 rounded-3xl border border-slate-50 shadow-sm text-center">
                                <p className="text-[10px] font-black text-slate-300 uppercase mb-1">æ‰“å¡å¤©æ•°</p>
                                <p className="text-xl font-black text-emerald-500">{streak} ğŸ”¥</p>
                            </div>
                        </div>

                        <div className="space-y-4">
                            {dbData && Object.entries(dbData).map(([id, data]) => {
                                const total = Object.keys(data.words).length;
                                const done = Object.keys(data.words).filter(w => learnedWords.includes(w)).length;
                                return (
                                    <div key={id} className="bg-white p-5 rounded-[36px] border border-slate-50 flex items-center shadow-sm">
                                        <div className="w-14 h-14 bg-indigo-50/50 rounded-2xl flex items-center justify-center text-3xl mr-4">{data.levelEmoji}</div>
                                        <div className="flex-1">
                                            <h3 className="font-black text-slate-700 text-base">{data.levelName}</h3>
                                            <div className="flex items-center gap-3 mt-2">
                                                <div className="flex-1 bg-slate-100 h-2 rounded-full overflow-hidden">
                                                    <div className="bg-indigo-400 h-full transition-all duration-1000" style={{width: `${(done/total)*100}%`}}></div>
                                                </div>
                                                <span className="text-[10px] font-black text-slate-400">{done}/{total}</span>
                                            </div>
                                        </div>
                                        <div className="flex gap-2 ml-4">
                                            <button onClick={() => startMode('card', id)} className="w-11 h-11 bg-indigo-600 text-white rounded-2xl flex items-center justify-center shadow-md btn-active">ğŸ“–</button>
                                            <button onClick={() => startMode('test', id)} className="w-11 h-11 bg-slate-100 text-slate-600 rounded-2xl flex items-center justify-center btn-active">ğŸ•¹ï¸</button>
                                        </div>
                                    </div>
                                );
                            })}
                            <div style={{ height: '220px' }}></div>
                        </div>
                        
                        <nav className="floating-nav flex gap-3 max-w-md mx-auto">
                            <button onClick={() => startMode('survival')} className="flex-1 bg-indigo-50/80 text-indigo-700 h-[64px] rounded-[24px] btn-active flex items-center justify-center gap-2">
                                <div className="w-8 h-8 bg-indigo-600 text-white rounded-xl flex items-center justify-center text-xs shadow-sm">âš¡</div>
                                <div className="text-left"><p className="text-[10px] font-black uppercase opacity-60 leading-none">å…¨é‡æŒ‘æˆ˜</p><p className="text-[13px] font-black leading-none mt-1">ç”Ÿå­˜æ¨¡å¼</p></div>
                            </button>
                            <button onClick={() => startMode('wrong')} className="flex-1 bg-slate-50/80 text-slate-700 h-[64px] rounded-[24px] btn-active flex items-center justify-center gap-2 relative">
                                {wrongWords.length > 0 && <span className="badge">{wrongWords.length}</span>}
                                <div className="w-8 h-8 bg-slate-200 text-slate-600 rounded-xl flex items-center justify-center text-xs">ğŸ“•</div>
                                <div className="text-left"><p className="text-[10px] font-black uppercase opacity-60 leading-none">å·©å›ºç»ƒä¹ </p><p className="text-[13px] font-black leading-none mt-1">æˆ‘çš„é”™é¢˜</p></div>
                            </button>
                        </nav>
                    </div>
                );
            }

            const wordInfo = dbData && currentKey ? (Object.values(dbData).find(l => l.words[currentKey])?.words[currentKey]) : null;

            return (
                <div className="max-w-md mx-auto h-screen flex flex-col p-6 bg-white overflow-hidden">
                    <header className="flex justify-between items-center mb-6">
                        <button onClick={() => setView('menu')} className="bg-slate-50 px-5 py-2.5 rounded-full font-black text-slate-400 text-[11px] uppercase border border-slate-100 btn-active">â† è¿”å›</button>
                        <div className="text-[11px] font-black text-slate-400 uppercase tracking-widest">
                            {isChallenge ? `å¾—åˆ†: ${score}` : (isWrongSetMode ? `é”™é¢˜å¤ä¹ ` : `ç­‰çº§ ${currentLevel}`)} â€¢ {idx + 1}/{currentList.length}
                        </div>
                        <div className="w-12"></div>
                    </header>
                    <div className="flex-1 flex flex-col items-center justify-center">
                        {wordInfo && (
                            view === 'card' ? (
                                <div className="w-full">
                                    <div className={`card-inner ${flipped ? 'flipped' : ''}`} onClick={() => setFlipped(!flipped)}>
                                        <div className="card-face bg-white border-slate-50">
                                            <div className="text-[120px] mb-4 select-none cursor-pointer" onClick={(e) => { e.stopPropagation(); speak(currentKey); }}>{wordInfo[0]}</div>
                                            <div className="text-5xl font-black text-slate-800 uppercase tracking-tighter">{currentKey}</div>
                                            <button onClick={(e) => { e.stopPropagation(); speak(currentKey); }} className="mt-8 w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center text-2xl btn-active border border-slate-100">ğŸ”Š</button>
                                        </div>
                                        <div className="card-face card-back">
                                            <div className="text-4xl font-black mb-2">{wordInfo[1]}</div>
                                            <div className="text-indigo-100 text-sm italic mb-8 opacity-80">{wordInfo[2]}</div>
                                            <div onClick={(e) => { e.stopPropagation(); speak(wordInfo[3]); }} className="bg-white/10 p-6 rounded-[32px] mb-8 italic text-sm leading-relaxed text-center border border-white/10 cursor-pointer hover:bg-white/20 transition-all">
                                                "{wordInfo[3]}"
                                                <div className="mt-2 text-[10px] uppercase font-black tracking-widest opacity-50">ç‚¹å‡»å¬å¥å­ ğŸ”Š</div>
                                            </div>
                                            <button onClick={(e) => { 
                                                e.stopPropagation(); setIsChecking(true); playSound('correct');
                                                setTimeout(() => { 
                                                    setLearnedWords(prev => [...prev, currentKey]); setFlipped(false); setIsChecking(false); 
                                                    if(idx < currentList.length-1) setIdx(idx+1); else { playSound('finish'); setShowGameOver(true); } 
                                                }, 800);
                                            }} className={`mt-8 w-20 h-20 rounded-full border-4 border-white flex items-center justify-center btn-active ${isChecking ? 'bg-emerald-400 border-emerald-400 scale-110' : 'bg-white/20'}`}>
                                                <svg className="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="4" d="M5 13l4 4L19 7"/></svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="w-full px-4">
                                    <div className="text-[120px] text-center mb-16 select-none cursor-pointer" onClick={() => speak(currentKey)}>{wordInfo[0]}</div>
                                    <div className="grid grid-cols-2 gap-4">
                                        {shuffledOptions.map((opt, i) => (
                                            <button key={`${currentKey}-${opt}-${i}`} onClick={() => handleChoice(opt)}
                                                className={`p-6 rounded-[32px] font-black text-lg border-b-[6px] transition-all btn-active ${
                                                    testFeedback === 'correct' && opt === currentKey ? 'bg-emerald-500 text-white border-emerald-700' :
                                                    testFeedback === 'wrong' && opt !== currentKey ? 'bg-rose-50 text-rose-300 border-rose-100' : 
                                                    (testFeedback === 'wrong' && opt === currentKey ? 'bg-emerald-100 text-emerald-500 border-emerald-200' : 'bg-white text-slate-600 border-slate-100 shadow-sm')
                                                }`}
                                            >{opt}</button>
                                        ))}
                                    </div>
                                </div>
                            )
                        )}
                    </div>
                    {showGameOver && (
                        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-[200] p-6">
                            <div className="bg-white p-10 rounded-[56px] text-center w-full max-w-sm shadow-2xl animate-in zoom-in duration-300">
                                <div className="text-8xl mb-6">{score > highScore ? "ğŸ‘‘" : "ğŸ‰"}</div>
                                <h2 className="text-2xl font-black mb-2">å¤ªæ£’äº†!</h2>
                                <div className="text-4xl font-black text-indigo-600 mb-8">{isChallenge ? `æœ€ç»ˆå¾—åˆ†: ${score}` : (isWrongSetMode ? "é”™é¢˜å…¨å¯¹å•¦!" : "è¿‡å…³å•¦!")}</div>
                                <button onClick={() => { setShowGameOver(false); setView('menu'); }} className="w-full bg-slate-900 text-white py-5 rounded-[28px] font-black btn-active shadow-xl">å›åˆ°é¦–é¡µ</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
