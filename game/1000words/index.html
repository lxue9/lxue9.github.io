<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta property="og:image" content="https://www.stevesplayground.online/game/1000words_logo.png" />
    <meta property="og:title" content="Welcome to Steve's playgroundï¼" />
    <meta property="og:description" content="A game site developed by Steve and his mom." />
    <meta property="og:url" content="https://www.stevesplayground.online/game/1000words/" />
    <meta property="og:type" content="website" />

    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <title>English Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://fastly.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/@babel/standalone@7.23.10/babel.min.js"></script>


    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script src="./vocabulary.js"></script>
    <style>

/* æ•´ä¸ªé¡µé¢çš„å¤§å®¹å™¨ */
.app-container {
    display: flex;
    flex-direction: column;
    height: 100vh; /* æ’‘æ»¡å±å¹•é«˜åº¦ */
    overflow: hidden; /* é˜²æ­¢å¤–å±‚æ•´ä½“æ»šåŠ¨ */
}

/* èœå•æ å®¹å™¨ï¼ˆæ’è¡Œæ¦œã€å·²å­¦ä¼šç­‰ï¼‰ */
.menu-header {
    flex-shrink: 0; /* ç¦æ­¢ç¼©æ”¾ï¼Œç¡®ä¿é«˜åº¦å›ºå®š */
    position: sticky;
    top: 0;
    z-index: 50; /* ç¡®ä¿åœ¨åˆ—è¡¨ä¹‹ä¸Š */
    background: white; /* å¿…é¡»è®¾ç½®èƒŒæ™¯è‰²ï¼Œå¦åˆ™æ»šåŠ¨æ—¶ä¼šé€è¿‡å» */
}

/* ä¸‹æ–¹çš„å…³å¡åˆ—è¡¨åŒºåŸŸ */
.scroll-content {
    flex-grow: 1; /* å æ®å‰©ä½™æ‰€æœ‰ç©ºé—´ */
    overflow-y: auto; /* å¼€å¯å‚ç›´æ–¹å‘æ»šåŠ¨ */
    padding-bottom: 20px; /* ç•™ç‚¹åº•éƒ¨ç©ºéš™ */
    -webkit-overflow-scrolling: touch; /* ä¼˜åŒ–æ‰‹æœºç«¯æ»šåŠ¨æ‰‹æ„Ÿ */
}


    /* æ­¥éª¤åˆ‡æ¢æ—¶çš„è¿›åœºåŠ¨ç”» */
    @keyframes slide-up-fade {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .step-anim {
      animation: slide-up-fade 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    }

    /* æ¨¡æ‹Ÿæ‰‹æŒ‡ç‚¹å‡»åŠ¨ä½œ */
    @keyframes hand-tap-simple {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(0.9) translateY(5px); }
    }

    .hand-simple {
      font-size: 50px;
      position: absolute;
      z-index: 50;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
      animation: hand-tap-simple 1.5s infinite ease-in-out;
    }

    /* è¿›åº¦æ¡åŠ¨ç”» */
   .progress-fill {
      transition: width 0.5s ease-out;
    }

    /* æ˜Ÿæ˜Ÿç‚¹äº®æ—¶çš„å‘¼å¸ç¯æ•ˆæœ */
    @keyframes star-glow {
     0%, 100% { filter: drop-shadow(0 0 2px rgba(251,191,36,0.4)); }
      50% { filter: drop-shadow(0 0 10px rgba(251,191,36,0.7)); }
    }

    .star-active {
      animation: star-glow 2s infinite ease-in-out;
    }

    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');
    body { 
            font-family: 'Nunito', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background: #fcfcfd; color: #1e293b; margin: 0; padding: 0;
            overflow-x: hidden; touch-action: pan-y;
        }
        
        /* 1. æµ®å‹• Emoji å‹•ç•« */
        @keyframes emoji-jump { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-50px); } }
        .floating-emoji { display: inline-block; animation: emoji-jump 0.5s ease-in-out infinite; }

        /* 2. é»ƒé‡‘é›¨ç‰¹æ•ˆèƒŒæ™¯ */
        .gold-glow { box-shadow: 0 0 50px rgba(255, 215, 0, 0.4); border: 4px solid #FFD700 !important; }

        .floating-nav { 
            position: fixed; bottom: 24px; left: 20px; right: 20px; 
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 32px; 
            z-index: 100; padding: 12px; box-shadow: 0 15px 35px -5px rgba(0,0,0,0.1);
        }
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 500; padding: 20px; }
        .card-inner { transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); transform-style: preserve-3d; height: 420px; width: 100%; max-width: 340px; margin: 0 auto; position: relative; }
        .flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 48px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.04); border: 10px solid white; }
        .card-back { background: #6366F1; color: white; transform: rotateY(180deg); }
        .btn-active { transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .btn-active:active { transform: scale(0.95); opacity: 0.8; }
        .badge { position: absolute; top: -6px; right: -6px; background: #fb7185; color: white; font-size: 10px; font-weight: 900; padding: 2px 8px; border-radius: 10px; border: 2px solid white; }
        .swipe-hint { position: absolute; bottom: -40px; font-size: 12px; font-weight: 900; color: #cbd5e1; display: flex; gap: 20px; }

		@keyframes slow-float {
 		 0%, 100% { transform: translateY(0); }
  		50% { transform: translateY(-5px); } /* å‘ä¸Šæ¼‚æµ® 5px */
		}

		.animate-float {
 			 animation: slow-float 3s ease-in-out infinite;
  			display: inline-flex; /* ç¡®ä¿åŠ¨ç”»åº”ç”¨åœ¨è¡Œå†…å—ä¸Š */
		}
		
    </style>
</head>

<body>
   
<div id="root">
    <div style="display:flex; justify-content:center; align-items:center; height:100vh; background:#f8fafc; font-family:sans-serif; color:#6366f1;">
        <div style="text-align:center;">
            <div style="border:4px solid #e0e7ff; border-top:4px solid #6366f1; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:0 auto 16px;"></div>
            <p style="font-weight:bold; font-size:14px;">å‡†å¤‡å•è¯å†’é™©ä¸­...</p>
        </div>
    </div>
</div>

<style>
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>

<script type="text/babel">
  const { useState, useEffect, useMemo, useRef } = React;
	const AVATAR_OPTIONS = ['ğŸ‘¦','ğŸ‘§','ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸ¦„', 'ğŸ²'];
	const BOT_NAMES = [
  	  "å¿«ä¹å°è™", "å•è¯è¶…äºº", "é—ªç”µå…”", "å­¦ä¹ ä¹‹æ˜Ÿ", 
   	 "æ™ºæ…§å°å®", "å†²åˆºé˜Ÿé•¿", "æ»¡åˆ†å–µå–µ", "å½©è™¹å°é©¬",
    	"å¥¥ç‰¹æ›¼", "è‰¾èå…¬ä¸»", "è¶…çº§é£ä¾ ", "æ±ªæ±ªé˜Ÿ"
	    ];
  
  const MISSION_REWARDS = {
    1: ["ğŸŒ±", "ğŸŒ¿", "â˜˜ï¸", "ğŸ€", "ğŸŒ³"],  // Level 1: æ¤ç‰©æˆé•¿
    2: ["ğŸ£", "ğŸ¥", "ğŸ¤", "ğŸ¦", "ğŸ¦…"],  // Level 2: é¸Ÿç±»è¿›åŒ–
    3: ["ğŸ’§", "ğŸŒŠ", "ğŸ§Š", "â„ï¸", "ğŸ”ï¸"],  // Level 3: æ°´ä¹‹å½¢æ€
    4: ["ğŸ•¯ï¸", "ğŸ”¦", "ğŸ’¡", "â˜€ï¸", "ğŸ”¥"],  // Level 4: å…‰æ˜ä¹‹æº
    5: ["ğŸš—", "ğŸï¸", "ğŸš„", "âœˆï¸", "ğŸš€"],  // Level 5: é€Ÿåº¦é£è·ƒ
    6: ["ğŸ¥‰", "ğŸ¥ˆ", "ğŸ¥‡", "ğŸ†", "ğŸ‘‘"],  // Level 6: è£èª‰é˜¶æ¢¯
    7: ["ğŸš²", "ğŸ›µ", "ğŸï¸", "ğŸï¸", "ğŸ›¸"],  // Level 7: æœªæ¥äº¤é€š
    8: ["â˜ï¸", "ğŸŒ¤ï¸", "â˜€ï¸", "ğŸŒˆ", "ğŸª"],  // Level 8: å¤©ç©ºæ¢ç´¢
    9: ["ğŸ¥Š", "ğŸ¥‹", "ğŸ¤º", "ğŸ¤º", "âš”ï¸"],  // Level 9: å‹‡è€…ä¹‹è·¯
    10: ["ğŸ¹", "ğŸ›¡ï¸", "âš”ï¸", "ğŸ’", "ğŸ”±"]  // Level 10: æœ€ç»ˆç¥è¯
};
  

   // ç”Ÿæˆ 100-200 ä¹‹é—´çš„éšæœºæ•´æ•°
   const getRandomScore = () => Math.floor(Math.random() * (200 - 100 + 1)) + 100;
   // éšæœºè·å–ä¸€ä¸ªæ•°ç»„å…ƒç´ 
   const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];

  // ==========================================
// é¼“åŠ±è¯­çŸ©é˜µ (50å¥)
// ==========================================
const MOTIVATIONAL_QUOTES = [
    // --- åŸºç¡€é¼“åŠ± (1-10) ---
    "Great start! ä¸€å°æ­¥ä¹Ÿæ˜¯è¿›æ­¥ï¼",
    "Keep going! ç»§ç»­åŠ æ²¹ï¼",
    "You are amazing! ä½ å¤ªæ£’äº†ï¼",
    "Wow! So smart! å“‡ï¼çœŸèªæ˜ï¼",
    "Awesome! å¤ªå‰å®³äº†ï¼",
    "You're on fire! ä½ ç°åœ¨åŠ¿ä¸å¯æŒ¡ï¼",
    "Fantastic! å¤ªå‡ºè‰²äº†ï¼",
    "Good job! åšå¾—å¥½ï¼",
    "Brilliant! å¾ˆæœ‰æ‰åï¼",
    "Keep it up! åšæŒä¸‹å»ï¼",

    // --- è¿›é˜¶é¼“åŠ± (11-20) ---
    "Unstoppable! è°ä¹ŸæŒ¡ä¸ä½ä½ ï¼",
    "Superb work! æå¥½çš„è¡¨ç°ï¼",
    "You're a natural! ä½ å¾ˆæœ‰å¤©èµ‹ï¼",
    "Outstanding! è¡¨ç°ä¼˜å¼‚ï¼",
    "Perfect score! æ»¡åˆ†è¡¨ç°ï¼",
    "Incredible progress! æƒŠäººçš„è¿›æ­¥ï¼",
    "You make it look easy! ä½ è®©å­¦ä¹ å˜å¾—å¥½ç®€å•ï¼",
    "Top notch! é¡¶å°–æ°´å¹³ï¼",
    "Victory is yours! èƒœåˆ©å±äºä½ ï¼",
    "Keep shining! ç»§ç»­é—ªè€€ï¼",

    // --- æŒ‘æˆ˜é¼“åŠ± (21-30) ---
    "Challenge accepted! æŒ‘æˆ˜æˆåŠŸï¼",
    "Way to go! å°±è¯¥è¿™ä¹ˆåšï¼",
    "Impressive! ä»¤äººå°è±¡æ·±åˆ»ï¼",
    "Knowledge is power! çŸ¥è¯†å°±æ˜¯åŠ›é‡ï¼",
    "Believe in yourself! ç›¸ä¿¡ä½ è‡ªå·±ï¼",
    "Hard work pays off! åŠªåŠ›ç»ˆæœ‰å›æŠ¥ï¼",
    "You're a superstar! ä½ æ˜¯ä¸ªå·¨æ˜Ÿï¼",
    "Never give up! æ°¸ä¸è¨€å¼ƒï¼",
    "Dream big! å¿—å­˜é«˜è¿œï¼",
    "Stay curious! ä¿æŒå¥½å¥‡å¿ƒï¼",

    // --- è¿›é˜¶æ™ºæ…§ (31-40) ---
    "Excellence is a habit! ä¼˜ç§€æ˜¯ä¸€ç§ä¹ æƒ¯ï¼",
    "Focus and win! ä¸“æ³¨å°±èƒ½èµ¢ï¼",
    "You're getting better! ä½ è¶Šæ¥è¶Šæ£’äº†ï¼",
    "Amazing effort! äº†ä¸èµ·çš„åŠªåŠ›ï¼",
    "High five! å‡»ä¸ªæŒå§ï¼",
    "You're the best! ä½ æ˜¯æœ€æ£’çš„ï¼",
    "Smart move! èªæ˜çš„é€‰æ‹©ï¼",
    "Genius at work! å¤©æ‰æ­£åœ¨åŠªåŠ›ï¼",
    "Bravo! å–å½©ï¼",
    "Pure gold! çº¯é‡‘èˆ¬çš„è¡¨ç°ï¼",

    // --- ç»ˆæå·…å³° (41-50) ---
    "Master status! å¤§å¸ˆçº§åˆ«ï¼",
    "Simply the best! ç®€ç›´æ˜¯æœ€å¥½çš„ï¼",
    "Legendary! ä¼ å¥‡èˆ¬çš„è¡¨ç°ï¼",
    "Beyond compare! æ— ä¸ä¼¦æ¯”ï¼",
    "The sky is the limit! æ½œåŠ›æ— é™ï¼",
    "You've got the power! ä½ å……æ»¡åŠ›é‡ï¼",
    "World class! ä¸–ç•Œçº§çš„è¡¨ç°ï¼",
    "Peak performance! å·…å³°çŠ¶æ€ï¼",
    "Simply wonderful! ç®€ç›´å¤ªç²¾å½©äº†ï¼",
    "The world is yours! ä¸–ç•Œå±äºä½ ï¼"
];


  // ... ä½ çš„ firebaseConfig åˆå§‹åŒ– ...
  // å¾ Firebase æ§åˆ¶å°è¤‡è£½ä½ çš„é…ç½®
  const firebaseConfig = {
    apiKey: "AIzaSyAiQ334fR19FoxA2y_BXhjA-33j3tW3svo",
    authDomain: "words-dddcd.firebaseapp.com",
    databaseURL: "https://words-dddcd-default-rtdb.firebaseio.com",
    projectId: "words-dddcd",
    storageBucket: "words-dddcd.firebasestorage.app",
    messagingSenderId: "78083720510",
    appId: "1:78083720510:web:2cd8ee255246cea774586f",
    measurementId: "G-L1MCW0108M"
  };
  
  // åˆå§‹åŒ– Firebase
  if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
  const auth = firebase.auth();
  const database = firebase.database();
  const syncToCloud = (name, count, avatar) => {
    // ç§»é™¤ !user é™åˆ¶ï¼Œå…è®¸åŒ¿åå†™å…¥ï¼ˆç¡®ä¿ Firebase Rules å·²å¼€å¯ read/write: trueï¼‰
    if (!name || name === 'Steve' || count === 0) return; 

    // ä½¿ç”¨åå­—ä½œä¸º Keyï¼Œè¿™æ ·åœ¨æ’è¡Œæ¦œé‡ŒåŒ¹é…æœ€ç¨³
    const userRef = firebase.database().ref('leaderboard/' + name);
    
    userRef.update({
        name: name,
        score: count,
        avatar: avatar || 'ğŸ§‘â€ğŸš€',
        lastUpdate: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
        console.log("â˜ï¸ Cloud Sync Success:", name, count);
    }).catch(err => {
        console.error("â˜ï¸ Cloud Sync Error:", err);
    });
};


const Leaderboard = (props) => {
    // --- çŠ¶æ€å®šä¹‰ ---
    const [realPlayerCount, setRealPlayerCount] = React.useState(0);
    const [displayList, setDisplayList] = React.useState([]);
    const [loading, setLoading] = React.useState(true); 
    const [totalParticipants, setTotalParticipants] = React.useState(0); // æ–°å¢ï¼šç”¨äºæ˜¾ç¤ºåˆç†çš„æ€»äººæ•°

    const learnedWords = props.learnedWords || window.learnedWords || [];

    // --- æ ¸å¿ƒä¿®å¤ 1: ç¡®ä¿æ’åè®¡ç®—å¼•ç”¨å…¨é‡æ•°æ® ---
    const myRankNumber = React.useMemo(() => {
        if (loading) return "--"; 
        
        const fullData = window.globalLeaderboardData || [];
        const myLocalName = (localStorage.getItem('steve_name') || 'Steve').trim();
        
        // åœ¨å…¨é‡æ•°æ®ä¸­æŸ¥æ‰¾è‡ªå·±çš„çœŸå®ä½ç½®
        const index = fullData.findIndex(p => 
            (p.name && p.name.trim() === myLocalName) || p.isMe === true
        );
        
        return index !== -1 ? (index + 1) : "--";
    }, [loading, displayList]); // ä¾èµ– displayList æ›´æ–°è§¦å‘é‡ç®—

    React.useEffect(() => {
        window.learnedWords = learnedWords;
    }, [learnedWords]);

    React.useEffect(() => {
        const rankRef = firebase.database().ref('leaderboard'); 
        const listener = rankRef.on('value', (snapshot) => {
            let realData = [];
            if (snapshot.exists()) {
                setRealPlayerCount(snapshot.numChildren());
                snapshot.forEach((child) => {
                    realData.push({ id: child.key, ...child.val() });
                });
            } else {
                setRealPlayerCount(0);
            }

            // --- è™šæ‹Ÿæ•°æ®ç®—æ³• ---
            const getDailyGrowth = () => {
                const today = new Date();
                return (today.getFullYear() - 2024) * 365 + today.getMonth() * 30 + today.getDate();
            };

            let finalData = [...realData];
            const myScore = learnedWords.length;
            const myLocalName = (localStorage.getItem('steve_name') || 'Steve').trim();

            // ç”Ÿæˆ 15 ä¸ªè™šæ‹Ÿæœºå™¨äºº
            if (finalData.length < 15) { 
                const needed = 15 - finalData.length; // ç¡®ä¿è‡³å°‘å¡«æ»¡15äºº
                const existingNames = new Set(finalData.map(p => p.name));
                const availableNames = BOT_NAMES.filter(name => !existingNames.has(name));

                for (let i = 0; i < 15; i++) { // å›ºå®šç”Ÿæˆ15ä¸ªæœºå™¨äººä½œä¸ºåŸºåº•
                    const botName = availableNames[i] || `Student_${i + 1}`;
                    const baseOffset = 15 - (i * 3); 
                    const growth = getDailyGrowth();
                    
                    // æœºå™¨äººé€»è¾‘ï¼šå³ä½¿ä½ 0åˆ†ï¼Œæœºå™¨äººä¹Ÿæ˜¯10åˆ†èµ·æ­¥ï¼Œæ‰€ä»¥ä½ ä¼šæ’åœ¨å®ƒä»¬åé¢
                    finalData.push({
                        id: `fixed_bot_${i}`, 
                        name: botName,
                        avatar: AVATAR_OPTIONS[i % AVATAR_OPTIONS.length],
                        score: Math.max(10, myScore + baseOffset + (growth % 5)), 
                        isBot: true
                    });
                }
            }

            // ç¡®ä¿â€œæˆ‘â€çš„æ•°æ®æ›´æ–°
            const meIdx = finalData.findIndex(p => p.name === myLocalName);
            if (meIdx !== -1) {
                finalData[meIdx].score = myScore;
                finalData[meIdx].isMe = true;
            } else {
                finalData.push({ id: 'me_local', name: myLocalName, score: myScore, isMe: true, avatar: 'ğŸ˜' });
            }

            // æ’åºï¼šåˆ†æ•°é«˜åˆ°ä½
            finalData.sort((a, b) => b.score - a.score);

            // æ›´æ–°å…¨å±€æ•°æ®ä¾› Menu ä½¿ç”¨
            window.globalLeaderboardData = finalData;
            
            // --- æ ¸å¿ƒä¿®å¤ 2: æˆªå–é€»è¾‘ä¼˜åŒ– ---
            const myFinalRank = finalData.findIndex(p => p.isMe === true);
            let displayResult = finalData.slice(0, 10); // å–å‰10å
            
            // å¦‚æœæˆ‘åœ¨10åå¼€å¤–ï¼ŒæŠŠæˆ‘è¿½åŠ åˆ°åˆ—è¡¨æœ«å°¾
            if (myFinalRank >= 10) {
                displayResult.push(finalData[myFinalRank]);
            }

            setDisplayList(displayResult);
            // è®¾ç½®åˆç†çš„æ€»äººæ•°ï¼šçœŸå®ç©å®¶ + æœºå™¨äºº
            setTotalParticipants(finalData.length);
            setLoading(false); 
        });

        return () => rankRef.off('value', listener);
    }, [learnedWords.length]); // ä¾èµ– learnedWords è§¦å‘åˆ·æ–°

    // åŒæ­¥äº‘ç«¯
    const myName = localStorage.getItem('steve_name') || 'Steve';
    const myAvatar = window.userAvatar || 'ğŸ˜';
    syncToCloud(myName, learnedWords.length, myAvatar);
   
    return (
        <div className="bg-white/90 backdrop-blur-sm p-5 rounded-[36px] border-4 border-indigo-50 shadow-xl w-full">
            <div className="flex flex-col items-center justify-center mb-5">
                <div className="flex items-center gap-2">
                    <span className="text-2xl animate-bounce">ğŸ†</span>
                    <h3 className="font-black text-indigo-600 text-lg tracking-wider">å­¦éœ¸æ’è¡Œæ¦œ</h3>
                </div>
                {/* --- æ ¸å¿ƒä¿®å¤ 3: æ˜¾ç¤ºåˆç†çš„é€»è¾‘äººæ•° (çœŸå®+æœºå™¨äºº) --- */}
                <p className="text-xs font-bold text-slate-400 mt-1">
                    å·²æœ‰ <span className="text-indigo-500 text-sm">{loading ? "--" : totalParticipants}</span> ä½å°æœ‹å‹åŠ å…¥æŒ‘æˆ˜
                </p>
            </div>
            
            <div className="space-y-3">
            {loading ? (
                <div className="text-center text-slate-400 py-4 font-bold">åŠ è½½æ’è¡Œæ¦œä¸­...</div>
            ) : (
                displayList.map((player, index) => {
                    const myLocalName = (localStorage.getItem('steve_name') || 'Steve').trim();
                    const isMe = (player.name && player.name.trim() === myLocalName) || player.id === myLocalName || player.isMe;
                    
                    // --- æ ¸å¿ƒä¿®å¤ 4: æ’åæ˜¾ç¤ºé€»è¾‘ ---
                    // å¦‚æœæ˜¯"æˆ‘"ï¼Œç›´æ¥ä½¿ç”¨è®¡ç®—å‡ºçš„çœŸå®æ’å(myRankNumber)
                    // å¦‚æœæ˜¯åˆ«äºº(å¿…ç„¶åœ¨Top10åˆ—è¡¨é‡Œ)ï¼Œç›´æ¥ç”¨ index+1
                    const rank = isMe ? myRankNumber : (index + 1);

                    const getRankStyle = () => {
                        if (rank === 1) return 'bg-amber-50 border-amber-200 shadow-amber-100';
                        if (rank === 2) return 'bg-rose-50 border-rose-200 shadow-rose-100';
                        if (rank === 3) return 'bg-emerald-50 border-emerald-200 shadow-orange-100';
                        return isMe ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-100';
                    };

                    return (
                        <div 
                            key={player.id || `rank-${index}`} 
                            className={`flex items-center gap-4 p-4 rounded-[24px] transition-all mb-3 border-2
                                ${getRankStyle()} 
                                ${isMe ? 'ring-2 ring-indigo-500 ring-offset-2 scale-[1.02] z-10' : ''}
                            `}
                        >
                            {/* æ’åå›¾æ ‡ */}
                            <div className="w-8 h-8 flex items-center justify-center">
                                {rank === 1 ? <span className="text-3xl drop-shadow-sm">ğŸ¥‡</span> : 
                                 rank === 2 ? <span className="text-3xl drop-shadow-sm">ğŸ¥ˆ</span> : 
                                 rank === 3 ? <span className="text-3xl drop-shadow-sm">ğŸ¥‰</span> : 
                                 <span className="font-black text-slate-400 italic">#{rank}</span>}
                            </div>

                            {/* å¤´åƒ */}
                            <div className={`w-12 h-12 rounded-2xl flex items-center justify-center text-2xl shadow-sm
                                ${rank === 1 ? 'bg-amber-400 text-white' : 
                                  rank === 2 ? 'bg-rose-300 text-white' : 
                                  rank === 3 ? 'bg-emerald-400 text-white' : 'bg-slate-100'}`}>
                                {player.avatar || 'ğŸ‘¤'}
                            </div>

                            {/* åå­— */}
                            <div className="flex-1">
                                <div className="flex items-center gap-2">
                                    <span className={`font-black ${rank <= 3 ? 'text-slate-900' : 'text-slate-700'}`}>
                                        {player.name}
                                    </span>
                                    {isMe && (
                                        <span className="bg-indigo-600 text-white text-[9px] px-1.5 py-0.5 rounded-md font-black">
                                            YOU
                                        </span>
                                    )}
                                </div>
                                {rank <= 3 && (
                                    <span className="text-[10px] font-bold text-amber-600/70 uppercase tracking-widest block">
                                        {rank === 1 ? 'Top Performer' : rank === 2 ? 'Elite Student' : 'Rising Star'}
                                    </span>
                                )}
                            </div>

                            {/* å•è¯æ•° */}
                            <div className="text-right">
                                <p className="font-black text-base text-slate-900 leading-none">
                                    {player.score}
                                </p>
                                <p className="text-[9px] font-bold text-slate-400 uppercase mt-1">
                                    Words
                                </p>
                            </div>
                        </div>
                    );
                })
            )}
            </div>
        </div>
    );
};        // å…¨å±€å™´æ³‰/é»ƒé‡‘é›¨å‡½æ•¸
        window.fireSuccessConfetti = (isGoldRain = false) => {
            if (typeof confetti !== 'function') return;
            const duration = isGoldRain ? 10 * 1000 : 2.5 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1000 };
            const randomInRange = (min, max) => Math.random() * (max - min) + min;

            const interval = setInterval(() => {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);
                const particleCount = isGoldRain ? 100 : 50;
                const colors = isGoldRain ? ['#FFD700', '#FFA500', '#FF8C00', '#FAE64D'] : undefined;
                confetti({ ...defaults, particleCount, colors, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
                confetti({ ...defaults, particleCount, colors, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
            }, 250);
        };


const TutorialLoader = ({ onFinish }) => {
    const [step, setStep] = React.useState(0);
    const [subState, setSubState] = React.useState(0);

    React.useEffect(() => {
        let stepTimer, subTimer1, subTimer2, scrollTimer;

        if (step === 0) {
            // Step 1: Learn - é¡ºåºï¼šApple -> è‹¹æœ -> âœ…
            setSubState(0);
            subTimer1 = setTimeout(() => setSubState(1), 1500); 
            subTimer2 = setTimeout(() => setSubState(2), 1500); 
            stepTimer = setTimeout(() => { setStep(1); setSubState(0); }, 3000);
        } else if (step === 1) {
            // Step 2: Play
            subTimer1 = setTimeout(() => setSubState(1), 1000);
            stepTimer = setTimeout(() => { setStep(2); setSubState(0); }, 2000);
        } else if (step === 2) {
            // Step 3: Explore - å¿«é€Ÿæ»šåŠ¨
            let count = 0;
            scrollTimer = setInterval(() => {
                count = (count + 1) % 4;
                setSubState(count);
            }, 800);
            stepTimer = setTimeout(() => { setStep(3); setSubState(0); }, 2000);
        } else {
            // Step 4: Finish
            if (window.fireSuccessConfetti) window.fireSuccessConfetti(false);
            stepTimer = setTimeout(onFinish, 3500);
        }

        return () => {
            clearTimeout(stepTimer);
            clearTimeout(subTimer1);
            clearTimeout(subTimer2);
            clearInterval(scrollTimer);
        };
    }, [step]);

    const steps = [
        { title: "Learn", color: "text-emerald-500", bg: "bg-emerald-50", icon: "ğŸ“–", btnColor: "bg-emerald-100", desc: "è®¤è¯†æ–°æœ‹å‹",subDesc: "æ­£é¢å¬å•è¯è¯»éŸ³ï¼Œåé¢çœ‹ä¸­æ–‡è§£é‡Š" },
        { title: "Play", color: "text-indigo-600", bg: "bg-indigo-50", icon: "ğŸ•¹ï¸", btnColor: "bg-indigo-100", desc: "çŒœçŒœæˆ‘æ˜¯è°",subDesc: "å¤ä¹ å·²æŒæ¡çš„å•è¯" },
        { title: "Explore", color: "text-amber-500", bg: "bg-amber-50", icon: "âš¡", btnColor: "bg-amber-100", desc: "æŒ‘æˆ˜è¯æ±‡é‡ï¼",subDesc: "è¯æ±‡é‡æµ‹è¯•" },
        { title: "Let's Go!", color: "text-rose-500", bg: "bg-white", icon: "ğŸ‰", btnColor: "bg-rose-100", desc: "å‡†å¤‡å¥½äº†å—ï¼Ÿ" }
    ];

    const current = steps[step];

    return (
        <div className={`fixed inset-0 z-[1000] flex flex-col items-center justify-center p-6 transition-colors duration-700 ${current.bg}`}>
            <div className="text-center mb-8">
                <h1 className={`text-5xl font-black ${current.color} mb-2`}>{current.title}</h1>
                <p className="text-slate-500 font-bold text-lg">{current.desc}</p>
            </div>

            <div className="relative w-full max-w-[320px] h-[440px] bg-white rounded-[40px] shadow-2xl border-4 border-white overflow-hidden flex flex-col">
                {step === 3 ? (
                    <div className="w-full h-full flex flex-col items-center justify-center p-6">
                        <div className="w-44 h-44 bg-slate-50 rounded-full shadow-inner flex items-center justify-center mb-8 overflow-hidden border-4 border-indigo-50">
                            <img src="https://www.stevesplayground.online/game/1000words/logo/small_steve.png" className="w-full h-full object-contain" 
                                 onError={(e) => { e.target.style.display='none'; e.target.parentNode.innerHTML='<span style="font-size:70px">ğŸš€</span>'; }} />
                        </div>
                        <div className="flex gap-4 mb-10 font-black text-lg">
                            <span className="text-emerald-500">Learn</span>
                            <span className="text-amber-500">Play</span>
                            <span className="text-indigo-600">Explore</span>
                            <span className="text-rose-500">Fun</span>
                        </div>
                        <button onClick={onFinish} className="bg-indigo-600 text-white text-2xl font-black px-12 py-4 rounded-full shadow-xl animate-bounce">GO!</button>
                    </div>
                ) : (
                    <>
                        <div className={`h-[140px] ${current.btnColor} flex items-center justify-center relative border-b-4 border-white`}>
                            <div className="w-20 h-20 bg-white rounded-[24px] shadow-sm flex items-center justify-center text-4xl relative">
                                {current.icon}
                                {((step !== 2 && subState === 0) || (step === 2)) && <div className="hand-simple top-10 left-10">ğŸ‘†</div>}
                            </div>
                        </div>
                        <div className="flex-1 relative flex items-center justify-center bg-slate-50 p-6">
                            {step === 0 && (
                                <div className={`relative w-48 h-64 rounded-[32px] shadow-lg border-2 flex flex-col items-center justify-center transition-all duration-700 ${subState >= 1 ? 'bg-indigo-600 border-indigo-500' : 'bg-white border-slate-100'}`}>
                                    <div className={`absolute inset-0 flex flex-col items-center justify-center transition-all duration-500 ${subState >= 1 ? 'opacity-0 scale-75' : 'opacity-100 scale-100'}`}>
                                        <div className="text-7xl mb-4 animate-float">ğŸ</div>
                                        <div className="text-3xl font-black text-slate-800">Apple</div>
                                    </div>
                                    <div className={`absolute inset-0 flex flex-col items-center justify-center text-white transition-all duration-500 ${subState >= 1 ? 'opacity-100 scale-100' : 'opacity-0 scale-90'}`}>
                                        <div className="text-5xl font-black mb-6">è‹¹æœ</div>
                                        <div className={`w-14 h-14 bg-emerald-400 rounded-full flex items-center justify-center text-3xl shadow-lg border-4 border-white transition-all duration-500 ${subState === 2 ? 'scale-100 opacity-100' : 'scale-0 opacity-0'}`}>âœ…</div>
                                    </div>
                                    {subState === 2 && <div className="hand-simple bottom-4 right-4 animate-bounce">ğŸ‘†</div>}
                                </div>
                            )}
                            {step === 1 && (
                                <div className="w-full">
                                    <div className="flex justify-center mb-4 text-6xl animate-bounce">ğŸ˜</div>
                                    <div className="grid grid-cols-2 gap-3">
                                        {['Cat', 'Elephant', 'Dog', 'Ant'].map((opt, i) => (
                                            <div key={i} className={`h-10 rounded-xl flex items-center justify-center text-xs font-black border-2 transition-colors ${opt === 'Elephant' && subState === 1 ? 'bg-emerald-400 text-white border-emerald-400' : 'bg-white text-slate-400 border-slate-200'}`}>{opt}</div>
                                        ))}
                                    </div>
                                    {subState === 1 && <div className="hand-simple top-20 right-10">ğŸ‘†</div>}
                                </div>
                            )}
                           
{/* --- Step 3: Explore æ»šåŠ¨æ¼”ç¤º --- */}
                            {step === 2 && (
                                <div className="flex flex-col items-center w-full">
                                    <div className="w-full h-40 bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center relative overflow-hidden">
                                        
                                        {/* 1. Emoji æ»šåŠ¨å±‚ */}
                                        <div className="h-20 flex items-center justify-center w-full relative">
                                            {['ğŸ¦', 'ğŸ¯', 'ğŸ’', 'ğŸ¼'].map((emoji, i) => (
                                                <span key={i} className={`absolute text-6xl transition-all duration-500 ease-in-out ${
                                                    subState === i ? 'translate-x-0 opacity-100' : 
                                                    subState > i ? 'translate-x-[-150%] opacity-0' : 'translate-x-[150%] opacity-0'
                                                }`}>
                                                    {emoji}
                                                </span>
                                            ))}
                                        </div>

                                        {/* 2. è‹±æ–‡å•è¯æ»šåŠ¨å±‚ */}
                                        <div className="h-10 flex items-center justify-center w-full relative">
                                            {['lion', 'tiger', 'monkey', 'panda'].map((word, i) => (
                                                <span key={i} className={`absolute text-xl font-black uppercase tracking-widest text-indigo-500 transition-all duration-500 ease-in-out ${
                                                    subState === i ? 'translate-x-0 opacity-100' : 
                                                    subState > i ? 'translate-x-[-150%] opacity-0' : 'translate-x-[150%] opacity-0'
                                                }`}>
                                                    {word}
                                                </span>
                                            ))}
                                        </div>

                                        {/* è¿›åº¦å°ç‚¹ */}
                                        <div className="absolute bottom-3 flex gap-1.5">
                                            {[0, 1, 2, 3].map(i => (
                                                <div key={i} className={`h-1.5 rounded-full transition-all duration-300 ${subState === i ? 'w-4 bg-indigo-400' : 'w-1.5 bg-slate-200'}`} />
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </>
                )}
            </div>

            {/* åº•éƒ¨æ­¥éª¤è¿›åº¦æ¡ */}
            <div className="mt-10 flex gap-2">
                {[0, 1, 2, 3].map(i => (
                    <div key={i} className={`h-2 rounded-full transition-all duration-500 ${step === i ? 'w-8 ' + current.color.replace('text', 'bg') : 'w-2 bg-slate-200'}`}></div>
                ))}
            </div>
        </div>
    );
};	

const App = () => {


   const [view, setView] = React.useState('menu');
   const [showVoiceMenu, setShowVoiceMenu] = React.useState(false);
   const [voicePreference, setVoicePreference] = React.useState('us-female');
   const [showLeaderboard, setShowLeaderboard] = useState(false);
   const openMedals = () => {
    	 setView('medals');
	};

   const [currentLevel, setCurrentLevel] = useState('1');
   const [idx, setIdx] = useState(0);
   const [currentList, setCurrentList] = useState([]);
   const currentKey = currentList[idx];

   // --- âœ… ç²˜è´´è¿™é‡Œï¼šæ–°å¢çš„æ˜Ÿæ˜Ÿå’Œè¿›åº¦çŠ¶æ€ ---
   const [showStageClear, setShowStageClear] = React.useState(false); 
   const WORDS_PER_STAGE = 20; 
   const TOTAL_WORDS = 100;    
    
  // è®¡ç®—å½“å‰æ˜Ÿæ˜Ÿæ•°é‡ (0-5)
  // æ³¨æ„ï¼šè¿™é‡Œç”¨ idx + 1 å› ä¸ºç´¢å¼•æ˜¯ä» 0 å¼€å§‹çš„
   const currentStars = Math.floor((idx + 1) / WORDS_PER_STAGE);

   const [flipped, setFlipped] = useState(false);
   const [testFeedback, setTestFeedback] = useState(null);
   const [isChecking, setIsChecking] = useState(false);
   const [userName, setUserName] = useState(() => localStorage.getItem('steve_name') || '');
	 const [userAvatar, setUserAvatar] = useState(() => localStorage.getItem('steve_avatar') || 'ğŸ§’');
   const [showNameModal, setShowNameModal] = useState(!localStorage.getItem('steve_name'));
   const [tempName, setTempName] = useState(localStorage.getItem('steve_name') || '');
            
  const [learnedWords, setLearnedWords] = React.useState(() => {
    const saved = localStorage.getItem('steve_learned');
    const parsed = saved ? JSON.parse(saved) : [];
    // åˆå§‹åŒ–æ—¶ç›´æ¥åŒæ­¥ç»™å…¨å±€ï¼Œé˜²æ­¢ Leaderboard è¯»å–åˆ°æ—§çš„ 0
    window.learnedWords = parsed; 
    return parsed;
});

// ç›‘å¬å˜åŒ–å¹¶åŒæ­¥åˆ°äº‘ç«¯
React.useEffect(() => {
    window.learnedWords = learnedWords;
    const name = localStorage.getItem('steve_name');
    if (name && learnedWords.length > 0) {
        syncToCloud(name, learnedWords.length, window.userAvatar);
    }
}, [learnedWords]);


// --- âœ… æ–°å¢ï¼šç›‘å¬ç¿»é¢åŠ¨ä½œï¼Œè‡ªåŠ¨æ’­æ”¾ä¸­æ–‡æ±‰å­— ---
   // --- âœ… ä¿®å¤ï¼šç¿»é¢å‘éŸ³ä¼˜åŒ– (è‡ªç„¶è¯­éŸ³ä¼˜å…ˆ + é™é€Ÿ) ---
   useEffect(() => {
       if (view === 'card' && flipped && wordInfo) {
           const synth = window.speechSynthesis;
           
           // 1. å»ºç«‹å‘éŸ³å¯¹è±¡
           const u = new SpeechSynthesisUtterance(wordInfo[1]);
           u.lang = 'zh-CN';
           u.rate = 0.85; // âœ… è¯­é€Ÿå¾®é™ï¼Œæ›´åƒæ•™å­¦å‘éŸ³
           u.pitch = 1.0; // éŸ³è°ƒä¿æŒè‡ªç„¶

           // 2. æ ¸å¿ƒä¿®å¤ï¼šæ›´æ™ºèƒ½çš„è¯­éŸ³åŒ…é€‰æ‹©é€»è¾‘
           const voices = synth.getVoices();
           
           // ä¼˜å…ˆé¡ºåºï¼šGoogle > Microsoft > Apple (Tingting) > ä»»æ„æ™®é€šè¯
           // è¿™æ ·å¯ä»¥é¿å¼€æŸäº›ç³»ç»Ÿé»˜è®¤çš„ä½è´¨é‡è¯­éŸ³
           const mandarinVoice = 
               voices.find(v => v.name.includes('Google') && v.lang.includes('zh-CN')) || 
               voices.find(v => v.name.includes('Microsoft') && v.lang.includes('zh-CN')) || 
               voices.find(v => v.name.includes('Tingting') && v.lang.includes('zh-CN')) ||
               voices.find(v => (v.lang === 'zh-CN' || v.lang === 'zh-Hans-CN') && !/HK|TW|Cantonese|Sin-ji|Yue/i.test(v.name));
           
           if (mandarinVoice) {
               u.voice = mandarinVoice;
           }

           synth.cancel();
           synth.speak(u);
       }
   }, [flipped]);


   const [wrongWords, setWrongWords] = useState(() => JSON.parse(localStorage.getItem('steve_wrong') || '[]'));
   const [highScore, setHighScore] = useState(() => parseInt(localStorage.getItem('steve_highscore')) || 0);
            
    // 3. æ‰“å¡å¤©æ•¸ä¿®å¾©é‚è¼¯
   const [streak, setStreak] = useState(() => parseInt(localStorage.getItem('steve_streak')) || 0);

   const [isChallenge, setIsChallenge] = useState(false);
   const [isWrongSetMode, setIsWrongSetMode] = useState(false);
	  const [isTest, setIsTest] = React.useState(false);
            
   const [score, setScore] = useState(0);
   const [showGameOver, setShowGameOver] = useState(false);
   const [currentQuote, setCurrentQuote] = useState("");

   const [shuffledOptions, setShuffledOptions] = useState([]);
            

   const touchStart = useRef(null);
	
   const [showTutorial, setShowTutorial] = React.useState(() => {
        try {
            // å¦‚æœæœ¬åœ°å­˜å‚¨é‡Œæ²¡æœ‰æ ‡è®°ä¸º 'true'ï¼Œåˆ™æ˜¾ç¤ºæ•™ç¨‹
            return localStorage.getItem('steve_tutorial_done') !== 'true';
           } catch (e) {
            return true; // å®¹é”™å¤„ç†
           }
        });


    const handleCloseTutorial = () => {
      setShowTutorial(false);
      // âœ… è®°å½•åˆ°æœ¬åœ°å­˜å‚¨ï¼Œæœ‰æ•ˆæœŸæ˜¯æ°¸ä¹…ï¼ˆé™¤éæ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼‰
      localStorage.setItem('tutorialCompleted', 'true');
    };

    const handleTutorialFinish = () => {
        // 1. è®¾ç½®æ ‡è®°åˆ°æœ¬åœ°å­˜å‚¨ (Key å¿…é¡»å’Œä¸Šé¢ useState é‡Œçš„ä¸€æ ·)
        localStorage.setItem('steve_tutorial_done', 'true');
        // 2. å…³é—­å¼•å¯¼ç•Œé¢
        setShowTutorial(false);
    };
	
   
    useEffect(() => {
      const warmup = () => {
        const synth = window.speechSynthesis;
        // å¼ºåˆ¶åˆ·æ–°éŸ³è‰²åˆ—è¡¨å¹¶å‘å‡ºä¸€ä¸ªé™éŸ³ç‰‡æ®µ
        synth.getVoices();
        const u = new SpeechSynthesisUtterance("");
        u.volume = 0;
        synth.speak(u);
        
        // æˆåŠŸè§¦å‘åç«‹å³ç§»é™¤ç›‘å¬ï¼Œä¸å ç”¨èµ„æº
        window.removeEventListener('touchstart', warmup);
        window.removeEventListener('click', warmup);
      };
      window.addEventListener('touchstart', warmup, { once: true });
      window.addEventListener('click', warmup, { once: true });
      }, []);

            
      // --- âœ… ä¿®å¤ 1: ä½¿ç”¨ useMemo åªåˆ›å»ºä¸€æ¬¡éŸ³é¢‘å¯¹è±¡ï¼Œå¹¶ä¿®æ­£ URL è·¯å¾„ ---

    const audioClips = useMemo(() => {
    // åŸºç¡€è·¯å¾„
        const baseUrl = 'https://www.stevesplayground.online/game/1000words/music';
    
    return {
        wrong: new Audio(`${baseUrl}/wrong.mp3`),
        correct: new Audio(`${baseUrl}/correct.mp3`),
        star: new Audio(`${baseUrl}/star.mp3`),
        finish: new Audio(`${baseUrl}/finish.mp3`)
        };
      }, []); // ç©ºæ•°ç»„ç¡®ä¿åªåˆå§‹åŒ–ä¸€æ¬¡

    // é¢„åŠ è½½éŸ³é¢‘ï¼Œé¿å…ç¬¬ä¸€æ¬¡æ’­æ”¾å»¶è¿Ÿ
  useEffect(() => {
    Object.values(audioClips).forEach(audio => {
        audio.preload = 'auto';
        audio.load(); // å¼ºåˆ¶æµè§ˆå™¨æå‰è¯·æ±‚èµ„æº
      });
  }, [audioClips]);

    // --- âœ… ä¿®å¤ 2: ç§»é™¤ setTimeout ä»¥å…¼å®¹ iOSï¼Œå¢åŠ é”™è¯¯å¤„ç† ---
  const playSound = (type) => {
    const sound = audioClips[type];
    
    if (sound) {
        // 1. å°è¯•é‡ç½®è¿›åº¦
        sound.currentTime = 0;
        
        // 2. ç›´æ¥æ’­æ”¾ (ä¸è¦ç”¨ setTimeoutï¼Œå¦åˆ™ iOS ä¼šæ‹¦æˆª)
        const playPromise = sound.play();
        
        // 3. æ•è·æ’­æ”¾é”™è¯¯ (é€šå¸¸æ˜¯å› ä¸ºæ²¡æœ‰ç”¨æˆ·äº¤äº’æˆ–èµ„æºæœªåŠ è½½)
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.warn(`æ’­æ”¾ ${type} éŸ³æ•ˆå¤±è´¥:`, error);
                // æŸäº›æ—§ç‰ˆæµè§ˆå™¨å¯èƒ½éœ€è¦é‡æ–° load æ‰èƒ½é‡æ’­
                if (error.name === 'NotAllowedError') {
                     console.log("æµè§ˆå™¨é˜»æ­¢äº†è‡ªåŠ¨æ’­æ”¾ï¼Œéœ€è¦ç”¨æˆ·ç‚¹å‡»");
                }
            });
        }
    } else {
        console.error(`æœªæ‰¾åˆ°éŸ³æ•ˆç±»å‹: ${type}`);
    }
  };

  // åœ¨ App ç»„ä»¶é¡¶éƒ¨å®šä¹‰ä¸€ä¸ªå˜é‡ï¼ˆæˆ–ä½¿ç”¨ useRefï¼‰
  const isSpeakingRef = React.useRef(false);

  // ä¿®æ”¹ speak å‡½æ•°å®šä¹‰ï¼Œå¢åŠ ç¬¬äºŒä¸ªå‚æ•° preferenceOverride
const speak = (text, preferenceOverride = null) => {
    if (!text) return;
    const synth = window.speechSynthesis;
    synth.cancel(); 

    const utter = new SpeechSynthesisUtterance(text);
    const currentPref = preferenceOverride || voicePreference;

    const performSpeak = () => {
        const voices = synth.getVoices();
        let target;

        // --- æ–°å¢é€»è¾‘ï¼šæ£€æµ‹æ˜¯å¦åŒ…å«ä¸­æ–‡ ---
        const hasChinese = /[\u4e00-\u9fa5]/.test(text);

        if (hasChinese) {
            // å¦‚æœæœ‰ä¸­æ–‡ï¼Œå¯»æ‰¾ä¸­æ–‡å‘éŸ³äººï¼ˆé€šå¸¸ä¸­æ–‡å‘éŸ³äººä¹Ÿèƒ½è¯»ç®€å•çš„è‹±æ–‡å¥å­ï¼‰
            target = voices.find(v => /zh-CN|chinese|huihui|xiaoxiao/i.test(v.lang + v.name));
            utter.lang = 'zh-CN';
            utter.pitch = 1.0;
            utter.rate = 0.9; // ç¨å¾®æ”¾æ…¢ä¸€ç‚¹ï¼Œè®©åŒè¯­å¬å¾—æ¸…æ¥š
        } else {
            // --- åŸæœ‰é€»è¾‘ï¼šå¤„ç†çº¯è‹±æ–‡åå¥½ ---
            if (currentPref === 'us-male') {
                target = voices.find(v => /male|david|guy|nathan/i.test(v.name) && /en-US/.test(v.lang));
                utter.pitch = 0.8;
            } else if (currentPref === 'uk-female') {
                target = voices.find(v => /female|en-GB|google uk/i.test(v.name) && /en-GB/.test(v.lang));
                utter.pitch = 1.0;
            } else {
                target = voices.find(v => /samantha|aria|zira|susan|female/i.test(v.name) && /en-US/.test(v.lang))
                         || voices.find(v => /en-US/i.test(v.lang) && !/male/i.test(v.name));
                utter.pitch = 1.0;
            }
            utter.lang = currentPref === 'uk-female' ? 'en-GB' : 'en-US';
            utter.rate = 0.9;
        }

        if (target) utter.voice = target;
        synth.speak(utter);
    };

    if (synth.getVoices().length === 0) {
        synth.onvoiceschanged = performSpeak;
    } else {
        performSpeak();
    }
};

const getStageInfo = () => {
    // è¿‡æ»¤å‡ºå½“å‰å…³å¡å·²å­¦ä¼šçš„å•è¯æ•°é‡
    const levelWordKeys = Object.keys(dbData[currentLevel]?.words || {});
    const count = learnedWords.filter(w => levelWordKeys.includes(w)).length;
    
    // è®¡ç®—å½“å‰æ˜¯ç¬¬å‡ ä¸ª 20 è¯é˜¶æ®µ (1-5)
    const stage = Math.min(Math.floor(count / 20), 5);
    const index = Math.max(stage - 1, 0); // æ•°ç»„ç´¢å¼• 0-4
    
    return {
        count,
        stage, // å½“å‰æ‹¿åˆ°äº†å‡ é¢—æ˜Ÿ
        emoji: (MISSION_REWARDS[currentLevel] || MISSION_REWARDS[1])[index]
    };
};

const getMyRank = (isLoading) => {
    // 1. è·å–åŸºç¡€æ•°æ®
    const leaderboard = window.globalLeaderboardData || [];
    // ç»Ÿä¸€ç”¨åå­—åŒ¹é… (ç§»é™¤ id ä¾èµ–ï¼Œå¢åŠ  trim é˜²æ­¢ç©ºæ ¼å¹²æ‰°)
    const myName = (window.userName || localStorage.getItem('steve_name') || 'Steve').trim();
    // è·å–ä½ å½“å‰çš„å•è¯é‡ (ä½ çš„åˆ†æ•°)
    const myScore = (Array.isArray(learnedWords) ? learnedWords : []).length;

    if (isLoading) return "--";
    // 2. å¦‚æœæ’è¡Œæ¦œæœ‰æ•°æ®
    if (leaderboard && leaderboard.length > 0) {
        // A. å…ˆå°è¯•åœ¨æ¦œå•é‡Œç›´æ¥æ‰¾è‡ªå·±
        const myIndex = leaderboard.findIndex(user => 
            String(user.name).trim() === myName
        );

        // å¦‚æœæ‰¾åˆ°äº†ï¼Œç›´æ¥è¿”å›çœŸå®åæ¬¡
        if (myIndex !== -1) {
            return `${myIndex + 1}`;
        }

        // B. ã€æ ¸å¿ƒä¿®å¤ã€‘å¦‚æœæ²¡æ‰¾åˆ°ï¼ˆè¿˜æ²¡åŒæ­¥ï¼‰ï¼Œä¸è¦ç›´æ¥è¿”å› 99+
        // è€Œæ˜¯è®¡ç®—ï¼šæœ‰å¤šå°‘äººçš„åˆ†æ•°æ¯”æˆ‘é«˜ï¼Ÿ
        // æ¯”å¦‚æ¦œå•æœ‰ 5 äººï¼Œåªæœ‰ 1 ä¸ªäººåˆ†æ¯”æˆ‘é«˜ï¼Œé‚£æˆ‘å°±æ˜¯ç¬¬ 2 å
        const betterPlayersCount = leaderboard.filter(p => p.score > myScore).length;
        
        // ä½ çš„å®æ—¶è™šæ‹Ÿæ’å = æ¯”ä½ å¼ºçš„äººæ•° + 1
        return `${betterPlayersCount + 1}`;
    }

    // 3. å…œåº•ï¼šå¦‚æœè¿æ’è¡Œæ¦œæ•°æ®éƒ½æ²¡åŠ è½½å‡ºæ¥ï¼ˆæ–­ç½‘æˆ–åˆå§‹åŒ–ï¼‰ï¼Œæ‰ç”¨çº¯æ•°å­¦å…¬å¼
    // 100 è¯å¤§çº¦æ’ 80 åï¼Œ200 è¯æ’ 60 å...
    return `${Math.max(1, 100 - Math.floor(myScore / 5))}`;
};

// è‡ªåŠ¨è¯†åˆ«å¹¶æ¸²æŸ“ Emoji æˆ– å›¾ç‰‡
// æ¸²æŸ“åª’ä½“ (å›¾ç‰‡æˆ–Emoji) - å­—ä½“å¤§å°ä¼˜åŒ–ç‰ˆ
      // æ¸²æŸ“åª’ä½“ (å›¾ç‰‡æˆ–Emoji) - Grid ç»ˆææ”¾å¤§ç‰ˆ
    const renderMedia = (content) => {
        if (!content) return null;

        // 1. å›¾ç‰‡å¤„ç† (ä¿æŒä¸å˜)
        if (content.startsWith('./') || content.startsWith('http')) {
            return <img src={content} alt="word" className="w-full h-full object-contain drop-shadow-sm" />;
        }
        
        // 2. Emoji/æ–‡æœ¬å¤„ç† (æ ¸å¿ƒä¿®å¤)
        // ä½¿ç”¨ CSS Grid è¿›è¡Œç»å¯¹å±…ä¸­ï¼Œè¿™æ¯” Flex åœ¨å¤„ç†å¤§å­—å·æ—¶æ›´ç¨³å®šã€‚
        return (
            <div className="w-full h-full grid place-items-center drop-shadow-sm select-none">
                {/* - text-[160px]: è¿›ä¸€æ­¥åŠ å¤§å­—å·åˆ° 160pxï¼Œç¡®ä¿å•ä¸ªå›¾æ ‡ä¹Ÿèƒ½æ’‘æ»¡ç©ºé—´ã€‚
                   - leading-[0]: å¼ºåˆ¶è¡Œé«˜ä¸º 0ã€‚è¿™æ˜¯å…³é”®ï¼é˜²æ­¢å¤§å­—å·è‡ªå¸¦çš„ä¸Šä¸‹ç©ºç™½å¯¼è‡´å›¾æ ‡çœ‹èµ·æ¥åå°æˆ–ä¸å±…ä¸­ã€‚
                */}
                <span className="text-[160px] leading-[0] filter">
                    {content}
                </span>
            </div>
        );
    };

   

// --- âœ… æ–°å¢ï¼šå‹‹ç« å¢™çš„æ»šåŠ¨ Ref å’Œè‡ªåŠ¨å›é¡¶é€»è¾‘ ---
   const medalsListRef = React.useRef(null);
   React.useEffect(() => {
       if (view === 'medals' && medalsListRef.current) {
           medalsListRef.current.scrollTop = 0;
       }
   }, [view]);

// --- âœ… æ–°å¢ï¼šèœå•é¡µåˆ—è¡¨çš„ Ref ---
   const menuListRef = useRef(null);

   // --- âœ… æ–°å¢ï¼šè¿›å…¥èœå•é¡µæ—¶ï¼Œè‡ªåŠ¨æ»šåŠ¨åˆ°é¡¶éƒ¨ ---
 React.useEffect(() => {
       if (view === 'menu') {
           // ä½¿ç”¨ setTimeout å¢åŠ  100ms å»¶è¿Ÿ
           // è¿™èƒ½ç¡®ä¿åœ¨æµè§ˆå™¨æ¸²æŸ“å®Œã€ç”šè‡³å°è¯•æ¢å¤æ»šåŠ¨ä½ç½®ä¹‹åï¼Œæˆ‘ä»¬å†å¼ºåˆ¶æŠŠå®ƒæ‹‰å›æ¥
           setTimeout(() => {
               // 1. å¼ºåˆ¶æ•´ä¸ªç½‘é¡µçª—å£å›é¡¶ (è§£å†³æ ‡é¢˜éœ€ä¸Šæ»‘æ‰æ˜¾ç¤ºçš„é—®é¢˜)
               window.scrollTo(0, 0);
               document.body.scrollTop = 0;
               document.documentElement.scrollTop = 0;
               
               // 2. å¼ºåˆ¶å…³å¡åˆ—è¡¨å›åˆ°æœ€å·¦ä¾§ (å› ä¸ºç°åœ¨æ˜¯æ¨ªå‘æ»‘åŠ¨çš„)
               if (menuListRef.current) {
                   menuListRef.current.scrollLeft = 0;
                   menuListRef.current.scrollTop = 0;
               }
           }, 100); 
       }
   }, [view]);



			
            const dbData = window.DB || (typeof DB !== 'undefined' ? DB : null);
	    const [isDataLoading, setIsDataLoading] = React.useState(true);



            const fullList = useMemo(() => {
                if (!dbData) return [];
                let all = [];
                Object.values(dbData).forEach(lvl => { all = all.concat(Object.keys(lvl.words)); });
                return all;
            }, [dbData]);

            

            // 4. è‡ªå‹•è¨ˆç®—æ‰“å¡å¤©æ•¸
            useEffect(() => {
                const lastDate = localStorage.getItem('steve_last_date');
                const today = new Date().toDateString();
                
                if (lastDate !== today) {
                    const newStreak = streak + 1;
                    setStreak(newStreak);
                    localStorage.setItem('steve_streak', newStreak.toString());
                    localStorage.setItem('steve_last_date', today);
                }
            }, []);

            // ç›£è½ç”Ÿå­˜æ¨¡å¼çµæŸè§¸ç™¼é»ƒé‡‘é›¨
            useEffect(() => {
                if (showGameOver) {
                    const isMaster = isChallenge && score >= 1000;
                    window.fireSuccessConfetti(isMaster);
                }
            }, [showGameOver, isChallenge, score]);

            const handleTouchStart = (e) => { touchStart.current = e.touches[0].clientX; };
            const handleTouchEnd = (e) => {
                if (!touchStart.current || view !== 'card') return;
                const distance = touchStart.current - e.changedTouches[0].clientX;
                if (distance > 50) handleNext();
                else if (distance < -50) handlePrev();
                touchStart.current = null;
            };

          const handleNext = () => {
   
    // 2. åŸæœ‰çš„æ­£å¸¸ç¿»é¡µé€»è¾‘
    if (idx < currentList.length - 1) {
        // è¿˜æ²¡åˆ°æœ€åä¸€å¼ ï¼Œæ­£å¸¸ä¸‹ä¸€å¼ 
        setFlipped(false);
        setIdx(prev => prev + 1);
    } else {
        // èµ°åˆ°äº†æ•°ç»„æœ«å°¾ï¼ˆå¯èƒ½æ˜¯è¯åº“é‡Œä¸æ»¡ 100 ä¸ªçš„æƒ…å†µï¼‰
        setFlipped(false);
        setIdx(0); // å›åˆ°ç¬¬ä¸€å¼ 
    }
};
            const handlePrev = () => { if (idx > 0) { setFlipped(false); setIdx(prev => prev - 1); } };

            const resetProgress = () => {
                if (confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰é€²åº¦å—ï¼Ÿæ‰“å¡å¤©æ•¸ä¹Ÿå°‡æ­¸é›¶ã€‚")) {
                    setLearnedWords([]); setWrongWords([]); setHighScore(0); setStreak(0);
                    localStorage.clear();
                    window.location.reload();
                }
            };

           
useEffect(() => {
    // 1. æœ¬åœ°å­˜å‚¨é€»è¾‘
    localStorage.setItem('userName', userName); // ç¡®ä¿è¿™é‡Œç”¨äº†ä½ æ”¹ååçš„ key
    localStorage.setItem('steve_learned', JSON.stringify(learnedWords));
    localStorage.setItem('steve_wrong', JSON.stringify(wrongWords));
    localStorage.setItem('steve_highscore', highScore.toString());
    localStorage.setItem('steve_avatar', userAvatar);

    // 2. äº‘ç«¯åŒæ­¥é€»è¾‘ï¼ˆå¸¦é˜²æŠ–ï¼‰
    const handler = setTimeout(() => {
        if (userName && learnedWords.length > 0) {
            // ç¡®ä¿ syncToCloud å‡½æ•°å·²åœ¨å¤–éƒ¨å®šä¹‰
            syncToCloud(userName, learnedWords.length, userAvatar);
        }
    }, 2000);

    // 3. æ¸…é™¤å‡½æ•°ï¼ˆè¿™æ˜¯å…³é”®ï¼Œæ£€æŸ¥è¿™é‡Œçš„æ‹¬å·æ˜¯å¦é—­åˆæ­£ç¡®ï¼‰
    return () => {
        clearTimeout(handler);
    }; 
}, [learnedWords, wrongWords, highScore, userAvatar, userName]); 

useEffect(() => {
                if (currentKey && fullList.length > 0) {
                    const distractors = fullList.filter(k => k !== currentKey).sort(() => 0.5 - Math.random()).slice(0, 3);
                    setShuffledOptions([currentKey, ...distractors].sort(() => 0.5 - Math.random()));
                    setTestFeedback(null);
                }
            }, [currentKey, currentList, fullList]);



    const handleChoice = (choice) => {
    if (testFeedback) return;
    
    const currentKey = currentList[idx];

    if (choice === currentKey) {
        // --- ç­”å°äº† ---
        speak(currentKey);
        setTestFeedback('correct');
        
        if (!learnedWords.includes(currentKey)) {
            setLearnedWords(prev => [...prev, currentKey]);
        }

        setTimeout(() => {
            setTestFeedback(null);
            
            if (isChallenge) {
                // Survival æ¨¡å¼
                const newScore = score + 1;
                setScore(newScore);
		if (newScore > highScore) {
                    setHighScore(newScore);
                    // æ³¨æ„ï¼šä½ ç°æœ‰çš„ useEffect ä¼šè‡ªåŠ¨å°† highScore åŒæ­¥ä¿å­˜åˆ° localStorage
                }
                const nextWord = fullList[Math.floor(Math.random() * fullList.length)];
                const newList = [...currentList, nextWord];
                setCurrentList(newList);
                setIdx(idx + 1);
                localStorage.setItem('survival_score', newScore);
                localStorage.setItem('survival_list', JSON.stringify(newList));
            } else {
                // --- Test æ¨¡å¼ï¼šç¢ºä¿è·³è½‰ ---
                const nextIdx = idx + 1;
                if (nextIdx < currentList.length) {
                    setIdx(nextIdx);
                } else {
                    // å…¨é—œå®Œæˆ
                    playSound('finish');
                    setShowGameOver(true);
                }
            }
        }, 800); 

    } else {
        // --- ç­”éŒ¯äº† ---
        setTestFeedback('wrong');
        playSound('wrong');
        if (!wrongWords.includes(currentKey)) {
            setWrongWords(prev => [...prev, currentKey]);
        }

        if (isChallenge) {
            localStorage.removeItem('survival_score');
            localStorage.removeItem('survival_list');
            setTimeout(() => {triggerStars();playSound('finish');setShowGameOver(true)}, 600);
        } else {
            setTimeout(() => setTestFeedback(null), 600);
        }
    }
};

const triggerStars = () => {
    // æ£€æŸ¥åº“æ˜¯å¦åŠ è½½
    if (typeof confetti === 'undefined') return;

    // å–·å°„æ˜Ÿæ˜Ÿ
    const defaults = {
        spread: 360,
        ticks: 50,
        gravity: 0.5,
        decay: 0.94,
        startVelocity: 30,
        colors: ['#FFE400', '#FFBD00', '#E89400', '#FFCA6C', '#FDFFB8']
    };

    function shoot() {
        confetti({
            ...defaults,
            particleCount: 40,
            scalar: 1.2,
            shapes: ['star'] // å…³é”®ï¼šè®¾ç½®ä¸ºæ˜Ÿå½¢
        });

        confetti({
            ...defaults,
            particleCount: 10,
            scalar: 0.75,
            shapes: ['heart']
        });
    }

    // è¿ç»­å–·å°„ä¸¤æ¬¡ï¼Œå¢åŠ å±‚æ¬¡æ„Ÿ
    setTimeout(shoot, 0);
    setTimeout(shoot, 100);
    setTimeout(shoot, 200);
};

useEffect(() => {
    			   if (showLeaderboard) {
        			document.body.style.overflow = 'hidden';
   				 } else {
        			document.body.style.overflow = 'unset';
    				}
			       }, [showLeaderboard]);



            const startMode = (mode, levelId = '1') => {
                // 1. åˆå§‹åŒ–æ‰€æœ‰çŠ¶æ€
                setIsChallenge(false); 
                setIsWrongSetMode(false); 
		setIsTest(false);
                setIdx(0); 
                setFlipped(false); 
                setTestFeedback(null);
                setShowGameOver(false);
		setShowStageClear(false);

                if (!dbData || !dbData[levelId]) return;
                playSound('correct');
                
                if (mode === 'card') {
                    // è·å–è¯¥å…³å¡æ‰€æœ‰å•è¯
                    const allWords = Object.keys(dbData[levelId].words);
                    // è¿‡æ»¤æ‰å·²å­¦ä¼šçš„
                    const toLearn = allWords.filter(k => !learnedWords.includes(k));
		    const isLevelCompleted =  toLearn.length === 0;

                    // å¦‚æœå…¨å­¦å®Œäº†ï¼Œå°±å¤ä¹ å…¨éƒ¨ï¼Œå¦åˆ™åªå­¦æ²¡å­¦ä¼šçš„
                    setCurrentList(toLearn.length > 0 ? toLearn : allWords);
                    setCurrentLevel(levelId); 
                    
		    setIdx(0);          // ä»ç¬¬ 0 ä¸ªå•è¯å¼€å§‹
                    setShowStageClear(false);
		    setView('card');
                } 
                else if (mode === 'test') {
                    setIsChallenge(false);
		    setIsTest(true);

                    // 1. è·å–å½“å‰å…³å¡çš„æ‰€æœ‰å•è¯é”®
                    const allLevelWords = Object.keys(dbData[levelId].words);
                    const totalCount = allLevelWords.length;
                    
                    // 2. è¿‡æ»¤å‡ºå·²å­¦ä¼šçš„å•è¯
                    const learnedInLevel = allLevelWords.filter(k => learnedWords.includes(k));
                    const learnedCount = learnedInLevel.length;
                    
                    // 3. æ ¸å¿ƒé€»è¾‘ï¼šå­¦ä¼šæ•°é‡ä¸º 0 æˆ–ç­‰äºæ€»æ•°ï¼Œæµ‹è¯•å…¨éƒ¨ï¼›å¦åˆ™åªæµ‹è¯•å·²å­¦ä¼šçš„
                    const toTest = (learnedCount === 0 || learnedCount === totalCount) 
                        ? allLevelWords 
                        : learnedInLevel;

                    setCurrentList(toTest);
                    setCurrentLevel(levelId); 
                    setView('test');
                } 
                else if (mode === 'survival') {
                    setIsChallenge(true);
                    // å°è¯•ä»æœ¬åœ°æ¢å¤è¿›åº¦
                    const savedScore = parseInt(localStorage.getItem('survival_score')) || 0;
                    const savedList = JSON.parse(localStorage.getItem('survival_list') || '[]');
                    
                    if (savedScore > 0 && savedList.length > 0) {
                        // ç§»é™¤ confirmï¼Œç›´æ¥æ¢å¤è¿›åº¦
                        setScore(savedScore);
                        setCurrentList(savedList);
                        setIdx(savedList.length - 1); 
                        setView('test');
                        return;
                    }
                    
                    // é‡æ–°å¼€å§‹é€»è¾‘
                    setScore(0);
                    const firstWord = fullList[Math.floor(Math.random() * fullList.length)];
                    const newList = [firstWord];
                    setCurrentList(newList);
                    setIdx(0);
                    localStorage.setItem('survival_score', '0');
                    localStorage.setItem('survival_list', JSON.stringify(newList));
                    setView('test');
                } 
                else if (mode === 'wrong') {
                    if (wrongWords.length === 0) return alert('ç›®å‰æ²’æœ‰éŒ¯é¡Œï¼');
                    setIsWrongSetMode(true);
                    setCurrentList([...wrongWords].sort(() => Math.random() - 0.5));
                    setView('test');
                }


            };

if (showTutorial) {
        return <TutorialLoader onFinish={handleTutorialFinish} />;
    }


if (view === 'medals') {
    // é¢„å¤„ç†ï¼šç¡®ä¿ learnedWords å§‹ç»ˆæ˜¯æ•°ç»„ï¼Œé˜²æ­¢æŠ¥é”™
    const safeLearnedWords = Array.isArray(learnedWords) ? learnedWords : [];

    return (
        // ä¿®å¤ 1: ä½¿ç”¨ h-[100dvh] ä»£æ›¿ h-screenï¼Œè§£å†³æ‰‹æœºæµè§ˆå™¨åº•éƒ¨é®æŒ¡é—®é¢˜
        <div className="h-[100dvh] flex flex-col bg-slate-50 overflow-hidden relative">
        
            {/* é¡¶éƒ¨æ ‡é¢˜æ  */}
            <div className="w-full max-w-md mx-auto px-6 pt-6 flex-none">
                <div className="flex items-center justify-between mb-6">
                    <button 
                        onClick={() => setView('menu')} 
                        className="w-10 h-10 bg-white rounded-2xl shadow-sm flex items-center justify-center text-slate-400 font-bold cursor-pointer active:scale-90 transition-all"
                    >
                        âœ•
                    </button>
                    <h2 className="text-xl font-black text-slate-800 tracking-tight">æˆå°±å‹‹ç« å¢™</h2>
                    <div className="w-10"></div>
                </div>
            </div>

            {/* åˆ—è¡¨å®¹å™¨ */}
            {/* ä¿®å¤ 2: ç»‘å®š ref={medalsListRef} ç”¨äºè‡ªåŠ¨å›åˆ°é¡¶éƒ¨ */}
            <div ref={medalsListRef} className="flex-1 overflow-y-auto pt-2 pb-40 scroll-smooth">
                <div className="max-w-md mx-auto px-6">
                    {Object.keys(MISSION_REWARDS).map((lvl) => {
                        const rewards = MISSION_REWARDS[lvl];
                        if (!rewards) return null;

                        const source = window.DB || (typeof dbData !== 'undefined' ? dbData : null);
                        const levelData = source ? (source[lvl] || source[parseInt(lvl)]) : null;
                        const levelWords = levelData && levelData.words ? Object.keys(levelData.words) : [];
                        
                        const learnedInLevel = safeLearnedWords.filter(w => levelWords.includes(w)).length;
            
                        return (
                            <div key={lvl} className="bg-white rounded-[32px] p-5 shadow-sm border border-slate-100 flex items-center gap-4 mb-4 active:scale-[0.98] transition-all">
                                {/* å·¦ä¾§å¤§å‹‹ç«  */}
                                <div className={`w-20 h-20 rounded-[24px] flex items-center justify-center text-4xl shadow-inner transition-all ${learnedInLevel >= 100 ? 'bg-amber-50 animate-float' : 'bg-slate-50 grayscale opacity-20'}`}>
                                    {rewards[4] || "ğŸ†"}
                                </div>

                                <div className="flex-1">
                                    <div className="flex justify-between items-end mb-2">
                                        <div>
                                            <h3 className="font-black text-slate-800 text-sm leading-none">LEVEL {lvl}</h3>
                                            <p className="text-[10px] font-bold text-slate-400 mt-1 uppercase tracking-wider">{learnedInLevel}/100 WORDS</p>
                                        </div>
                                        <span className="text-[10px] font-black text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded-full">
                                            {Math.min(5, Math.floor(learnedInLevel / 20))}/5 Unlocked
                                        </span>
                                    </div>

                                    {/* 20è¯é˜¶æ¢¯å°å‹‹ç«  */}
                                    <div className="flex gap-2 mt-2">
                                        {rewards.map((emoji, i) => {
                                            const threshold = (i + 1) * 20;
                                            const isStepUnlocked = learnedInLevel >= threshold;
                                            return (
                                                <div 
                                                    key={i} 
                                                    className={`w-9 h-9 rounded-full flex items-center justify-center text-base border-2 transition-all duration-500
                                                    ${isStepUnlocked 
                                                        ? 'bg-gradient-to-br from-white to-indigo-50 border-indigo-200 shadow-md scale-110 opacity-100' 
                                                        : 'bg-slate-100 border-slate-200 opacity-20 grayscale' 
                                                    }`}
                                                >
                                                    {isStepUnlocked ? emoji : "ğŸ”’"}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            </div>

            {/* åº•éƒ¨æ±‡æ€»å¡ç‰‡ */}
            <div className="absolute bottom-0 left-0 right-0 z-50 pointer-events-none">
                <div className="h-24 bg-gradient-to-t from-slate-50 to-transparent" />
                {/* ä¿®å¤ 3: å¢åŠ  pb-safe é€»è¾‘ (è¿™é‡Œç”¨ pb-8 åŸºæœ¬å¤Ÿç”¨ï¼Œç»“åˆå¤–å±‚çš„ 100dvh å³å¯è§£å†³é®æŒ¡) */}
                <div className="bg-slate-50 px-6 pb-8 pointer-events-auto">
                    <div className="w-full max-w-md mx-auto bg-slate-900 rounded-[32px] p-6 text-white flex justify-between items-center shadow-2xl">
                        <div className="flex items-center gap-4">
                            <div className="w-12 h-12 bg-white/10 rounded-2xl flex items-center justify-center text-2xl shadow-inner">ğŸ†</div>
                            <div>
                                <p className="text-[10px] font-bold opacity-50 uppercase leading-none mb-1">Total Medals</p>
                                <p className="text-xl font-black text-amber-400">
                                    {(() => {
                                        let totalUnlocked = 0;
                                        Object.keys(MISSION_REWARDS).forEach(lvl => {
                                            const levelData = dbData[lvl] || dbData[parseInt(lvl)];
                                            if (levelData && levelData.words) {
                                                const levelWordKeys = Object.keys(levelData.words);
                                                const count = safeLearnedWords.filter(w => levelWordKeys.includes(w)).length;
                                                totalUnlocked += Math.floor(Math.min(100, count) / 20);
                                            }
                                        });
                                        return totalUnlocked;
                                    })()}
                                </p>
                            </div>
                        </div>
             
                        <button 
                            onClick={() => setView('menu')} 
                            className="bg-white text-slate-900 px-6 py-3 rounded-2xl font-black text-sm active:scale-95 hover:bg-slate-100 transition-all cursor-pointer"
                        >
                            è¿”å›ä¸»é¡µ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
}            if (view === 'menu') {
                return (

<div className="h-screen flex flex-col bg-slate-50 overflow-hidden">

{/* åå­—æ¨¡æ€æ¡†*/}

                        {showNameModal && (
    /* 1. å¤–å±‚å®¹å™¨ï¼šä¿æŒ fixed å…¨å±å’Œæ»šåŠ¨èƒ½åŠ› */
    <div className="fixed inset-0 z-[500] bg-slate-900/70 backdrop-blur-sm overflow-y-auto">
        
        {/* 2. å¸ƒå±€å®¹å™¨ï¼šç§»é™¤ items-centerï¼Œåªä¿ç•™ flex å’Œ justify-center (æ°´å¹³å±…ä¸­) */}
        <div className="min-h-full flex justify-center p-4">
            
            {/* 3. å†…å®¹å¡ç‰‡ï¼šæ–°å¢ my-auto å®ç°å®‰å…¨çš„å‚ç›´å±…ä¸­ */}
            <div className="bg-white p-6 rounded-[48px] text-center w-full max-w-[340px] shadow-2xl relative my-auto">
                
                <h2 className="text-[22px] font-black mb-6 whitespace-nowrap tracking-tight">Hello! What's your name?</h2>

                {/* å¤´åƒé€‰æ‹©åŒº */}
                <p className="text-xs font-bold text-slate-400 uppercase mb-2">é€‰æ‹©ä¸€ä¸ªå¤´åƒ</p>
                <div className="grid grid-cols-4 gap-2 mb-6">
                    {AVATAR_OPTIONS.map(emoji => (
                        <button 
                            key={emoji}
                            onClick={() => setUserAvatar(emoji)}
                            className={`text-3xl p-2 rounded-xl border-2 transition-all ${userAvatar === emoji ? 'bg-indigo-100 border-indigo-500 scale-110' : 'bg-slate-50 border-slate-100 hover:bg-white'}`}
                        >
                            {emoji}
                        </button>
                    ))}
                </div>

                <input 
                    type="text" 
                    value={tempName} 
                    onChange={(e) => setTempName(e.target.value)} 
                    placeholder="Steve..." 
                    className="w-full bg-slate-50 border-2 border-slate-100 rounded-3xl py-4 px-6 mb-6 font-black text-center outline-none focus:border-indigo-200" 
                />
                
                <button onClick={() => { 
                    setUserName(tempName); 
                    localStorage.setItem('steve_name', tempName); 
                    setShowNameModal(false); 
                    playSound('correct');
                    setShowTutorial(false);
                    localStorage.setItem('tutorialCompleted', 'true'); 
                    syncToCloud(tempName, learnedWords.length, userAvatar);
                }} className="w-full bg-indigo-600 text-white py-5 rounded-[28px] font-black btn-active">Let's Go!</button>
            </div>
        </div>
    </div>
)}

            
            {/* --- ç¬¬ä¸€éƒ¨åˆ†ï¼šé”å®šçš„é¡¶éƒ¨ (Header + å››ä¸ªæ–¹å—) --- */}
            <div className="flex-none bg-white/80 backdrop-blur-lg z-30 px-6 pt-4 pb-2 border-b border-slate-100 shadow-sm">
                <div className="max-w-md mx-auto">

			
			{/* é¡¶éƒ¨æ ‡é¢˜æ  (åŸ header å†…å®¹) */}
                        <header className="flex justify-between items-center mb-6">
                            <div>
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Welcome back</p>
                                <h1 className="text-2xl font-black text-slate-800 tracking-tight">
                                    <span className="text-indigo-600">{userName || 'Steve'}'s</span> English Master
                                </h1>
				<button onClick={resetProgress} className="bg-white border border-slate-100 px-3 py-1 rounded-full text-[10px] font-black text-slate-400 shadow-sm btn-active uppercase">Reset</button>
                            </div>

			   
	{/* å³ä¾§ï¼šåŸ Reset çš„ä½ç½®ç°åœ¨æ”¾ç½® Voice Menu æŒ‰é’® */}
                <div className="relative">
                    <button 
                        onClick={() => setShowVoiceMenu(!showVoiceMenu)}
                        className={`w-12 h-12 rounded-full shadow-lg flex items-center justify-center transition-all duration-300 ${showVoiceMenu ? 'bg-slate-800 rotate-90' : 'bg-white text-slate-600 hover:scale-110'}`}
                    >
                        {showVoiceMenu ? <span className="text-white text-xl">âœ•</span> : <span className="text-2xl">âš™ï¸</span>}
                    </button>

                    {/* ä¸‹æ‹‰èœå•é€»è¾‘ä¿æŒä¸å˜ */}
                    {showVoiceMenu && (
                        <div className="absolute top-14 right-0 bg-white/95 backdrop-blur-md rounded-2xl shadow-xl border border-slate-100 p-2 w-44 flex flex-col gap-1 z-50">
                            <div className="text-[10px] font-black text-slate-400 px-3 py-2 uppercase tracking-widest border-b border-slate-50 mb-1">
                                Voice Accent
                            </div>
                            {[
                                { id: 'us-female', label: 'ğŸ‡ºğŸ‡¸ ç¾éŸ³', color: 'text-indigo-600' },
                              //  { id: 'us-male',   label: 'ğŸ§” ç¾éŸ³ç”·å£°', color: 'text-blue-600' },
                                { id: 'uk-female', label: 'ğŸ‡¬ğŸ‡§ è‹±éŸ³', color: 'text-rose-600' }
                            ].map(v => (
                                <button
                                    key={v.id}
                                    onClick={() => {
                                        setVoicePreference(v.id);
                                        setShowVoiceMenu(false);
                                        
                                        // é¢„çƒ­ä¸å‘éŸ³é€»è¾‘
                                        window.speechSynthesis.getVoices();
                                        const utterance = new SpeechSynthesisUtterance("");
                                        utterance.volume = 0;
                                        window.speechSynthesis.speak(utterance);

                                        setTimeout(() => {
                                            const cleanName = (userName || 'Steve').trim();
                                            // æ³¨æ„ï¼šHello å’Œ Hi åé¢åŠ äº†ç©ºæ ¼
                                            const testText = v.id === 'uk-female' ? `Hello ${cleanName}!` : `Hi ${cleanName}!`;
                                            speak(testText, v.id);
                                        }, 100);
                                    }}
                                    className={`flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-bold transition-all ${
                                        voicePreference === v.id 
                                        ? 'bg-slate-100 ' + v.color 
                                        : 'text-slate-600 hover:bg-slate-50'
                                    }`}
                                >
                                    <span className="text-xl">{v.label.split(' ')[0]}</span>
                                    <span>{v.label.split(' ')[1]}</span>
                                </button>
                            ))}
                        </div>
                    )}
                </div>
            </header>
         
     {/* å››ä¸ªåŠŸèƒ½æ–¹å— (æ’è¡Œæ¦œã€å·²å­¦ä¼šã€æœ€é«˜åˆ†ã€æ‰“å¡) */}          
     <div className="grid grid-cols-4 gap-2.5 mb-2">
    {/* 1. æ’è¡Œæ¦œ - é‡‡ç”¨æ¸å˜é‡‘æ„Ÿ */}
    <button 
        onClick={() => {
            if (window.playSound) playSound('star');
            setShowLeaderboard(true);
        }}
        className="relative overflow-hidden bg-gradient-to-b from-amber-50 to-white p-3 py-4 rounded-[28px] border border-amber-100 shadow-[0_4px_12px_-4px_rgba(251,191,36,0.3)] text-center active:scale-95 transition-all group"
    >
        <div className="absolute -right-1 -top-1 opacity-10 group-hover:scale-125 transition-transform">ğŸ¥‡</div>
        <p className="text-[9px] font-amber text-amber-600/60 uppercase mb-1 tracking-wider whitespace-nowrap">æ’è¡Œæ¦œ</p>
        <p className="text-xl font-black text-amber-600 flex items-center justify-center gap-0.5">{(() => {
    // 1. è·å–å…¨å±€æ•°æ®
    const leaderboard = window.globalLeaderboardData || [];
    const myName = (localStorage.getItem('steve_name') || 'Steve').trim();
    const myScore = (window.learnedWords || []).length;

    // 2. å¦‚æœæ’è¡Œæ¦œè¿˜æ²¡åŠ è½½å‡ºæ¥ (window.globalLeaderboardData ä¸ºç©º)
    if (leaderboard.length === 0) {
      return "--"; 
    }

    // 3. åœ¨æ¦œå•é‡Œæ‰¾è‡ªå·±
    const myIndex = leaderboard.findIndex(user => 
      String(user.name).trim() === myName || user.isMe === true
    );

    // 4. è¿”å›æ’åï¼šæ‰¾åˆ°äº†å°±æ˜¾ç¤ºçœŸå®æ’åï¼Œæ²¡æ‰¾åˆ°å°±æ ¹æ®åˆ†æ•°ä¼°ç®—
    if (myIndex !== -1) {
      return myIndex + 1;
    } else {
      const betterPlayers = leaderboard.filter(p => p.score > myScore).length;
      return betterPlayers + 1;
    }
  })()}
ğŸ¥‡</p>
        <p className="text-[8px] font-bold text-amber-500 mt-1 leading-none bg-amber-100/50 py-0.5 rounded-full">Top 10 </p>
    </button>

    {/* 2. å·²å­¦ä¼š - æŸ”å’Œç´« */}
    <div onClick={() => setView('medals')} className="bg-gradient-to-b from-indigo-50 to-white p-3 py-4 rounded-[28px] border border-indigo-100 shadow-[0_4px_12px_-4px_rgba(79,70,229,0.2)] text-center cursor-pointer">

        <p className="text-[9px] font-black text-indigo-600/50 uppercase mb-1 tracking-wider whitespace-nowrap">å·²å­¸æœƒ</p>
        <p className="text-xl font-black text-indigo-600 flex items-center justify-center gap-0.5">
            {learnedWords.length}<span className="text-sm opacity-70">ğŸ“–</span>
        </p>
        <p className="text-[8px] font-bold text-ingido-500 mt-1 leading-none bg-indigo-100/50 py-0.5 rounded-full">Words</p>
    </div>

    {/* 3. æœ€é«˜åˆ† - å†·è‰³ç° */}
    <div className="bg-gradient-to-b from-slate-50 to-white p-3 py-4 rounded-[28px] border border-slate-100 shadow-[0_4px_12px_-4px_rgba(71,85,105,0.15)] text-center">
        <p className="text-[9px] font-black text-slate-400 uppercase mb-1 tracking-wider whitespace-nowrap">æœ€é«˜åˆ†</p>
        <p className="text-xl font-black text-slate-700">{highScore}<span className="text-sm opacity-70">ğŸ†</span>
</p>
        <p className="text-[8px] font-bold text-slate-500 mt-1 leading-none bg-slate-100/100 py-0.5 rounded-full">Best Score</p>
    </div>

    {/* 4. æ‰“å¡å¤©æ•° - æ´»åŠ›ç»¿ */}
    <div className="bg-gradient-to-b from-emerald-50 to-white p-3 py-4 rounded-[28px] border border-emerald-100 shadow-[0_4px_12px_-4px_rgba(16,185,129,0.2)] text-center group">
        <p className="text-[9px] font-black text-emerald-600/50 uppercase mb-1 tracking-wider whitespace-nowrap">æ‰“å¡</p>
        <p className="text-xl font-black text-emerald-500 flex items-center justify-center gap-0.5 transition-transform group-hover:bounce">
            {streak}<span className="text-sm">ğŸ”¥</span>
        </p>
        <p className="text-[8px] font-bold text-emerald-500 mt-1 leading-none bg-emerald-100/50 py-0.5 rounded-full">Days</p>
    </div>
</div>
</div>
</div>
			
{/* --- ç¬¬äºŒéƒ¨åˆ†ï¼šä¸‹æ–¹å¯æ»‘åŠ¨çš„åˆ—è¡¨ --- */}
<div ref={menuListRef} className="flex-1 overflow-y-auto px-6 pt-4 pb-24 scroll-smooth">
                <div className="max-w-md mx-auto">

                        <div className="space-y-4">
                            {dbData && Object.entries(dbData).map(([id, data]) => {
                                const total = Object.keys(data.words).length;
                                const done = Object.keys(data.words).filter(w => learnedWords.includes(w)).length;
                                return (
                                    <div key={id} className="bg-white p-5 rounded-[36px] border border-slate-50 flex items-center shadow-sm overflow-hidden">
                                        <div className="w-14 h-14 shrink-0 bg-indigo-50/50 rounded-2xl flex items-center justify-center text-3xl mr-4 relative">{data.levelEmoji}</div>
                                        <div className="flex-1">
                                            <h3 className="font-black text-slate-700 text-base">{data.levelName}</h3>
                                            <div className="flex items-center gap-3 mt-2">
                                                <div className="flex-1 bg-slate-100 h-2 rounded-full overflow-hidden">
                                                    <div className="bg-indigo-400 h-full transition-all duration-1000" style={{width: `${(done/total)*100}%`}}></div>
                                                </div>
                                                <span className="text-[10px] font-black text-slate-400">{done}/{total}</span>
                                            </div>
                                        </div>
                                        <div className="flex gap-2 ml-4">
                                            <button onClick={() => startMode('card', id)} className="w-11 h-11 bg-indigo-600 text-white rounded-2xl flex items-center justify-center shadow-md btn-active">ğŸ“–</button>
                                            <button onClick={() => {startMode('test', id); setIsTest(true);setIsChallenge(false);setIsWrongSetMode(false);}}className="w-11 h-11 bg-slate-100 text-slate-600 rounded-2xl flex items-center justify-center btn-active">ğŸ•¹ï¸</button>
                                        </div>
                                    </div>
                                );
                            })}
                            <div style={{ height: '220px' }}></div>


                        </div>
</div>
</div>
                        
                        <nav className="floating-nav flex gap-3 max-w-md mx-auto">
                            <button onClick={() => startMode('survival')} className="flex-1 bg-indigo-50/80 text-indigo-700 h-[64px] rounded-[24px] btn-active flex items-center justify-center gap-2">
                                <div className="w-8 h-8 bg-indigo-600 text-white rounded-xl flex items-center justify-center text-xs shadow-sm">âš¡</div>
                                <div className="text-left"><p className="text-[10px] font-black uppercase opacity-60 leading-none">å…¨é‡æŒ‘æˆ°</p><p className="text-[13px] font-black leading-none mt-1">ç”Ÿå­˜æ¨¡å¼</p></div>
                            </button>
                            <button onClick={() => startMode('wrong')} className="flex-1 bg-slate-50/80 text-slate-700 h-[64px] rounded-[24px] btn-active flex items-center justify-center gap-2 relative">
                                {wrongWords.length > 0 && <span className="badge">{wrongWords.length}</span>}
                                <div className="w-8 h-8 bg-slate-200 text-slate-600 rounded-xl flex items-center justify-center text-xs">ğŸ“•</div>
                                <div className="text-left"><p className="text-[10px] font-black uppercase opacity-60 leading-none">éå›ºç·´ç¿’</p><p className="text-[13px] font-black leading-none mt-1">æˆ‘çš„éŒ¯é¡Œ</p></div>
                            </button>
                        </nav>


{showLeaderboard && (
    <div className="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-md flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div className="bg-slate-50 w-full max-w-md h-[90vh] sm:h-[80vh] rounded-t-[40px] sm:rounded-[40px] flex flex-col relative shadow-2xl animate-in slide-in-from-bottom duration-300">
            
            {/* å…³é—­æŒ‰é’® */}
            <button 
                onClick={() => setShowLeaderboard(false)}
                className="absolute top-4 right-4 z-10 w-10 h-10 bg-white/80 rounded-full flex items-center justify-center text-xl shadow-sm"
            >
                âœ•
            </button>

            {/* å†…å®¹åŒº */}
            <div className="flex-1 overflow-y-auto p-6 pt-10">
                <Leaderboard />
            </div>

            {/* åº•éƒ¨æŒ‰é’® */}
            <div className="p-6 bg-white border-t border-slate-100 rounded-b-[40px]">
                <button 
                    onClick={() => setShowLeaderboard(false)}
                    className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg active:scale-95 transition-transform"
                >
                    æˆ‘çŸ¥é“å•¦
                </button>
            </div>
        </div>
    </div>
)}

                    </div>
                );
            }

            const wordInfo = dbData && currentKey ? (Object.values(dbData).find(l => l.words[currentKey])?.words[currentKey]) : null;

            return (
                <div className="max-w-md mx-auto h-screen flex flex-col p-6 bg-white overflow-hidden" onTouchStart={handleTouchStart} onTouchEnd={handleTouchEnd}>
                   <header className="flex flex-col gap-4 mb-6">
   {/* ç¬¬ä¸€è¡Œï¼šè¿”å›æŒ‰é’® + æ˜Ÿæ˜Ÿè¿›åº¦ */}
<div className="flex justify-between items-center">
    <button 
        onClick={() => setView('menu')} 
        className="bg-slate-50 h-10 px-4 rounded-2xl font-black text-slate-400 text-[11px] uppercase border border-slate-100 btn-active flex items-center justify-center"
    >
        â† è¿”å›
    </button>

    {/* âœ… åªæœ‰åœ¨ Card æ¨¡å¼ æˆ– Test æ¨¡å¼ä¸‹æ‰æ˜¾ç¤ºæ˜Ÿæ˜Ÿè¿›åº¦æ¡ */}
    {(view === 'card' && !isWrongSetMode && !isChallenge) || isTest ? (
        <div className="bg-slate-50/50 border border-slate-100 px-3 py-1.5 rounded-2xl flex items-center gap-1.5 shadow-inner">
            {[0, 1, 2, 3, 4].map(starIdx => {
                const levelWords = Object.keys(dbData[currentLevel].words);
                const learnedInLevel = learnedWords.filter(w => levelWords.includes(w)).length;
                const earnedStars = Math.floor(learnedInLevel / 20);
                const isActive = starIdx < earnedStars;
                
                return (
                    <div key={starIdx} className="relative w-6 h-6 flex items-center justify-center">
                        <span className="text-slate-200 text-lg absolute">â˜†</span>
                        {isActive && (
                            <span 
                                className="text-amber-400 text-lg absolute animate-in zoom-in duration-500 drop-shadow-[0_0_8px_rgba(251,191,36,0.4)]"
                                style={{ animationDelay: `${starIdx * 100}ms` }}
                            >
                                â­
                            </span>
                        )}
                    </div>
                );
            })}
        </div>
    ) : (
        /* é Card/Test æ¨¡å¼æ—¶ï¼Œä¸­é—´ç•™ç©ºä»¥ä¿æŒå¸ƒå±€å¹³è¡¡ */
        <div className="flex-1"></div>
    )}

    {/* å³ä¾§å ä½ */}
    <div className="w-[60px]"></div> 
</div>

    {/* ç¬¬äºŒè¡Œï¼šå·¦ä¾§æ˜¾ç¤ºå…³å¡åï¼Œå³ä¾§æ˜¾ç¤ºè¿›åº¦æ•°å­— */}
    <div className="flex justify-between items-end px-1">
        <div className="flex flex-col">
            <span className="text-[9px] font-black text-slate-300 uppercase tracking-widest leading-none mb-1">{isChallenge ? "Survival Mode" : (isWrongSetMode ?"Review Mode":"Current Progress")}</span>
            <div className="text-[14px] font-black text-slate-600">
                {isChallenge ? "æŒ‘æˆ° 1000 è©" : (isWrongSetMode ? "éŒ¯é¡Œè¤‡ç¿’" : `LEVEL ${currentLevel}`)}
		
            </div>
        </div>
        <div className="text-right">
            <span className="text-[9px] font-black text-slate-300 uppercase tracking-widest leading-none mb-1">{isChallenge ? "Total Attempt" : "Word Count"}</span>
            <div className="text-[14px] font-black text-indigo-600">
                {idx + 1} <span className="text-slate-300">/</span> {isChallenge ? fullList.length : currentList.length}
            </div>
        </div>
    </div>
</header>
                   
<div className="flex-1 flex flex-col relative w-full overflow-hidden">
    {wordInfo && (
        view === 'card' ? (
    /* ==========================================
       1. å¡ç‰‡æ¨¡å¼ (Card Mode - ç»ˆæä¿®å¤ç‰ˆ)
       ========================================== */
    <div className="flex-1 flex flex-col w-full h-full">
        
        {/* A. å¡ç‰‡åŒºåŸŸï¼šè‡ªåŠ¨æ’‘æ»¡å‰©ä½™ç©ºé—´ */}
        <div className="flex-1 flex flex-col items-center justify-center w-full min-h-0">
            <div className={`card-inner ${flipped ? 'flipped' : ''}`} onClick={() => setFlipped(!flipped)}>
                
                {/* --- å¡ç‰‡æ­£é¢ (Front) --- */}
                <div className="card-face bg-white border-slate-50 flex flex-col items-center justify-between py-10">
                    
                    {/* âœ… ä¿®å¤æ ¸å¿ƒï¼š
                        1. h-56: ç»™å›¾ç‰‡ä¸€ä¸ªå›ºå®šçš„ã€è¶³å¤Ÿå¤§çš„é«˜åº¦ (çº¦ 224px)ã€‚
                        2. shrink-0: æ— è®ºå±å¹•å¤šå°ï¼Œæˆ–è€…ä¸‹æ–¹æ–‡å­—å¤šå¤§ï¼Œç»å¯¹ä¸å…è®¸å‹ç¼©è¿™ä¸ªé«˜åº¦ã€‚
                        3. mt-auto/mb-auto: è®©å†…å®¹åœ¨å‚ç›´æ–¹å‘æ›´è‡ªç„¶åœ°åˆ†å¸ƒã€‚
                    */}
                    <div 
                        className="h-56 shrink-0 w-full flex items-center justify-center select-none cursor-pointer mt-4"
                        onClick={(e) => { e.stopPropagation(); speak(currentKey); }}
                    >
                        {/* ä¿æŒ renderMedia å†…éƒ¨çš„ text-[85px] ä¸å˜ */}
                        <div className="w-full h-full flex items-center justify-center transition-transform active:scale-95">
                            {renderMedia(wordInfo[0])}
                        </div>
                    </div>

                    {/* å•è¯æ–‡æœ¬åŒºåŸŸ */}
                    <div className="flex-1 flex flex-col items-center justify-center w-full min-h-0">
                        <div className="text-[64px] font-black text-slate-800 uppercase tracking-tighter leading-none text-center px-2 drop-shadow-sm">
                            {currentKey}
                        </div>
                    </div>

                    {/* å–‡å­æŒ‰é’® */}
                    <button 
                        onClick={(e) => { e.stopPropagation(); speak(currentKey); }} 
                        className="mb-4 w-16 h-16 shrink-0 bg-slate-50 rounded-full flex items-center justify-center text-2xl btn-active border border-slate-100 shadow-sm text-indigo-500"
                    >
                        ğŸ”Š
                    </button>
                </div>

                {/* --- å¡ç‰‡èƒŒé¢ (Back) --- */}
                <div className="card-face card-back flex flex-col items-center justify-between py-8 px-4">
                    {/* ä¸ŠåŠéƒ¨åˆ†ï¼šè¯æ±‡ */}
                    <div className="flex-1 flex flex-col items-center justify-center w-full gap-1">
                        {wordInfo[4] && (
                            <div className="text-2xl font-bold text-indigo-300 font-mono tracking-widest opacity-90">
                                {wordInfo[4]}
                            </div>
                        )}
                        <div className={`font-black text-white leading-tight drop-shadow-md select-none whitespace-nowrap transition-all duration-300 ${
                            wordInfo[1].length > 4 ? 'text-[42px]' : 
                            wordInfo[1].length === 4 ? 'text-[54px]' : 
                            wordInfo[1].length === 3 ? 'text-[64px]' : 
                            'text-[72px]'
                        }`}>
                            {wordInfo[1]}
                        </div>
                        {wordInfo[2] && (
                            <div className="text-indigo-200 text-sm font-bold tracking-wider mt-1 opacity-80">
                                {wordInfo[2]}
                            </div>
                        )}
                    </div>

                    {/* ä¸­é—´éƒ¨åˆ†ï¼šä¾‹å¥ */}
                    <div 
                        onClick={(e) => { 
                            e.stopPropagation(); 
                            const synth = window.speechSynthesis;
                            synth.cancel(); 
                            const uEn = new SpeechSynthesisUtterance(wordInfo[3]); uEn.lang = 'en-US'; uEn.rate = 0.85; 
                            const uCn = new SpeechSynthesisUtterance(wordInfo[5] || wordInfo[1]); uCn.lang = 'zh-CN'; uCn.rate = 0.85; 
                            const voices = synth.getVoices();
                            const mandarinVoice = voices.find(v => v.name.includes('Google') && v.lang.includes('zh-CN')) || voices.find(v => v.name.includes('Microsoft') && v.lang.includes('zh-CN')) || voices.find(v => (v.lang === 'zh-CN' || v.lang === 'zh-Hans-CN') && !/HK|TW|Cantonese|Sin-ji|Yue/i.test(v.name));
                            if (mandarinVoice) uCn.voice = mandarinVoice;
                            synth.speak(uEn); synth.speak(uCn);
                        }} 
                        className="w-full bg-white/10 rounded-[24px] p-4 my-4 cursor-pointer active:scale-95 transition-all border border-white/20 hover:bg-white/20 group flex flex-col items-center gap-1.5 shrink-0"
                    >
                        <p className="text-white font-bold text-[15px] leading-snug text-center opacity-95 group-hover:opacity-100">"{wordInfo[3]}"</p>
                        {wordInfo[5] && <p className="text-indigo-200 text-xs font-bold text-center opacity-80">{wordInfo[5]}</p>}
                    </div>

                    {/* åº•éƒ¨æŒ‰é’® */}
                    <button onClick={(e) => { 
                        e.stopPropagation(); 
                        setIsChecking(true); playSound('correct');
                        setTimeout(() => { 
                            const isNewWord = !learnedWords.includes(currentKey);
                            if (isNewWord) {
                                const newTotalLearned = [...learnedWords, currentKey];
                                setLearnedWords(newTotalLearned);
                                const lvlCount = newTotalLearned.filter(w => Object.keys(dbData[currentLevel].words).includes(w)).length;
                                if (lvlCount > 0 && lvlCount % 20 === 0) {
                                    const quoteIdx = (parseInt(currentLevel) - 1) * 5 + (Math.floor(idx / 20) - 1);
                                    const quote = MOTIVATIONAL_QUOTES[quoteIdx] || "Keep it up!";
                                    setCurrentQuote(quote); playSound('star'); triggerStars(); setShowStageClear(true); setTimeout(() => speak(quote), 500);
                                }
                            }
                            setFlipped(false); setIsChecking(false); handleNext();
                        }, 800);
                    }} className={`w-16 h-16 shrink-0 rounded-full border-4 flex items-center justify-center transition-all shadow-lg ${(learnedWords.includes(currentKey)) ? 'bg-slate-100 border-slate-300 text-slate-400 hover:bg-emerald-100 hover:border-emerald-200 hover:text-emerald-500' : (isChecking ? 'bg-emerald-400 border-emerald-400 scale-110 btn-active' : 'bg-white/20 border-white btn-active')}`}>
                        <svg className={`w-8 h-8 ${learnedWords.includes(currentKey) ? 'text-current' : 'text-white'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="4" d="M5 13l4 4L19 7"/></svg>
                    </button>
                </div>
            </div>
            <div className="swipe-hint"><span>â† æ»‘å‹•ä¸‹å€‹</span><span>å›çœ‹ä¸Šå€‹ â†’</span></div>
        </div>
        
        {/* B. åº•éƒ¨æ“ä½œæ  */}
        <div className="w-full flex justify-between px-8 pb-6 mt-4 select-none z-10">
            <button onClick={(e) => { e.stopPropagation(); handlePrev(); }} className="text-slate-400 hover:text-indigo-600 font-black text-xs uppercase tracking-widest transition-colors py-4 flex items-center gap-1 cursor-pointer active:scale-95">â† PREV</button>
            <button onClick={(e) => { e.stopPropagation(); handleNext(); }} className="text-slate-400 hover:text-indigo-600 font-black text-xs uppercase tracking-widest transition-colors py-4 flex items-center gap-1 cursor-pointer active:scale-95">NEXT â†’</button>
        </div>
    </div>
) : (
    /* ==========================================
       2. æµ‹è¯•æ¨¡å¼ (Test Mode - ç»ˆæé˜²æŒ¤å‹ç‰ˆ)
       ========================================== */
    <div className="flex-1 flex flex-col w-full h-full px-4 overflow-hidden">
        {/* A. å›¾åƒåŒºåŸŸï¼šå›ºå®šé«˜åº¦ + ç¦æ­¢å‹ç¼© */}
        <div 
            className="h-56 shrink-0 flex items-center justify-center w-full mb-4 mt-2 select-none cursor-pointer"
            onClick={(e) => { e.stopPropagation(); speak(currentKey); }}
        >
            <div className="w-full h-full flex items-center justify-center transition-transform active:scale-95">
                {renderMedia(wordInfo[0])}
            </div>
        </div>

        {/* B. é€‰é¡¹åŒºåŸŸï¼šflex-1 å æ®å‰©ä½™ç©ºé—´ */}
        <div className="flex-1 w-full pb-6 flex flex-col justify-end">
            <div className="grid grid-cols-2 gap-4">
                {shuffledOptions.map((opt, i) => (
                    <button key={`${currentKey}-${opt}-${i}`} onClick={() => handleChoice(opt)}
                        className={`min-h-[5rem] p-4 rounded-[28px] font-black text-lg border-b-[6px] transition-all btn-active shadow-sm flex items-center justify-center break-words leading-tight ${
                            testFeedback === 'correct' && opt === currentKey ? 'bg-emerald-500 text-white border-emerald-700' :
                            testFeedback === 'wrong' && opt !== currentKey ? 'bg-rose-50 text-rose-300 border-rose-100' : 
                            (testFeedback === 'wrong' && opt === currentKey ? 'bg-emerald-100 text-emerald-500 border-emerald-200' : 'bg-white text-slate-600 border-slate-100')
                        }`}
                    >
                        <span className="line-clamp-3">{opt}</span>
                    </button>
                ))}
            </div>
        </div>
    </div>
)
    )}
</div>


{/* é˜¶æ®µæ€§å¥–åŠ±å¼¹çª— */}
{showStageClear && (
    <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-6">
        <div className="bg-white rounded-[40px] p-8 flex flex-col items-center shadow-2xl animate-in zoom-in duration-300 w-full max-w-sm border-2 border-slate-100">
            
            {/* åŠ¨æ€ Emoji åŠ¨ç”» */}
            <div className="text-8xl mb-4 animate-bounce drop-shadow-xl">
                {getStageInfo().emoji}
            </div>

            <div className="text-center mb-6">
                <h2 className="text-2xl font-black text-slate-800">{currentQuote}</h2>
                <p className="text-indigo-600 font-bold uppercase text-[10px] tracking-widest mt-1">è·å¾—é˜¶æ®µå‹‹ç« </p>
            </div>
            
            {/* 5æ ¼è¿›åº¦æŒ‡ç¤ºå™¨ */}
            <div className="flex gap-3 mb-8">
                {[1, 2, 3, 4, 5].map((s) => (
                    <div 
                        key={s}
                        className={`w-4 h-4 rounded-full border-2 transition-all duration-500 ${
                            s <= getStageInfo().stage ? 'bg-indigo-500 border-indigo-200 scale-110' : 'bg-slate-100 border-slate-50'
                        }`}
                    ></div>
                ))}
            </div>

            <p className="text-slate-500 font-bold mb-8 text-center text-sm">
                ä½ å·²åœ¨ Level {currentLevel} å­¦å®Œ <span className="text-indigo-600 text-xl">{getStageInfo().count}</span> è¯<br/>
		
                <span className="text-indigo-600 font-bold text-center mb-6 text-lg px-4">{getStageInfo().count >= 100 ? "æœ¬å…³æ‰“å¡æˆåŠŸ!" : "å†å­¦20ä¸ªå•è¯è§£é”æ–°å‹‹ç« å“¦!"} </span> 
            </p>

            <button 
                onClick={() => setShowStageClear(false)}
                className="w-full bg-slate-900 text-white text-lg font-black py-4 rounded-3xl shadow-lg active:scale-95 transition-all"
            >
                ç»§ç»­ä¸‹ä¸€ç»„
            </button>
        </div>
    </div>
)}
                    
{showGameOver && (
    <div className="fixed inset-0 z-[200] flex items-center justify-center bg-slate-900/90 backdrop-blur-xl p-6">
        {/* åˆ¤æ–­æ˜¯å¦ä¸ºæ™®é€šé—¯å…³æ¨¡å¼ (Cardæ¨¡å¼) */}
        {(!isChallenge && !isTest && !isWrongSetMode) ? (
            /* ==========================================
               1. CARD æ¨¡å¼ (é¢†å–å‹‹ç« ç•Œé¢)
               ========================================== */
            <div className="bg-white rounded-[56px] p-10 flex flex-col items-center shadow-2xl w-full max-w-sm border-2 border-amber-100 relative animate-in fade-in zoom-in duration-300">
                {/* ç»ˆæå‹‹ç«  */}
                <div className="relative mb-6 medal-main">
                    <div className="text-[120px] leading-none filter drop-shadow-2xl animate-float">
                        {MISSION_REWARDS[currentLevel] ? MISSION_REWARDS[currentLevel][4] : "ğŸ†"}
                    </div>
                </div>

                {/* äº”æ˜ŸåŠ¨æ€å¼¹å‡º */}
                <div className="flex gap-1 mb-6">
                    {[1, 2, 3, 4, 5].map((s) => (
                        <span key={s} className="text-4xl star-animated" style={{ animationDelay: `${s * 0.15}s` }}>â­</span>
                    ))}
                </div>

                <div className="text-center mb-10">
                    <h2 className="text-3xl font-black text-slate-800 tracking-tight leading-none mb-2">LEVEL {currentLevel}</h2>
                    <div className="bg-amber-100 text-amber-700 text-[10px] font-black px-4 py-1 rounded-full uppercase tracking-widest inline-block">
                        å‹‹ç« å·²æ”¶å…¥æ”¶è—å¤¹
                    </div>
                    <p className="text-amber-500 font-black mt-4 text-xl">å·²å­¦å®Œ 100 ä¸ªå•è¯ï¼</p>
                </div>

                <button 
                    onClick={() => { setShowGameOver(false); setView('menu'); setIdx(0); }}
                    className="w-full bg-indigo-600 text-white py-5 rounded-[28px] font-black text-xl shadow-xl active:scale-95 transition-all"
                >
                    é¢†å–å¹¶è¿”å›
                </button>
            </div>
        ) : (
            /* ==========================================
               2. å…¶ä»–æ¨¡å¼ (Challenge, Test, WrongSet)
               ========================================== */
            <div className={`bg-white p-10 rounded-[56px] text-center w-full max-w-[380px] shadow-2xl transform transition-all ${score >= 1000 ? 'gold-glow' : ''}`}>
                {isChallenge && score >= 1000 ? (
                    /* ç‰¹æ®Šæƒ…å†µï¼šæŒ‘æˆ˜æ¨¡å¼å¤§æ»¡è´¯ */
                    <>
                        <div className="text-8xl mb-6 floating-emoji">ğŸ‘‘</div>
                        <h2 className="text-2xl font-black mb-4 tracking-tight leading-tight">
                            Congratulations, <span className="text-yellow-500">{userName || 'Steve'}</span>!
                        </h2>
                        <p className="text-slate-600 font-bold mb-8 leading-relaxed">
                            ç¥è³€ä½ åœ¨ <span className="text-emerald-500 text-xl">{streak}</span> å¤©å…§å®Œæˆäº† <span className="text-indigo-600 text-xl">1000è©</span> å¤§æŒ‘æˆ°ï¼
                        </p>
                    </>
                ) : (
                    /* å¸¸è§„æµ‹è¯•/é”™é¢˜/æ™®é€šæŒ‘æˆ˜ç»“æœ */
                    <>
                        <div className="text-8xl mb-6">
                            {isChallenge ? (score > highScore ? "ğŸ†" : "ğŸ‰") : "âœ…"}
                        </div>
                        <h2 className="text-2xl font-black mb-2">
                            {isChallenge ? (score >= highScore ? "æ‰“ç ´ç´€éŒ„!" : "å¤ªæ£’äº†!") : (isWrongSetMode ? "è¨‚æ­£å®Œæˆ!" : (isTest ? "æ¸¬è©¦å®Œæˆï¼" : "å­¸ç¿’å®Œæˆ!"))}
                        </h2>
                        <div className="mb-8">
                            {isChallenge ? (
                                <p className="font-black text-slate-400 text-lg uppercase tracking-widest">
                                    Score: {score}
                                </p>
                            ) : (
                                <div className="flex flex-col items-center gap-2">
                                    <p className="font-black text-slate-400 text-sm uppercase tracking-widest">
                                        {isWrongSetMode ? "é”™é¢˜è¤‡ç¿’é€²åº¦" : "æœ¬æ¬¡æ¸¬è©¦æˆæœ"}
                                    </p>
                                    <p className="text-4xl font-black text-indigo-600">
                                        {isWrongSetMode ? `å·²è¨‚æ­£ ${currentList.length} å€‹å–®å­—` : `å·²è¤‡ç¿’å®Œ ${currentList.length} å€‹å•å­—`}
                                    </p>
                                    <p className="text-[11px] font-bold text-slate-400 uppercase tracking-tight mt-1">
                                        {isWrongSetMode ? "Review Mode Completed" : "Test Session Finished"}
                                    </p>
                                </div>
                            )}
                        </div>
                    </>
                )}
                <button 
                    onClick={() => { setShowGameOver(false); setView('menu'); setIdx(0); }} 
                    className="w-full bg-slate-900 text-white py-5 rounded-[28px] font-black btn-active shadow-lg"
                >
                    å›åˆ°é¦–é 
                </button>
            </div>
        )}
    </div>
)}



                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
// --- æ³¨å†Œ Service Worker å¼€å§‹ ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // æ³¨æ„ï¼šsw.js å¿…é¡»å­˜æ”¾åœ¨ä½ æœåŠ¡å™¨çš„æ ¹ç›®å½•ä¸‹
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('æœåŠ¡å·¥ä½œçº¿ç¨‹å·²å°±ç»ªï¼èŒƒå›´:', reg.scope))
                    .catch(err => console.error('æ³¨å†Œå¤±è´¥:', err));
            });
        }
        // --- æ³¨å†Œ Service Worker ç»“æŸ ---
    </script>
<script src="https://fastly.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</body>
</html>





