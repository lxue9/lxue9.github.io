<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta property="og:image" content="https://www.stevesplayground.online/game/1000words_logo.png" />
    <meta property="og:title" content="Welcome to Steve's playgroundï¼" />
    <meta property="og:description" content="A game site developed by Steve and his mom." />
    <meta property="og:url" content="https://www.stevesplayground.online/game/1000words/" />
    <meta property="og:type" content="website" />

    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <title>English Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://fastly.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/@babel/standalone@7.23.10/babel.min.js"></script>


    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script src="./vocabulary.js"></script>
    <style>

    /* æ­¥éª¤åˆ‡æ¢æ—¶çš„è¿›åœºåŠ¨ç”» */
    @keyframes slide-up-fade {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .step-anim {
      animation: slide-up-fade 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    }

    /* æ¨¡æ‹Ÿæ‰‹æŒ‡ç‚¹å‡»åŠ¨ä½œ */
    @keyframes hand-tap-simple {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(0.9) translateY(5px); }
    }

    .hand-simple {
      font-size: 50px;
      position: absolute;
      z-index: 50;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
      animation: hand-tap-simple 1.5s infinite ease-in-out;
    }

    /* è¿›åº¦æ¡åŠ¨ç”» */
   .progress-fill {
      transition: width 0.5s ease-out;
    }

    /* æ˜Ÿæ˜Ÿç‚¹äº®æ—¶çš„å‘¼å¸ç¯æ•ˆæœ */
    @keyframes star-glow {
     0%, 100% { filter: drop-shadow(0 0 2px rgba(251,191,36,0.4)); }
      50% { filter: drop-shadow(0 0 10px rgba(251,191,36,0.7)); }
    }

    .star-active {
      animation: star-glow 2s infinite ease-in-out;
    }

    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');
    body { 
            font-family: 'Nunito', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background: #fcfcfd; color: #1e293b; margin: 0; padding: 0;
            overflow-x: hidden; touch-action: pan-y;
        }
        
        /* 1. æµ®å‹• Emoji å‹•ç•« */
        @keyframes emoji-jump { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-50px); } }
        .floating-emoji { display: inline-block; animation: emoji-jump 0.5s ease-in-out infinite; }

        /* 2. é»ƒé‡‘é›¨ç‰¹æ•ˆèƒŒæ™¯ */
        .gold-glow { box-shadow: 0 0 50px rgba(255, 215, 0, 0.4); border: 4px solid #FFD700 !important; }

        .floating-nav { 
            position: fixed; bottom: 24px; left: 20px; right: 20px; 
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 32px; 
            z-index: 100; padding: 12px; box-shadow: 0 15px 35px -5px rgba(0,0,0,0.1);
        }
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 500; padding: 20px; }
        .card-inner { transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); transform-style: preserve-3d; height: 420px; width: 100%; max-width: 340px; margin: 0 auto; position: relative; }
        .flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 48px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.04); border: 10px solid white; }
        .card-back { background: #6366F1; color: white; transform: rotateY(180deg); }
        .btn-active { transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .btn-active:active { transform: scale(0.95); opacity: 0.8; }
        .badge { position: absolute; top: -6px; right: -6px; background: #fb7185; color: white; font-size: 10px; font-weight: 900; padding: 2px 8px; border-radius: 10px; border: 2px solid white; }
        .swipe-hint { position: absolute; bottom: -40px; font-size: 12px; font-weight: 900; color: #cbd5e1; display: flex; gap: 20px; }

		@keyframes slow-float {
 		 0%, 100% { transform: translateY(0); }
  		50% { transform: translateY(-5px); } /* å‘ä¸Šæ¼‚æµ® 5px */
		}

		.animate-float {
 			 animation: slow-float 3s ease-in-out infinite;
  			display: inline-flex; /* ç¡®ä¿åŠ¨ç”»åº”ç”¨åœ¨è¡Œå†…å—ä¸Š */
		}
		
    </style>
</head>

<body>
   
<div id="root">
    <div style="display:flex; justify-content:center; align-items:center; height:100vh; background:#f8fafc; font-family:sans-serif; color:#6366f1;">
        <div style="text-align:center;">
            <div style="border:4px solid #e0e7ff; border-top:4px solid #6366f1; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:0 auto 16px;"></div>
            <p style="font-weight:bold; font-size:14px;">å‡†å¤‡å•è¯å†’é™©ä¸­...</p>
        </div>
    </div>
</div>

<style>
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>

<script type="text/babel">
  const { useState, useEffect, useMemo, useRef } = React;
	const AVATAR_OPTIONS = ['ğŸ‘¦','ğŸ‘§','ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸ¦„', 'ğŸ²'];
	const BOT_NAMES = [
  	  "å¿«ä¹å°è™", "å•è¯è¶…äºº", "é—ªç”µå…”", "å­¦ä¹ ä¹‹æ˜Ÿ", 
   	 "æ™ºæ…§å°å®", "å†²åˆºé˜Ÿé•¿", "æ»¡åˆ†å–µå–µ", "å½©è™¹å°é©¬",
    	"å¥¥ç‰¹æ›¼", "è‰¾èå…¬ä¸»", "è¶…çº§é£ä¾ ", "æ±ªæ±ªé˜Ÿ"
	    ];
  
  const MISSION_REWARDS = {
    1: ["ğŸŒ±", "ğŸŒ¿", "â˜˜ï¸", "ğŸ€", "ğŸŒ³"],  // Level 1: æ¤ç‰©æˆé•¿
    2: ["ğŸ£", "ğŸ¥", "ğŸ¤", "ğŸ¦", "ğŸ¦…"],  // Level 2: é¸Ÿç±»è¿›åŒ–
    3: ["ğŸ’§", "ğŸŒŠ", "ğŸ§Š", "â„ï¸", "ğŸ”ï¸"],  // Level 3: æ°´ä¹‹å½¢æ€
    4: ["ğŸ•¯ï¸", "ğŸ”¦", "ğŸ’¡", "â˜€ï¸", "ğŸ”¥"],  // Level 4: å…‰æ˜ä¹‹æº
    5: ["ğŸš—", "ğŸï¸", "ğŸš„", "âœˆï¸", "ğŸš€"],  // Level 5: é€Ÿåº¦é£è·ƒ
    6: ["ğŸ¥‰", "ğŸ¥ˆ", "ğŸ¥‡", "ğŸ†", "ğŸ‘‘"],  // Level 6: è£èª‰é˜¶æ¢¯
    7: ["ğŸš²", "ğŸ›µ", "ğŸï¸", "ğŸï¸", "ğŸ›¸"],  // Level 7: æœªæ¥äº¤é€š
    8: ["â˜ï¸", "ğŸŒ¤ï¸", "â˜€ï¸", "ğŸŒˆ", "ğŸª"],  // Level 8: å¤©ç©ºæ¢ç´¢
    9: ["ğŸ¥Š", "ğŸ¥‹", "ğŸ¤º", "ğŸ¤º", "âš”ï¸"],  // Level 9: å‹‡è€…ä¹‹è·¯
    10: ["ğŸ¹", "ğŸ›¡ï¸", "âš”ï¸", "ğŸ’", "ğŸ”±"]  // Level 10: æœ€ç»ˆç¥è¯
};
  

   // ç”Ÿæˆ 100-200 ä¹‹é—´çš„éšæœºæ•´æ•°
   const getRandomScore = () => Math.floor(Math.random() * (200 - 100 + 1)) + 100;
   // éšæœºè·å–ä¸€ä¸ªæ•°ç»„å…ƒç´ 
   const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];

  // ==========================================
// é¼“åŠ±è¯­çŸ©é˜µ (50å¥)
// ==========================================
const MOTIVATIONAL_QUOTES = [
    // --- åŸºç¡€é¼“åŠ± (1-10) ---
    "Great start! ä¸€å°æ­¥ä¹Ÿæ˜¯è¿›æ­¥ï¼",
    "Keep going! ç»§ç»­åŠ æ²¹ï¼",
    "You are amazing! ä½ å¤ªæ£’äº†ï¼",
    "Wow! So smart! å“‡ï¼çœŸèªæ˜ï¼",
    "Awesome! å¤ªå‰å®³äº†ï¼",
    "You're on fire! ä½ ç°åœ¨åŠ¿ä¸å¯æŒ¡ï¼",
    "Fantastic! å¤ªå‡ºè‰²äº†ï¼",
    "Good job! åšå¾—å¥½ï¼",
    "Brilliant! å¾ˆæœ‰æ‰åï¼",
    "Keep it up! åšæŒä¸‹å»ï¼",

    // --- è¿›é˜¶é¼“åŠ± (11-20) ---
    "Unstoppable! è°ä¹ŸæŒ¡ä¸ä½ä½ ï¼",
    "Superb work! æå¥½çš„è¡¨ç°ï¼",
    "You're a natural! ä½ å¾ˆæœ‰å¤©èµ‹ï¼",
    "Outstanding! è¡¨ç°ä¼˜å¼‚ï¼",
    "Perfect score! æ»¡åˆ†è¡¨ç°ï¼",
    "Incredible progress! æƒŠäººçš„è¿›æ­¥ï¼",
    "You make it look easy! ä½ è®©å­¦ä¹ å˜å¾—å¥½ç®€å•ï¼",
    "Top notch! é¡¶å°–æ°´å¹³ï¼",
    "Victory is yours! èƒœåˆ©å±äºä½ ï¼",
    "Keep shining! ç»§ç»­é—ªè€€ï¼",

    // --- æŒ‘æˆ˜é¼“åŠ± (21-30) ---
    "Challenge accepted! æŒ‘æˆ˜æˆåŠŸï¼",
    "Way to go! å°±è¯¥è¿™ä¹ˆåšï¼",
    "Impressive! ä»¤äººå°è±¡æ·±åˆ»ï¼",
    "Knowledge is power! çŸ¥è¯†å°±æ˜¯åŠ›é‡ï¼",
    "Believe in yourself! ç›¸ä¿¡ä½ è‡ªå·±ï¼",
    "Hard work pays off! åŠªåŠ›ç»ˆæœ‰å›æŠ¥ï¼",
    "You're a superstar! ä½ æ˜¯ä¸ªå·¨æ˜Ÿï¼",
    "Never give up! æ°¸ä¸è¨€å¼ƒï¼",
    "Dream big! å¿—å­˜é«˜è¿œï¼",
    "Stay curious! ä¿æŒå¥½å¥‡å¿ƒï¼",

    // --- è¿›é˜¶æ™ºæ…§ (31-40) ---
    "Excellence is a habit! ä¼˜ç§€æ˜¯ä¸€ç§ä¹ æƒ¯ï¼",
    "Focus and win! ä¸“æ³¨å°±èƒ½èµ¢ï¼",
    "You're getting better! ä½ è¶Šæ¥è¶Šæ£’äº†ï¼",
    "Amazing effort! äº†ä¸èµ·çš„åŠªåŠ›ï¼",
    "High five! å‡»ä¸ªæŒå§ï¼",
    "You're the best! ä½ æ˜¯æœ€æ£’çš„ï¼",
    "Smart move! èªæ˜çš„é€‰æ‹©ï¼",
    "Genius at work! å¤©æ‰æ­£åœ¨åŠªåŠ›ï¼",
    "Bravo! å–å½©ï¼",
    "Pure gold! çº¯é‡‘èˆ¬çš„è¡¨ç°ï¼",

    // --- ç»ˆæå·…å³° (41-50) ---
    "Master status! å¤§å¸ˆçº§åˆ«ï¼",
    "Simply the best! ç®€ç›´æ˜¯æœ€å¥½çš„ï¼",
    "Legendary! ä¼ å¥‡èˆ¬çš„è¡¨ç°ï¼",
    "Beyond compare! æ— ä¸ä¼¦æ¯”ï¼",
    "The sky is the limit! æ½œåŠ›æ— é™ï¼",
    "You've got the power! ä½ å……æ»¡åŠ›é‡ï¼",
    "World class! ä¸–ç•Œçº§çš„è¡¨ç°ï¼",
    "Peak performance! å·…å³°çŠ¶æ€ï¼",
    "Simply wonderful! ç®€ç›´å¤ªç²¾å½©äº†ï¼",
    "The world is yours! ä¸–ç•Œå±äºä½ ï¼"
];


  // ... ä½ çš„ firebaseConfig åˆå§‹åŒ– ...
  // å¾ Firebase æ§åˆ¶å°è¤‡è£½ä½ çš„é…ç½®
  const firebaseConfig = {
    apiKey: "AIzaSyAiQ334fR19FoxA2y_BXhjA-33j3tW3svo",
    authDomain: "words-dddcd.firebaseapp.com",
    databaseURL: "https://words-dddcd-default-rtdb.firebaseio.com",
    projectId: "words-dddcd",
    storageBucket: "words-dddcd.firebasestorage.app",
    messagingSenderId: "78083720510",
    appId: "1:78083720510:web:2cd8ee255246cea774586f",
    measurementId: "G-L1MCW0108M"
  };
  
  // åˆå§‹åŒ– Firebase
  if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
  const auth = firebase.auth();
  const database = firebase.database();
  const syncToCloud = (name, count,avatar) => {
  const user = firebase.auth().currentUser;
  if (!user || !name) return;

  const userRef = firebase.database().ref('leaderboard/' + user.uid);
    
   // ä½¿ç”¨ update ç¡®ä¿åªæ›´æ–°åˆ†æ•°å’Œåå­—ï¼Œä¸ç ´åå…¶ä»–æ•°æ®
   userRef.update({
      name: name,
      score: count,
	    avatar: avatar || 'ğŸ§‘â€ğŸš€',
      lastUpdate: firebase.database.ServerValue.TIMESTAMP
    });
   };

const Leaderboard = (props) => {
  
    const [realPlayerCount, setRealPlayerCount] = React.useState(0);
    const learnedWords = props.learnedWords || window.learnedWords || [];

React.useEffect(() => {
    // æ¯æ¬¡ learnedWords å˜åŒ–æ—¶ï¼Œéƒ½å¼ºåˆ¶æ›´æ–°å…¨å±€å˜é‡
    window.learnedWords = learnedWords;
    console.log("Global words updated:", learnedWords.length);
}, [learnedWords]);


    const [displayList, setDisplayList] = React.useState([]);
    const [loading, setLoading] = React.useState(true);

    // è®¡ç®—æˆ‘çš„æ’å
    const myId = window.userId || 'me';
    // ä¼˜å…ˆä»å…¨å±€å…¨é‡æ•°æ®ä¸­æ‰¾ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±ç”¨å½“å‰æ˜¾ç¤ºçš„åˆ—è¡¨æ‰¾
    const fullData = window.globalLeaderboardData || displayList;
    const myRankIndex = fullData.findIndex(p => p.id === myId);

    // æœ€ç»ˆæ˜¾ç¤ºçš„åæ¬¡æ•°å­—ï¼ˆå¦‚æœæ²¡ä¸Šæ¦œï¼Œæ ¹æ®å•è¯é‡ç®—ä¸€ä¸ªå‡æ’åï¼‰
    const myRankNumber = myRankIndex !== -1 
        ? myRankIndex + 1 
        : Math.max(1, 99 - Math.floor(learnedWords.length / 5));

    React.useEffect(() => {
        // 1. è·å–æ’è¡Œæ¦œæ•°æ®ï¼ˆè¿™é‡Œæˆ‘ä»¬ç¨å¾®æ”¹ä¸€ä¸‹ï¼Œè·å–å‰20ä¸ªï¼Œç¡®ä¿æœ‰è¶³å¤Ÿæ•°æ®ï¼‰
        const rankRef = firebase.database().ref('leaderboard'); 
        const listener = rankRef.on('value', (snapshot) => {
            let realData = [];
            
            // ç»Ÿè®¡çœŸå®ç©å®¶
            if (snapshot.exists()) {
                setRealPlayerCount(snapshot.numChildren()); // è®°å½•çœŸå®æ€»äººæ•°
                
                snapshot.forEach((child) => {
                    realData.push({ id: child.key, ...child.val() });
                });
            } else {
                setRealPlayerCount(0);
            }

            // --- æ ¸å¿ƒé€»è¾‘ï¼šè™šæ‹Ÿæ•°æ®å¡«å…… ---
            let finalData = [...realData];

            // å¦‚æœçœŸå®æ•°æ®å°‘äº 10 æ¡ï¼Œå¼€å§‹é€ å‡
            if (finalData.length < 10) {
                const needed = 10 - finalData.length;
		// 1. è·å–ç°æœ‰çœŸå®ç©å®¶çš„åå­—é›†åˆï¼Œç”¨äºå½»åº•é¿é›·
    		const existingNames = new Set(finalData.map(p => p.name));
                
		// 2. å‡†å¤‡å¯ç”¨çš„è™šæ‹Ÿåå­—ï¼šè¿‡æ»¤æ‰å·²å­˜åœ¨çš„ï¼Œå¹¶éšæœºæ´—ç‰Œ
    		const availableNames = BOT_NAMES
       		 .filter(name => !existingNames.has(name))
        	.sort(() => Math.random() - 0.5); // éšæœºæ´—ç‰Œ	

                for (let i = 0; i < needed; i++) {
		    const botName = availableNames[i] || `Player_${i + 1}`;
                    finalData.push({
                        id: `bot_${i}_${Date.now()}`, // è™šæ‹ŸID
                        name: botName, // éšæœºåå­—
                        avatar: getRandomItem(AVATAR_OPTIONS), // éšæœºå¤´åƒ
                        score: getRandomScore(), // 100-200 éšæœºåˆ†
                        isBot: true // æ ‡è®°ä¸€ä¸‹ï¼ˆå¯é€‰ï¼Œç›®å‰UIä¸åŒºåˆ†ï¼‰
                    });
                }
            }

            // 2. ç»Ÿä¸€æ’åºï¼šæŒ‰åˆ†æ•°ä»é«˜åˆ°ä½
            // æ³¨æ„ï¼šå› ä¸ºFirebaseæ˜¯å‡åºï¼Œæ‰€ä»¥çœŸå®æ•°æ®å¯èƒ½éœ€è¦åè½¬ï¼Œ
            // ä½†è¿™é‡Œæ··åˆäº†éšæœºæ•°æ®ï¼Œæ‰€ä»¥å¿…é¡»é‡æ–° sort
            finalData.sort((a, b) => b.score - a.score);

            // 3. åªå–å‰ 10 åå±•ç¤º
            setDisplayList(finalData.slice(0, 10));
	    window.globalLeaderboardData = finalData;
            setLoading(false);
        });

        return () => rankRef.off('value', listener);
    }, []);

    return (
        <div className="bg-white/90 backdrop-blur-sm p-5 rounded-[36px] border-4 border-indigo-50 shadow-xl w-full">
            {/* æ ‡é¢˜æ  & æ€»äººæ•°å±•ç¤º */}
            <div className="flex flex-col items-center justify-center mb-5">
                <div className="flex items-center gap-2">
                    <span className="text-2xl animate-bounce">ğŸ†</span>
                    <h3 className="font-black text-indigo-600 text-lg tracking-wider">å­¦éœ¸æ’è¡Œæ¦œ</h3>
                </div>
                {/* å±•ç¤ºçœŸå®ç©å®¶æ•°é‡ï¼Œå¢åŠ ä¿¡ä»»æ„Ÿ */}
                <p className="text-xs font-bold text-slate-400 mt-1">
                    å·²æœ‰ <span className="text-indigo-500 text-sm">{realPlayerCount > 100 ? realPlayerCount : 100 + realPlayerCount}</span> ä½å°æœ‹å‹åŠ å…¥æŒ‘æˆ˜
                </p>
            </div>
            
            <div className="space-y-3">
                {loading ? (
                    <div className="text-center text-slate-400 py-4 font-bold">åŠ è½½æ’è¡Œæ¦œä¸­...</div>
                ) : displayList.map((player, index) => {
                  const isMe = player.id === myId;
    const rank = index + 1;

    // --- å®šä¹‰å‰ä¸‰åçš„ç‰¹æ®Šé¢œè‰² ---
    const getRankStyle = () => {
        if (rank === 1) return 'bg-amber-50 border-amber-200 shadow-amber-100'; // é‡‘è‰²è°ƒ
        if (rank === 2) return 'bg-rose-50 border-rose-200 shadow-rose-100';  // çº¢è‰²è‰²è°ƒ
        if (rank === 3) return 'bg-emerald-50 border-emerald-200 shadow-orange-100'; // ç»¿è‰²è°ƒ
        return isMe ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-100';
    };

    return (
        <div 
            key={player.id} 
            className={`flex items-center gap-4 p-4 rounded-[24px] transition-all mb-3 border-2
                ${getRankStyle()} 
                ${isMe ? 'ring-2 ring-indigo-500 ring-offset-2 scale-[1.02] z-10' : ''}
            `}
        >
            {/* 1. æ’åå›¾æ ‡ */}
            <div className="w-8 h-8 flex items-center justify-center">
                {rank === 1 ? <span className="text-3xl drop-shadow-sm">ğŸ¥‡</span> : 
                 rank === 2 ? <span className="text-3xl drop-shadow-sm">ğŸ¥ˆ</span> : 
                 rank === 3 ? <span className="text-3xl drop-shadow-sm">ğŸ¥‰</span> : 
                 <span className="font-black text-slate-400 italic">#{rank}</span>}
            </div>

            {/* 2. å¤´åƒ (å‰ä¸‰åå¤´åƒæ¡†å¤§ä¸€ç‚¹) */}
            <div className={`w-12 h-12 rounded-2xl flex items-center justify-center text-2xl shadow-sm
                ${rank === 1 ? 'bg-amber-400 text-white' : 
                  rank === 2 ? 'bg-rose-300 text-white' : 
                  rank === 3 ? 'bg-emerald-400 text-white' : 'bg-slate-100'}`}>
                {player.avatar}
            </div>

            {/* 3. åå­— */}
            <div className="flex-1">
                <div className="flex items-center gap-2">
                    <span className={`font-black ${rank <= 3 ? 'text-slate-900' : 'text-slate-700'}`}>
                        {player.name}
                    </span>
                    {isMe && (
                        <span className="bg-indigo-600 text-white text-[9px] px-1.5 py-0.5 rounded-md font-black">
                            YOU
                        </span>
                    )}
                </div>
                {/* å‰ä¸‰åçš„å°å¥–ç‰Œè¯´æ˜ */}
                {rank <= 3 && (
                    <span className="text-[10px] font-bold text-amber-600/70 uppercase tracking-widest">
                        {rank === 1 ? 'Top Performer' : rank === 2 ? 'Elite Student' : 'Rising Star'}
                    </span>
                )}
            </div>

            {/* 4. å•è¯æ•° */}
            <div className="text-right">
                <p className="font-black text-base text-slate-900 leading-none">
                    {player.score}
                </p>
                <p className="text-[9px] font-bold text-slate-400 uppercase mt-1">
                    Words
                </p>
            </div>
        </div>
    );
})}


</div>
        </div>
    );
};

        // å…¨å±€å™´æ³‰/é»ƒé‡‘é›¨å‡½æ•¸
        window.fireSuccessConfetti = (isGoldRain = false) => {
            if (typeof confetti !== 'function') return;
            const duration = isGoldRain ? 10 * 1000 : 2.5 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1000 };
            const randomInRange = (min, max) => Math.random() * (max - min) + min;

            const interval = setInterval(() => {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);
                const particleCount = isGoldRain ? 100 : 50;
                const colors = isGoldRain ? ['#FFD700', '#FFA500', '#FF8C00', '#FAE64D'] : undefined;
                confetti({ ...defaults, particleCount, colors, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
                confetti({ ...defaults, particleCount, colors, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
            }, 250);
        };


const TutorialLoader = ({ onFinish }) => {
    const [step, setStep] = React.useState(0);
    const [subState, setSubState] = React.useState(0);

    React.useEffect(() => {
        let stepTimer, subTimer1, subTimer2, scrollTimer;

        if (step === 0) {
            // Step 1: Learn - é¡ºåºï¼šApple -> è‹¹æœ -> âœ…
            setSubState(0);
            subTimer1 = setTimeout(() => setSubState(1), 1500); 
            subTimer2 = setTimeout(() => setSubState(2), 1500); 
            stepTimer = setTimeout(() => { setStep(1); setSubState(0); }, 3000);
        } else if (step === 1) {
            // Step 2: Play
            subTimer1 = setTimeout(() => setSubState(1), 1000);
            stepTimer = setTimeout(() => { setStep(2); setSubState(0); }, 2000);
        } else if (step === 2) {
            // Step 3: Explore - å¿«é€Ÿæ»šåŠ¨
            let count = 0;
            scrollTimer = setInterval(() => {
                count = (count + 1) % 4;
                setSubState(count);
            }, 800);
            stepTimer = setTimeout(() => { setStep(3); setSubState(0); }, 2000);
        } else {
            // Step 4: Finish
            if (window.fireSuccessConfetti) window.fireSuccessConfetti(false);
            stepTimer = setTimeout(onFinish, 3500);
        }

        return () => {
            clearTimeout(stepTimer);
            clearTimeout(subTimer1);
            clearTimeout(subTimer2);
            clearInterval(scrollTimer);
        };
    }, [step]);

    const steps = [
        { title: "Learn", color: "text-emerald-500", bg: "bg-emerald-50", icon: "ğŸ“–", btnColor: "bg-emerald-100", desc: "è®¤è¯†æ–°æœ‹å‹",subDesc: "æ­£é¢å¬å•è¯è¯»éŸ³ï¼Œåé¢çœ‹ä¸­æ–‡è§£é‡Š" },
        { title: "Play", color: "text-indigo-600", bg: "bg-indigo-50", icon: "ğŸ•¹ï¸", btnColor: "bg-indigo-100", desc: "çŒœçŒœæˆ‘æ˜¯è°",subDesc: "å¤ä¹ å·²æŒæ¡çš„å•è¯" },
        { title: "Explore", color: "text-amber-500", bg: "bg-amber-50", icon: "âš¡", btnColor: "bg-amber-100", desc: "æŒ‘æˆ˜è¯æ±‡é‡ï¼",subDesc: "è¯æ±‡é‡æµ‹è¯•" },
        { title: "Let's Go!", color: "text-rose-500", bg: "bg-white", icon: "ğŸ‰", btnColor: "bg-rose-100", desc: "å‡†å¤‡å¥½äº†å—ï¼Ÿ" }
    ];

    const current = steps[step];

    return (
        <div className={`fixed inset-0 z-[1000] flex flex-col items-center justify-center p-6 transition-colors duration-700 ${current.bg}`}>
            <div className="text-center mb-8">
                <h1 className={`text-5xl font-black ${current.color} mb-2`}>{current.title}</h1>
                <p className="text-slate-500 font-bold text-lg">{current.desc}</p>
            </div>

            <div className="relative w-full max-w-[320px] h-[440px] bg-white rounded-[40px] shadow-2xl border-4 border-white overflow-hidden flex flex-col">
                {step === 3 ? (
                    <div className="w-full h-full flex flex-col items-center justify-center p-6">
                        <div className="w-44 h-44 bg-slate-50 rounded-full shadow-inner flex items-center justify-center mb-8 overflow-hidden border-4 border-indigo-50">
                            <img src="https://www.stevesplayground.online/game/1000words/logo/small_steve.png" className="w-full h-full object-contain" 
                                 onError={(e) => { e.target.style.display='none'; e.target.parentNode.innerHTML='<span style="font-size:70px">ğŸš€</span>'; }} />
                        </div>
                        <div className="flex gap-4 mb-10 font-black text-lg">
                            <span className="text-emerald-500">Learn</span>
                            <span className="text-amber-500">Play</span>
                            <span className="text-indigo-600">Explore</span>
                            <span className="text-rose-500">Fun</span>
                        </div>
                        <button onClick={onFinish} className="bg-indigo-600 text-white text-2xl font-black px-12 py-4 rounded-full shadow-xl animate-bounce">GO!</button>
                    </div>
                ) : (
                    <>
                        <div className={`h-[140px] ${current.btnColor} flex items-center justify-center relative border-b-4 border-white`}>
                            <div className="w-20 h-20 bg-white rounded-[24px] shadow-sm flex items-center justify-center text-4xl relative">
                                {current.icon}
                                {((step !== 2 && subState === 0) || (step === 2)) && <div className="hand-simple top-10 left-10">ğŸ‘†</div>}
                            </div>
                        </div>
                        <div className="flex-1 relative flex items-center justify-center bg-slate-50 p-6">
                            {step === 0 && (
                                <div className={`relative w-48 h-64 rounded-[32px] shadow-lg border-2 flex flex-col items-center justify-center transition-all duration-700 ${subState >= 1 ? 'bg-indigo-600 border-indigo-500' : 'bg-white border-slate-100'}`}>
                                    <div className={`absolute inset-0 flex flex-col items-center justify-center transition-all duration-500 ${subState >= 1 ? 'opacity-0 scale-75' : 'opacity-100 scale-100'}`}>
                                        <div className="text-7xl mb-4 animate-float">ğŸ</div>
                                        <div className="text-3xl font-black text-slate-800">Apple</div>
                                    </div>
                                    <div className={`absolute inset-0 flex flex-col items-center justify-center text-white transition-all duration-500 ${subState >= 1 ? 'opacity-100 scale-100' : 'opacity-0 scale-90'}`}>
                                        <div className="text-5xl font-black mb-6">è‹¹æœ</div>
                                        <div className={`w-14 h-14 bg-emerald-400 rounded-full flex items-center justify-center text-3xl shadow-lg border-4 border-white transition-all duration-500 ${subState === 2 ? 'scale-100 opacity-100' : 'scale-0 opacity-0'}`}>âœ…</div>
                                    </div>
                                    {subState === 2 && <div className="hand-simple bottom-4 right-4 animate-bounce">ğŸ‘†</div>}
                                </div>
                            )}
                            {step === 1 && (
                                <div className="w-full">
                                    <div className="flex justify-center mb-4 text-6xl animate-bounce">ğŸ˜</div>
                                    <div className="grid grid-cols-2 gap-3">
                                        {['Cat', 'Elephant', 'Dog', 'Ant'].map((opt, i) => (
                                            <div key={i} className={`h-10 rounded-xl flex items-center justify-center text-xs font-black border-2 transition-colors ${opt === 'Elephant' && subState === 1 ? 'bg-emerald-400 text-white border-emerald-400' : 'bg-white text-slate-400 border-slate-200'}`}>{opt}</div>
                                        ))}
                                    </div>
                                    {subState === 1 && <div className="hand-simple top-20 right-10">ğŸ‘†</div>}
                                </div>
                            )}
                           
{/* --- Step 3: Explore æ»šåŠ¨æ¼”ç¤º --- */}
                            {step === 2 && (
                                <div className="flex flex-col items-center w-full">
                                    <div className="w-full h-40 bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center relative overflow-hidden">
                                        
                                        {/* 1. Emoji æ»šåŠ¨å±‚ */}
                                        <div className="h-20 flex items-center justify-center w-full relative">
                                            {['ğŸ¦', 'ğŸ¯', 'ğŸ’', 'ğŸ¼'].map((emoji, i) => (
                                                <span key={i} className={`absolute text-6xl transition-all duration-500 ease-in-out ${
                                                    subState === i ? 'translate-x-0 opacity-100' : 
                                                    subState > i ? 'translate-x-[-150%] opacity-0' : 'translate-x-[150%] opacity-0'
                                                }`}>
                                                    {emoji}
                                                </span>
                                            ))}
                                        </div>

                                        {/* 2. è‹±æ–‡å•è¯æ»šåŠ¨å±‚ */}
                                        <div className="h-10 flex items-center justify-center w-full relative">
                                            {['lion', 'tiger', 'monkey', 'panda'].map((word, i) => (
                                                <span key={i} className={`absolute text-xl font-black uppercase tracking-widest text-indigo-500 transition-all duration-500 ease-in-out ${
                                                    subState === i ? 'translate-x-0 opacity-100' : 
                                                    subState > i ? 'translate-x-[-150%] opacity-0' : 'translate-x-[150%] opacity-0'
                                                }`}>
                                                    {word}
                                                </span>
                                            ))}
                                        </div>

                                        {/* è¿›åº¦å°ç‚¹ */}
                                        <div className="absolute bottom-3 flex gap-1.5">
                                            {[0, 1, 2, 3].map(i => (
                                                <div key={i} className={`h-1.5 rounded-full transition-all duration-300 ${subState === i ? 'w-4 bg-indigo-400' : 'w-1.5 bg-slate-200'}`} />
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </>
                )}
            </div>

            {/* åº•éƒ¨æ­¥éª¤è¿›åº¦æ¡ */}
            <div className="mt-10 flex gap-2">
                {[0, 1, 2, 3].map(i => (
                    <div key={i} className={`h-2 rounded-full transition-all duration-500 ${step === i ? 'w-8 ' + current.color.replace('text', 'bg') : 'w-2 bg-slate-200'}`}></div>
                ))}
            </div>
        </div>
    );
};	

const App = () => {


   const [view, setView] = React.useState('menu');
   const [showVoiceMenu, setShowVoiceMenu] = React.useState(false);
   const [voicePreference, setVoicePreference] = React.useState('us-female');
   const [showLeaderboard, setShowLeaderboard] = useState(false);
   const openMedals = () => {
    	 setView('medals');
	};

   const [currentLevel, setCurrentLevel] = useState('1');
   const [idx, setIdx] = useState(0);
   const [currentList, setCurrentList] = useState([]);
   const currentKey = currentList[idx];

   // --- âœ… ç²˜è´´è¿™é‡Œï¼šæ–°å¢çš„æ˜Ÿæ˜Ÿå’Œè¿›åº¦çŠ¶æ€ ---
   const [showStageClear, setShowStageClear] = React.useState(false); 
   const WORDS_PER_STAGE = 20; 
   const TOTAL_WORDS = 100;    
    
  // è®¡ç®—å½“å‰æ˜Ÿæ˜Ÿæ•°é‡ (0-5)
  // æ³¨æ„ï¼šè¿™é‡Œç”¨ idx + 1 å› ä¸ºç´¢å¼•æ˜¯ä» 0 å¼€å§‹çš„
   const currentStars = Math.floor((idx + 1) / WORDS_PER_STAGE);

   const [flipped, setFlipped] = useState(false);
   const [testFeedback, setTestFeedback] = useState(null);
   const [isChecking, setIsChecking] = useState(false);
   const [userName, setUserName] = useState(() => localStorage.getItem('steve_name') || '');
	 const [userAvatar, setUserAvatar] = useState(() => localStorage.getItem('steve_avatar') || 'ğŸ§’');
   const [showNameModal, setShowNameModal] = useState(!localStorage.getItem('steve_name'));
   const [tempName, setTempName] = useState(localStorage.getItem('steve_name') || '');
            
   const [learnedWords, setLearnedWords] = useState(() => JSON.parse(localStorage.getItem('steve_learned') || '[]'));
   const [wrongWords, setWrongWords] = useState(() => JSON.parse(localStorage.getItem('steve_wrong') || '[]'));
   const [highScore, setHighScore] = useState(() => parseInt(localStorage.getItem('steve_highscore')) || 0);
            
    // 3. æ‰“å¡å¤©æ•¸ä¿®å¾©é‚è¼¯
   const [streak, setStreak] = useState(() => parseInt(localStorage.getItem('steve_streak')) || 0);

   const [isChallenge, setIsChallenge] = useState(false);
   const [isWrongSetMode, setIsWrongSetMode] = useState(false);
	  const [isTest, setIsTest] = React.useState(false);
            
   const [score, setScore] = useState(0);
   const [showGameOver, setShowGameOver] = useState(false);
   const [currentQuote, setCurrentQuote] = useState("");

   const [shuffledOptions, setShuffledOptions] = useState([]);
            

   const touchStart = useRef(null);
	
   const [showTutorial, setShowTutorial] = React.useState(() => {
        try {
            // å¦‚æœæœ¬åœ°å­˜å‚¨é‡Œæ²¡æœ‰æ ‡è®°ä¸º 'true'ï¼Œåˆ™æ˜¾ç¤ºæ•™ç¨‹
            return localStorage.getItem('steve_tutorial_done') !== 'true';
           } catch (e) {
            return true; // å®¹é”™å¤„ç†
           }
        });


    const handleCloseTutorial = () => {
      setShowTutorial(false);
      // âœ… è®°å½•åˆ°æœ¬åœ°å­˜å‚¨ï¼Œæœ‰æ•ˆæœŸæ˜¯æ°¸ä¹…ï¼ˆé™¤éæ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼‰
      localStorage.setItem('tutorialCompleted', 'true');
    };

    const handleTutorialFinish = () => {
        // 1. è®¾ç½®æ ‡è®°åˆ°æœ¬åœ°å­˜å‚¨ (Key å¿…é¡»å’Œä¸Šé¢ useState é‡Œçš„ä¸€æ ·)
        localStorage.setItem('steve_tutorial_done', 'true');
        // 2. å…³é—­å¼•å¯¼ç•Œé¢
        setShowTutorial(false);
    };
	
   
    useEffect(() => {
      const warmup = () => {
        const synth = window.speechSynthesis;
        // å¼ºåˆ¶åˆ·æ–°éŸ³è‰²åˆ—è¡¨å¹¶å‘å‡ºä¸€ä¸ªé™éŸ³ç‰‡æ®µ
        synth.getVoices();
        const u = new SpeechSynthesisUtterance("");
        u.volume = 0;
        synth.speak(u);
        
        // æˆåŠŸè§¦å‘åç«‹å³ç§»é™¤ç›‘å¬ï¼Œä¸å ç”¨èµ„æº
        window.removeEventListener('touchstart', warmup);
        window.removeEventListener('click', warmup);
      };
      window.addEventListener('touchstart', warmup, { once: true });
      window.addEventListener('click', warmup, { once: true });
      }, []);

            
      // --- âœ… ä¿®å¤ 1: ä½¿ç”¨ useMemo åªåˆ›å»ºä¸€æ¬¡éŸ³é¢‘å¯¹è±¡ï¼Œå¹¶ä¿®æ­£ URL è·¯å¾„ ---

    const audioClips = useMemo(() => {
    // åŸºç¡€è·¯å¾„
        const baseUrl = 'https://www.stevesplayground.online/game/1000words/music';
    
    return {
        wrong: new Audio(`${baseUrl}/wrong.mp3`),
        correct: new Audio(`${baseUrl}/correct.mp3`),
        star: new Audio(`${baseUrl}/star.mp3`),
        finish: new Audio(`${baseUrl}/finish.mp3`)
        };
      }, []); // ç©ºæ•°ç»„ç¡®ä¿åªåˆå§‹åŒ–ä¸€æ¬¡

    // é¢„åŠ è½½éŸ³é¢‘ï¼Œé¿å…ç¬¬ä¸€æ¬¡æ’­æ”¾å»¶è¿Ÿ
  useEffect(() => {
    Object.values(audioClips).forEach(audio => {
        audio.preload = 'auto';
        audio.load(); // å¼ºåˆ¶æµè§ˆå™¨æå‰è¯·æ±‚èµ„æº
      });
  }, [audioClips]);

    // --- âœ… ä¿®å¤ 2: ç§»é™¤ setTimeout ä»¥å…¼å®¹ iOSï¼Œå¢åŠ é”™è¯¯å¤„ç† ---
  const playSound = (type) => {
    const sound = audioClips[type];
    
    if (sound) {
        // 1. å°è¯•é‡ç½®è¿›åº¦
        sound.currentTime = 0;
        
        // 2. ç›´æ¥æ’­æ”¾ (ä¸è¦ç”¨ setTimeoutï¼Œå¦åˆ™ iOS ä¼šæ‹¦æˆª)
        const playPromise = sound.play();
        
        // 3. æ•è·æ’­æ”¾é”™è¯¯ (é€šå¸¸æ˜¯å› ä¸ºæ²¡æœ‰ç”¨æˆ·äº¤äº’æˆ–èµ„æºæœªåŠ è½½)
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.warn(`æ’­æ”¾ ${type} éŸ³æ•ˆå¤±è´¥:`, error);
                // æŸäº›æ—§ç‰ˆæµè§ˆå™¨å¯èƒ½éœ€è¦é‡æ–° load æ‰èƒ½é‡æ’­
                if (error.name === 'NotAllowedError') {
                     console.log("æµè§ˆå™¨é˜»æ­¢äº†è‡ªåŠ¨æ’­æ”¾ï¼Œéœ€è¦ç”¨æˆ·ç‚¹å‡»");
                }
            });
        }
    } else {
        console.error(`æœªæ‰¾åˆ°éŸ³æ•ˆç±»å‹: ${type}`);
    }
  };

  // åœ¨ App ç»„ä»¶é¡¶éƒ¨å®šä¹‰ä¸€ä¸ªå˜é‡ï¼ˆæˆ–ä½¿ç”¨ useRefï¼‰
  const isSpeakingRef = React.useRef(false);

  // ä¿®æ”¹ speak å‡½æ•°å®šä¹‰ï¼Œå¢åŠ ç¬¬äºŒä¸ªå‚æ•° preferenceOverride
  const speak = (text, preferenceOverride = null) => {
    if (!text) return;
    const synth = window.speechSynthesis;
    synth.cancel(); 

    const utter = new SpeechSynthesisUtterance(text);
    
    // å…³é”®ç‚¹ï¼šä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰æ‰ç”¨ state é‡Œçš„çŠ¶æ€
    const currentPref = preferenceOverride || voicePreference;

    const performSpeak = () => {
        const voices = synth.getVoices();
        let target;
        
        if (currentPref === 'us-male') {
            target = voices.find(v => /male|david|guy|nathan/i.test(v.name) && /en-US/.test(v.lang));
            utter.pitch = 0.8;
        } else if (currentPref === 'uk-female') {
            target = voices.find(v => /female|en-GB|google uk/i.test(v.name) && /en-GB/.test(v.lang));
            utter.pitch = 1.0;
        } else {
            target = voices.find(v => /samantha|aria|zira|susan|female/i.test(v.name) && /en-US/.test(v.lang))
                     || voices.find(v => /en-US/i.test(v.lang) && !/male/i.test(v.name));
            utter.pitch = 1.0;
        }

        if (target) utter.voice = target;
        utter.lang = currentPref === 'uk-female' ? 'en-GB' : 'en-US';
        utter.rate = 0.9;
        synth.speak(utter);
    };

    if (synth.getVoices().length === 0) {
        synth.onvoiceschanged = performSpeak;
    } else {
        performSpeak();
    }
};

const getStageInfo = () => {
    // è¿‡æ»¤å‡ºå½“å‰å…³å¡å·²å­¦ä¼šçš„å•è¯æ•°é‡
    const levelWordKeys = Object.keys(dbData[currentLevel]?.words || {});
    const count = learnedWords.filter(w => levelWordKeys.includes(w)).length;
    
    // è®¡ç®—å½“å‰æ˜¯ç¬¬å‡ ä¸ª 20 è¯é˜¶æ®µ (1-5)
    const stage = Math.min(Math.floor(count / 20), 5);
    const index = Math.max(stage - 1, 0); // æ•°ç»„ç´¢å¼• 0-4
    
    return {
        count,
        stage, // å½“å‰æ‹¿åˆ°äº†å‡ é¢—æ˜Ÿ
        emoji: (MISSION_REWARDS[currentLevel] || MISSION_REWARDS[1])[index]
    };
};

const getMyRank = () => {
    // ä¼˜å…ˆè¯»å–å…¨å±€åŒæ­¥çš„æ•°æ®
    const leaderboard = window.globalLeaderboardData;
    const myId = window.userId || 'me'; // ç¡®ä¿ä½ æœ‰ç”¨æˆ·ID

    if (leaderboard && leaderboard.length > 0) {
        // åœ¨å®Œæ•´åˆ—è¡¨ä¸­å¯»æ‰¾å½“å‰ç”¨æˆ·çš„æ’å
        const myIndex = leaderboard.findIndex(user => user.id === myId);
        return myIndex !== -1 ? `${myIndex + 1}` : "99+";
    }

    // å…œåº•ï¼šå¦‚æœæ•°æ®è¿˜æ²¡åŠ è½½å¥½ï¼Œæ˜¾ç¤ºåŸºäºå•è¯é‡çš„è™šæ‹Ÿæ’å
    const count = (Array.isArray(learnedWords) ? learnedWords : []).length;
    return `${Math.max(1, 99 - Math.floor(count / 5))}`;
};


// è‡ªåŠ¨è¯†åˆ«å¹¶æ¸²æŸ“ Emoji æˆ– å›¾ç‰‡
const renderMedia = (source, sizeClass = "text-[120px]") => {
    if (!source) return null;
    const strSource = String(source).trim();
    const isImage = strSource.includes('/') || strSource.includes('.');

    if (isImage) {
        return (
            <div className="w-[120px] h-[120px] flex items-center justify-center animate-float">
                <img 
                    src={strSource} 
                    className="max-w-full max-h-full object-contain pointer-events-none" 
                    style={{ filter: 'drop-shadow(0 4px 6px rgba(0,0,0,0.1))' }} 
                />
            </div>
        );
    }

    // --- Emoji é€»è¾‘ä¼˜åŒ– ---
    // ä½¿ç”¨ Array.from å‡†ç¡®è®¡ç®—è§†è§‰ Emoji æ•°é‡
    const emojiCount = Array.from(strSource).length;    
    
    // ç»†åŒ–å­—å·é˜¶æ¢¯ï¼š
    // 1-2ä¸ª: 120px
    // 3ä¸ª: 80px
    // 4ä¸ª: 65px
    // 5ä¸ªåŠä»¥ä¸Š: 50px
    let fontSize = '120px';
    if (emojiCount === 3) fontSize = '80px';
    else if (emojiCount === 4) fontSize = '65px';
    else if (emojiCount > 4) fontSize = '50px';

    return (
        <span 
            className="animate-float transition-all duration-300 inline-block whitespace-nowrap" 
            style={{ 
                fontSize, 
                lineHeight: '1',
                textAlign: 'center',
                maxWidth: '100%' // ç¡®ä¿ä¸ä¼šè¶…å‡ºå¡ç‰‡è¾¹ç•Œ
            }}
        >
            {strSource}
        </span>
    );
};
			
            const dbData = window.DB || (typeof DB !== 'undefined' ? DB : null);
	    const [isDataLoading, setIsDataLoading] = React.useState(true);



            const fullList = useMemo(() => {
                if (!dbData) return [];
                let all = [];
                Object.values(dbData).forEach(lvl => { all = all.concat(Object.keys(lvl.words)); });
                return all;
            }, [dbData]);

            

            // 4. è‡ªå‹•è¨ˆç®—æ‰“å¡å¤©æ•¸
            useEffect(() => {
                const lastDate = localStorage.getItem('steve_last_date');
                const today = new Date().toDateString();
                
                if (lastDate !== today) {
                    const newStreak = streak + 1;
                    setStreak(newStreak);
                    localStorage.setItem('steve_streak', newStreak.toString());
                    localStorage.setItem('steve_last_date', today);
                }
            }, []);

            // ç›£è½ç”Ÿå­˜æ¨¡å¼çµæŸè§¸ç™¼é»ƒé‡‘é›¨
            useEffect(() => {
                if (showGameOver) {
                    const isMaster = isChallenge && score >= 1000;
                    window.fireSuccessConfetti(isMaster);
                }
            }, [showGameOver, isChallenge, score]);

            const handleTouchStart = (e) => { touchStart.current = e.touches[0].clientX; };
            const handleTouchEnd = (e) => {
                if (!touchStart.current || view !== 'card') return;
                const distance = touchStart.current - e.changedTouches[0].clientX;
                if (distance > 50) handleNext();
                else if (distance < -50) handlePrev();
                touchStart.current = null;
            };

          const handleNext = () => {
    const levelWords = Object.keys(dbData[currentLevel].words);
    const learnedInLevel = learnedWords.filter(w => levelWords.includes(w)).length;
    
    // 1. æ ¸å¿ƒä¿®å¤ï¼šä¸€æ—¦è¾¾åˆ° 100ï¼Œç«‹å³å¼ºåˆ¶å¤„ç†ï¼Œä¸è®©å®ƒè¿› idx + 1 çš„é€»è¾‘
    if (learnedInLevel >= 100) {
        triggerStars();
        setTimeout(triggerStars, 500);
        playSound('finish');
        setShowGameOver(true); // å¼¹çª—æç¤ºï¼šä½ å·²å­¦å®Œæœ¬å…³ 100 è¯
        return; // æ‹¦æˆªï¼Œä¸æ‰§è¡Œåç»­ä»£ç 
    }

    // 2. åŸæœ‰çš„æ­£å¸¸ç¿»é¡µé€»è¾‘
    if (idx < currentList.length - 1) {
        // è¿˜æ²¡åˆ°æœ€åä¸€å¼ ï¼Œæ­£å¸¸ä¸‹ä¸€å¼ 
        setFlipped(false);
        setIdx(prev => prev + 1);
    } else {
        // èµ°åˆ°äº†æ•°ç»„æœ«å°¾ï¼ˆå¯èƒ½æ˜¯è¯åº“é‡Œä¸æ»¡ 100 ä¸ªçš„æƒ…å†µï¼‰
        setFlipped(false);
        setIdx(0); // å›åˆ°ç¬¬ä¸€å¼ 
    }
};
            const handlePrev = () => { if (idx > 0) { setFlipped(false); setIdx(prev => prev - 1); } };

            const resetProgress = () => {
                if (confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰é€²åº¦å—ï¼Ÿæ‰“å¡å¤©æ•¸ä¹Ÿå°‡æ­¸é›¶ã€‚")) {
                    setLearnedWords([]); setWrongWords([]); setHighScore(0); setStreak(0);
                    localStorage.clear();
                    window.location.reload();
                }
            };

           
useEffect(() => {
    // 1. æœ¬åœ°å­˜å‚¨é€»è¾‘
    localStorage.setItem('userName', userName); // ç¡®ä¿è¿™é‡Œç”¨äº†ä½ æ”¹ååçš„ key
    localStorage.setItem('steve_learned', JSON.stringify(learnedWords));
    localStorage.setItem('steve_wrong', JSON.stringify(wrongWords));
    localStorage.setItem('steve_highscore', highScore.toString());
    localStorage.setItem('steve_avatar', userAvatar);

    // 2. äº‘ç«¯åŒæ­¥é€»è¾‘ï¼ˆå¸¦é˜²æŠ–ï¼‰
    const handler = setTimeout(() => {
        if (userName && learnedWords.length > 0) {
            // ç¡®ä¿ syncToCloud å‡½æ•°å·²åœ¨å¤–éƒ¨å®šä¹‰
            syncToCloud(userName, learnedWords.length, userAvatar);
        }
    }, 2000);

    // 3. æ¸…é™¤å‡½æ•°ï¼ˆè¿™æ˜¯å…³é”®ï¼Œæ£€æŸ¥è¿™é‡Œçš„æ‹¬å·æ˜¯å¦é—­åˆæ­£ç¡®ï¼‰
    return () => {
        clearTimeout(handler);
    }; 
}, [learnedWords, wrongWords, highScore, userAvatar, userName]); 

useEffect(() => {
                if (currentKey && fullList.length > 0) {
                    const distractors = fullList.filter(k => k !== currentKey).sort(() => 0.5 - Math.random()).slice(0, 3);
                    setShuffledOptions([currentKey, ...distractors].sort(() => 0.5 - Math.random()));
                    setTestFeedback(null);
                }
            }, [currentKey, currentList, fullList]);



    const handleChoice = (choice) => {
    if (testFeedback) return;
    
    const currentKey = currentList[idx];

    if (choice === currentKey) {
        // --- ç­”å°äº† ---
        speak(currentKey);
        setTestFeedback('correct');
        
        if (!learnedWords.includes(currentKey)) {
            setLearnedWords(prev => [...prev, currentKey]);
        }

        setTimeout(() => {
            setTestFeedback(null);
            
            if (isChallenge) {
                // Survival æ¨¡å¼
                const newScore = score + 1;
                setScore(newScore);
		if (newScore > highScore) {
                    setHighScore(newScore);
                    // æ³¨æ„ï¼šä½ ç°æœ‰çš„ useEffect ä¼šè‡ªåŠ¨å°† highScore åŒæ­¥ä¿å­˜åˆ° localStorage
                }
                const nextWord = fullList[Math.floor(Math.random() * fullList.length)];
                const newList = [...currentList, nextWord];
                setCurrentList(newList);
                setIdx(idx + 1);
                localStorage.setItem('survival_score', newScore);
                localStorage.setItem('survival_list', JSON.stringify(newList));
            } else {
                // --- Test æ¨¡å¼ï¼šç¢ºä¿è·³è½‰ ---
                const nextIdx = idx + 1;
                if (nextIdx < currentList.length) {
                    setIdx(nextIdx);
                } else {
                    // å…¨é—œå®Œæˆ
                    playSound('finish');
                    setShowGameOver(true);
                }
            }
        }, 800); 

    } else {
        // --- ç­”éŒ¯äº† ---
        setTestFeedback('wrong');
        playSound('wrong');
        if (!wrongWords.includes(currentKey)) {
            setWrongWords(prev => [...prev, currentKey]);
        }

        if (isChallenge) {
            localStorage.removeItem('survival_score');
            localStorage.removeItem('survival_list');
            setTimeout(() => {triggerStars();playSound('finish');setShowGameOver(true)}, 600);
        } else {
            setTimeout(() => setTestFeedback(null), 600);
        }
    }
};

const triggerStars = () => {
    // æ£€æŸ¥åº“æ˜¯å¦åŠ è½½
    if (typeof confetti === 'undefined') return;

    // å–·å°„æ˜Ÿæ˜Ÿ
    const defaults = {
        spread: 360,
        ticks: 50,
        gravity: 0.5,
        decay: 0.94,
        startVelocity: 30,
        colors: ['#FFE400', '#FFBD00', '#E89400', '#FFCA6C', '#FDFFB8']
    };

    function shoot() {
        confetti({
            ...defaults,
            particleCount: 40,
            scalar: 1.2,
            shapes: ['star'] // å…³é”®ï¼šè®¾ç½®ä¸ºæ˜Ÿå½¢
        });

        confetti({
            ...defaults,
            particleCount: 10,
            scalar: 0.75,
            shapes: ['heart']
        });
    }

    // è¿ç»­å–·å°„ä¸¤æ¬¡ï¼Œå¢åŠ å±‚æ¬¡æ„Ÿ
    setTimeout(shoot, 0);
    setTimeout(shoot, 100);
    setTimeout(shoot, 200);
};

useEffect(() => {
    			   if (showLeaderboard) {
        			document.body.style.overflow = 'hidden';
   				 } else {
        			document.body.style.overflow = 'unset';
    				}
			       }, [showLeaderboard]);



            const startMode = (mode, levelId = '1') => {
                // 1. åˆå§‹åŒ–æ‰€æœ‰çŠ¶æ€
                setIsChallenge(false); 
                setIsWrongSetMode(false); 
		setIsTest(false);
                setIdx(0); 
                setFlipped(false); 
                setTestFeedback(null);
                setShowGameOver(false);
		setShowStageClear(false);

                if (!dbData || !dbData[levelId]) return;
                playSound('correct');
                
                if (mode === 'card') {
                    // è·å–è¯¥å…³å¡æ‰€æœ‰å•è¯
                    const allWords = Object.keys(dbData[levelId].words);
                    // è¿‡æ»¤æ‰å·²å­¦ä¼šçš„
                    const toLearn = allWords.filter(k => !learnedWords.includes(k));
		    const isLevelCompleted =  toLearn.length === 0;

                    // å¦‚æœå…¨å­¦å®Œäº†ï¼Œå°±å¤ä¹ å…¨éƒ¨ï¼Œå¦åˆ™åªå­¦æ²¡å­¦ä¼šçš„
                    setCurrentList(toLearn.length > 0 ? toLearn : allWords);
                    setCurrentLevel(levelId); 
                    
		    setIdx(0);          // ä»ç¬¬ 0 ä¸ªå•è¯å¼€å§‹
                    setShowStageClear(false);
		    setView('card');
                } 
                else if (mode === 'test') {
                    setIsChallenge(false);
		    setIsTest(true);

                    // 1. è·å–å½“å‰å…³å¡çš„æ‰€æœ‰å•è¯é”®
                    const allLevelWords = Object.keys(dbData[levelId].words);
                    const totalCount = allLevelWords.length;
                    
                    // 2. è¿‡æ»¤å‡ºå·²å­¦ä¼šçš„å•è¯
                    const learnedInLevel = allLevelWords.filter(k => learnedWords.includes(k));
                    const learnedCount = learnedInLevel.length;
                    
                    // 3. æ ¸å¿ƒé€»è¾‘ï¼šå­¦ä¼šæ•°é‡ä¸º 0 æˆ–ç­‰äºæ€»æ•°ï¼Œæµ‹è¯•å…¨éƒ¨ï¼›å¦åˆ™åªæµ‹è¯•å·²å­¦ä¼šçš„
                    const toTest = (learnedCount === 0 || learnedCount === totalCount) 
                        ? allLevelWords 
                        : learnedInLevel;

                    setCurrentList(toTest);
                    setCurrentLevel(levelId); 
                    setView('test');
                } 
                else if (mode === 'survival') {
                    setIsChallenge(true);
                    // å°è¯•ä»æœ¬åœ°æ¢å¤è¿›åº¦
                    const savedScore = parseInt(localStorage.getItem('survival_score')) || 0;
                    const savedList = JSON.parse(localStorage.getItem('survival_list') || '[]');
                    
                    if (savedScore > 0 && savedList.length > 0) {
                        // ç§»é™¤ confirmï¼Œç›´æ¥æ¢å¤è¿›åº¦
                        setScore(savedScore);
                        setCurrentList(savedList);
                        setIdx(savedList.length - 1); 
                        setView('test');
                        return;
                    }
                    
                    // é‡æ–°å¼€å§‹é€»è¾‘
                    setScore(0);
                    const firstWord = fullList[Math.floor(Math.random() * fullList.length)];
                    const newList = [firstWord];
                    setCurrentList(newList);
                    setIdx(0);
                    localStorage.setItem('survival_score', '0');
                    localStorage.setItem('survival_list', JSON.stringify(newList));
                    setView('test');
                } 
                else if (mode === 'wrong') {
                    if (wrongWords.length === 0) return alert('ç›®å‰æ²’æœ‰éŒ¯é¡Œï¼');
                    setIsWrongSetMode(true);
                    setCurrentList([...wrongWords].sort(() => Math.random() - 0.5));
                    setView('test');
                }


            };

if (showTutorial) {
        return <TutorialLoader onFinish={handleTutorialFinish} />;
    }


if (view === 'medals') {
    // é¢„å¤„ç†ï¼šç¡®ä¿ learnedWords å§‹ç»ˆæ˜¯æ•°ç»„ï¼Œé˜²æ­¢æŠ¥é”™
    const safeLearnedWords = Array.isArray(learnedWords) ? learnedWords : [];

    return (
        <div className="min-h-screen bg-slate-50 flex flex-col p-6 animate-in fade-in duration-300">
            {/* é¡¶éƒ¨æ ‡é¢˜æ  */}
            <div className="flex items-center justify-between mb-6">
                <button 
                    onClick={() => setView('menu')} 
                    className="w-10 h-10 bg-white rounded-2xl shadow-sm flex items-center justify-center text-slate-400 font-bold cursor-pointer active:scale-90 transition-all"
                >
                    âœ•
                </button>
                <h2 className="text-xl font-black text-slate-800 tracking-tight">æˆå°±å‹‹ç« å¢™</h2>
                <div className="w-10"></div>
            </div>

            {/* åˆ—è¡¨å®¹å™¨ - ä¿®æ­£äº† fw-full çš„æ‹¼å†™é”™è¯¯ */}
            <div className="w-full max-w-md mx-auto px-4 flex-1 overflow-y-auto pb-4">
               {Object.keys(MISSION_REWARDS).map((lvl) => {
    const rewards = MISSION_REWARDS[lvl];
    if (!rewards) return null;

    // 1. å°è¯•ä»æ‰€æœ‰å¯èƒ½çš„åœ°æ–¹æŠ“å–è¯åº“
    // è¿™é‡Œæˆ‘æŠŠ dbData ä¹ŸåŠ è¿›æ¥äº†
    const source = window.DB || (typeof dbData !== 'undefined' ? dbData : null);
    
    // 2. è·å–å½“å‰å…³å¡æ•°æ®
    const levelData = source ? (source[lvl] || source[parseInt(lvl)]) : null;
    
    // 3. æå–å•è¯
    const levelWords = levelData && levelData.words ? Object.keys(levelData.words) : [];
    
    // 4. è®¡ç®—è¿›åº¦
    const learnedInLevel = (Array.isArray(learnedWords) ? learnedWords : [])
        .filter(w => levelWords.includes(w)).length;

            
                    return (
                        <div key={lvl} className="bg-white rounded-[32px] p-5 shadow-sm border border-slate-100 flex items-center gap-4 mb-4 active:scale-[0.98] transition-all">
                            {/* å·¦ä¾§å¤§å‹‹ç«  */}
                            <div className={`w-20 h-20 rounded-[24px] flex items-center justify-center text-4xl shadow-inner transition-all ${learnedInLevel >= 100 ? 'bg-amber-50 animate-float' : 'bg-slate-50 grayscale opacity-20'}`}>
                                {rewards[4] || "ğŸ†"}
                            </div>

                            <div className="flex-1">
                                <div className="flex justify-between items-end mb-2">
                                    <div>
                                        <h3 className="font-black text-slate-800 text-sm leading-none">LEVEL {lvl}</h3>
                                        <p className="text-[10px] font-bold text-slate-400 mt-1 uppercase tracking-wider">{learnedInLevel}/100 WORDS</p>
                                    </div>
                                    <span className="text-[10px] font-black text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded-full">
                                        {Math.min(5, Math.floor(learnedInLevel / 20))}/5 Unlocked
                                    </span>
                                </div>

                                {/* 20è¯é˜¶æ¢¯å°å‹‹ç«  */}
                                <div className="flex gap-2 mt-2">
                                    {rewards.map((emoji, i) => {
                                        const threshold = (i + 1) * 20;
                                        const isStepUnlocked = learnedInLevel >= threshold;
                                        return (
                                            <div 
                                                key={i} 
                                                className={`w-9 h-9 rounded-full flex items-center justify-center text-base border-2 transition-all duration-500
                                                ${isStepUnlocked 
                                                    ? 'bg-gradient-to-br from-white to-indigo-50 border-indigo-200 shadow-md scale-110 opacity-100' 
                                                    : 'bg-slate-100 border-slate-200 opacity-20 grayscale' 
                                                }`}
                                            >
                                                {isStepUnlocked ? emoji : "ğŸ”’"}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    );
                })}
            </div>

            {/* åº•éƒ¨æ±‡æ€»å¡ç‰‡ */}
<div className="w-full max-w-md mx-auto bg-slate-900 rounded-[32px] p-6 text-white flex justify-between items-center shadow-2xl mb-4">
    <div className="flex items-center gap-4">
        <div className="w-12 h-12 bg-white/10 rounded-2xl flex items-center justify-center text-2xl shadow-inner">ğŸ†</div>
        <div>
            <p className="text-[10px] font-bold opacity-50 uppercase leading-none mb-1">Total Medals</p>
            <p className="text-xl font-black text-amber-400">
                {(() => {
                    // ä½¿ç”¨ç«‹å³æ‰§è¡Œå‡½æ•°æ¥è®¡ç®—æ€»æ•°ï¼Œç¡®ä¿é€»è¾‘æ¸…æ™°
                    let totalUnlocked = 0;
                    const dbData = window.DB || {};
                    const safeLearnedWords = Array.isArray(learnedWords) ? learnedWords : [];

                    Object.keys(MISSION_REWARDS).forEach(lvl => {
                        const levelData = dbData[lvl] || dbData[parseInt(lvl)];
                        if (levelData && levelData.words) {
                            const levelWordKeys = Object.keys(levelData.words);
                            // è®¡ç®—è¯¥å…³å¡å·²å­¦ä¼šå•è¯
                            const count = safeLearnedWords.filter(w => levelWordKeys.includes(w)).length;
                            // æ¯ 20 ä¸ªå•è¯ç®—ä¸€ä¸ªå‹‹ç« ï¼ˆæ¯å…³æœ€å¤š 5 ä¸ªï¼‰
                            totalUnlocked += Math.floor(Math.min(100, count) / 20);
                        }
                    });
                    return totalUnlocked;
                })()}
            </p>
        </div>
    </div>
    <button 
        onClick={() => setView('menu')} 
        className="bg-white text-slate-900 px-6 py-3 rounded-2xl font-black text-sm active:scale-95 hover:bg-slate-100 transition-all cursor-pointer"
    >
        è¿”å›ä¸»é¡µ
    </button>
</div>


        </div>
    );
}
            if (view === 'menu') {
                return (
                    <div className="max-w-md mx-auto p-6 relative">
                        {showNameModal && (
                            <div className="modal-overlay">
                                <div className="bg-white p-6 rounded-[48px] text-center w-full max-w-[340px] shadow-2xl">
                                    <h2 className="text-[22px] font-black mb-6 whitespace-nowrap tracking-tight">Hello! What's your name?</h2>

				{/* å¤´åƒé€‰æ‹©åŒº */}
                           	    <p className="text-xs font-bold text-slate-400 uppercase mb-2">é€‰æ‹©ä¸€ä¸ªå¤´åƒ</p>
                            	    <div className="grid grid-cols-4 gap-2 mb-6">
                                	{AVATAR_OPTIONS.map(emoji => (
                                    	<button 
                                        	key={emoji}
                                        	onClick={() => setUserAvatar(emoji)}
                                        	className={`text-3xl p-2 rounded-xl border-2 transition-all ${userAvatar === emoji ? 'bg-indigo-100 border-indigo-500 scale-110' : 'bg-slate-50 border-slate-100 hover:bg-white'}`}
                                     	>
                                        {emoji}
                                    </button>
                                ))}
                            	   </div>


                                    <input type="text" value={tempName} onChange={(e) => setTempName(e.target.value)} placeholder="Steve..." className="w-full bg-slate-50 border-2 border-slate-100 rounded-3xl py-4 px-6 mb-6 font-black text-center outline-none focus:border-indigo-200" />
                                    <button onClick={() => { setUserName(tempName); localStorage.setItem('steve_name', tempName); setShowNameModal(false); playSound('correct');setShowTutorial(false);
        localStorage.setItem('tutorialCompleted', 'true'); syncToCloud(tempName, learnedWords.length, userAvatar);
}} className="w-full bg-indigo-600 text-white py-5 rounded-[28px] font-black btn-active">Let's Go!</button>
                                </div>
                            </div>
                        )}
                        <header className="flex justify-between items-center mb-8 px-2 pt-4">
                            <div>
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Welcome back</p>
                                <h1 className="text-2xl font-black text-slate-800 tracking-tight">
                                    <span className="text-indigo-600">{userName || 'Steve'}'s</span> English Master
                                </h1>
				<button onClick={resetProgress} className="bg-white border border-slate-100 px-3 py-1 rounded-full text-[10px] font-black text-slate-400 shadow-sm btn-active uppercase">Reset</button>
                            </div>

			   
	{/* å³ä¾§ï¼šåŸ Reset çš„ä½ç½®ç°åœ¨æ”¾ç½® Voice Menu æŒ‰é’® */}
                <div className="relative">
                    <button 
                        onClick={() => setShowVoiceMenu(!showVoiceMenu)}
                        className={`w-12 h-12 rounded-full shadow-lg flex items-center justify-center transition-all duration-300 ${showVoiceMenu ? 'bg-slate-800 rotate-90' : 'bg-white text-slate-600 hover:scale-110'}`}
                    >
                        {showVoiceMenu ? <span className="text-white text-xl">âœ•</span> : <span className="text-2xl">âš™ï¸</span>}
                    </button>

                    {/* ä¸‹æ‹‰èœå•é€»è¾‘ä¿æŒä¸å˜ */}
                    {showVoiceMenu && (
                        <div className="absolute top-14 right-0 bg-white/95 backdrop-blur-md rounded-2xl shadow-xl border border-slate-100 p-2 w-44 flex flex-col gap-1 z-50">
                            <div className="text-[10px] font-black text-slate-400 px-3 py-2 uppercase tracking-widest border-b border-slate-50 mb-1">
                                Voice Accent
                            </div>
                            {[
                                { id: 'us-female', label: 'ğŸ‡ºğŸ‡¸ ç¾éŸ³', color: 'text-indigo-600' },
                              //  { id: 'us-male',   label: 'ğŸ§” ç¾éŸ³ç”·å£°', color: 'text-blue-600' },
                                { id: 'uk-female', label: 'ğŸ‡¬ğŸ‡§ è‹±éŸ³', color: 'text-rose-600' }
                            ].map(v => (
                                <button
                                    key={v.id}
                                    onClick={() => {
                                        setVoicePreference(v.id);
                                        setShowVoiceMenu(false);
                                        
                                        // é¢„çƒ­ä¸å‘éŸ³é€»è¾‘
                                        window.speechSynthesis.getVoices();
                                        const utterance = new SpeechSynthesisUtterance("");
                                        utterance.volume = 0;
                                        window.speechSynthesis.speak(utterance);

                                        setTimeout(() => {
                                            const cleanName = (userName || 'Steve').trim();
                                            // æ³¨æ„ï¼šHello å’Œ Hi åé¢åŠ äº†ç©ºæ ¼
                                            const testText = v.id === 'uk-female' ? `Hello ${cleanName}!` : `Hi ${cleanName}!`;
                                            speak(testText, v.id);
                                        }, 100);
                                    }}
                                    className={`flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-bold transition-all ${
                                        voicePreference === v.id 
                                        ? 'bg-slate-100 ' + v.color 
                                        : 'text-slate-600 hover:bg-slate-50'
                                    }`}
                                >
                                    <span className="text-xl">{v.label.split(' ')[0]}</span>
                                    <span>{v.label.split(' ')[1]}</span>
                                </button>
                            ))}
                        </div>
                    )}
                </div>
            </header>
                        
                        <div className="grid grid-cols-4 gap-2.5 mb-10">
    {/* 1. æ’è¡Œæ¦œ - é‡‡ç”¨æ¸å˜é‡‘æ„Ÿ */}
    <button 
        onClick={() => {
            if (window.playSound) playSound('star');
            setShowLeaderboard(true);
        }}
        className="relative overflow-hidden bg-gradient-to-b from-amber-50 to-white p-3 py-4 rounded-[28px] border border-amber-100 shadow-[0_4px_12px_-4px_rgba(251,191,36,0.3)] text-center active:scale-95 transition-all group"
    >
        <div className="absolute -right-1 -top-1 opacity-10 group-hover:scale-125 transition-transform">ğŸ¥‡</div>
        <p className="text-[9px] font-amber text-amber-600/60 uppercase mb-1 tracking-wider whitespace-nowrap">æ’è¡Œæ¦œ</p>
        <p className="text-xl font-black text-amber-600 flex items-center justify-center gap-0.5">{getMyRank()}ğŸ¥‡</p>
        <p className="text-[8px] font-bold text-amber-500 mt-1 leading-none bg-amber-100/50 py-0.5 rounded-full">Top 10 </p>
    </button>

    {/* 2. å·²å­¦ä¼š - æŸ”å’Œç´« */}
    <div onClick={() => setView('medals')} className="bg-gradient-to-b from-indigo-50 to-white p-3 py-4 rounded-[28px] border border-indigo-100 shadow-[0_4px_12px_-4px_rgba(79,70,229,0.2)] text-center cursor-pointer">

        <p className="text-[9px] font-black text-indigo-600/50 uppercase mb-1 tracking-wider whitespace-nowrap">å·²å­¸æœƒ</p>
        <p className="text-xl font-black text-indigo-600 flex items-center justify-center gap-0.5">
            {learnedWords.length}<span className="text-sm opacity-70">ğŸ“–</span>
        </p>
        <p className="text-[8px] font-bold text-ingido-500 mt-1 leading-none bg-indigo-100/50 py-0.5 rounded-full">Words</p>
    </div>

    {/* 3. æœ€é«˜åˆ† - å†·è‰³ç° */}
    <div className="bg-gradient-to-b from-slate-50 to-white p-3 py-4 rounded-[28px] border border-slate-100 shadow-[0_4px_12px_-4px_rgba(71,85,105,0.15)] text-center">
        <p className="text-[9px] font-black text-slate-400 uppercase mb-1 tracking-wider whitespace-nowrap">æœ€é«˜åˆ†</p>
        <p className="text-xl font-black text-slate-700">{highScore}<span className="text-sm opacity-70">ğŸ†</span>
</p>
        <p className="text-[8px] font-bold text-slate-500 mt-1 leading-none bg-slate-100/100 py-0.5 rounded-full">Best Score</p>
    </div>

    {/* 4. æ‰“å¡å¤©æ•° - æ´»åŠ›ç»¿ */}
    <div className="bg-gradient-to-b from-emerald-50 to-white p-3 py-4 rounded-[28px] border border-emerald-100 shadow-[0_4px_12px_-4px_rgba(16,185,129,0.2)] text-center group">
        <p className="text-[9px] font-black text-emerald-600/50 uppercase mb-1 tracking-wider whitespace-nowrap">æ‰“å¡</p>
        <p className="text-xl font-black text-emerald-500 flex items-center justify-center gap-0.5 transition-transform group-hover:bounce">
            {streak}<span className="text-sm">ğŸ”¥</span>
        </p>
        <p className="text-[8px] font-bold text-emerald-500 mt-1 leading-none bg-emerald-100/50 py-0.5 rounded-full">Days</p>
    </div>
</div>
			

                        <div className="space-y-4">
                            {dbData && Object.entries(dbData).map(([id, data]) => {
                                const total = Object.keys(data.words).length;
                                const done = Object.keys(data.words).filter(w => learnedWords.includes(w)).length;
                                return (
                                    <div key={id} className="bg-white p-5 rounded-[36px] border border-slate-50 flex items-center shadow-sm overflow-hidden">
                                        <div className="w-14 h-14 shrink-0 bg-indigo-50/50 rounded-2xl flex items-center justify-center text-3xl mr-4 relative">{data.levelEmoji}</div>
                                        <div className="flex-1">
                                            <h3 className="font-black text-slate-700 text-base">{data.levelName}</h3>
                                            <div className="flex items-center gap-3 mt-2">
                                                <div className="flex-1 bg-slate-100 h-2 rounded-full overflow-hidden">
                                                    <div className="bg-indigo-400 h-full transition-all duration-1000" style={{width: `${(done/total)*100}%`}}></div>
                                                </div>
                                                <span className="text-[10px] font-black text-slate-400">{done}/{total}</span>
                                            </div>
                                        </div>
                                        <div className="flex gap-2 ml-4">
                                            <button onClick={() => startMode('card', id)} className="w-11 h-11 bg-indigo-600 text-white rounded-2xl flex items-center justify-center shadow-md btn-active">ğŸ“–</button>
                                            <button onClick={() => {startMode('test', id); setIsTest(true);setIsChallenge(false);setIsWrongSetMode(false);}}className="w-11 h-11 bg-slate-100 text-slate-600 rounded-2xl flex items-center justify-center btn-active">ğŸ•¹ï¸</button>
                                        </div>
                                    </div>
                                );
                            })}
                            <div style={{ height: '220px' }}></div>



                        </div>
                        
                        <nav className="floating-nav flex gap-3 max-w-md mx-auto">
                            <button onClick={() => startMode('survival')} className="flex-1 bg-indigo-50/80 text-indigo-700 h-[64px] rounded-[24px] btn-active flex items-center justify-center gap-2">
                                <div className="w-8 h-8 bg-indigo-600 text-white rounded-xl flex items-center justify-center text-xs shadow-sm">âš¡</div>
                                <div className="text-left"><p className="text-[10px] font-black uppercase opacity-60 leading-none">å…¨é‡æŒ‘æˆ°</p><p className="text-[13px] font-black leading-none mt-1">ç”Ÿå­˜æ¨¡å¼</p></div>
                            </button>
                            <button onClick={() => startMode('wrong')} className="flex-1 bg-slate-50/80 text-slate-700 h-[64px] rounded-[24px] btn-active flex items-center justify-center gap-2 relative">
                                {wrongWords.length > 0 && <span className="badge">{wrongWords.length}</span>}
                                <div className="w-8 h-8 bg-slate-200 text-slate-600 rounded-xl flex items-center justify-center text-xs">ğŸ“•</div>
                                <div className="text-left"><p className="text-[10px] font-black uppercase opacity-60 leading-none">éå›ºç·´ç¿’</p><p className="text-[13px] font-black leading-none mt-1">æˆ‘çš„éŒ¯é¡Œ</p></div>
                            </button>
                        </nav>


{showLeaderboard && (
    <div className="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-md flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div className="bg-slate-50 w-full max-w-md h-[90vh] sm:h-[80vh] rounded-t-[40px] sm:rounded-[40px] flex flex-col relative shadow-2xl animate-in slide-in-from-bottom duration-300">
            
            {/* å…³é—­æŒ‰é’® */}
            <button 
                onClick={() => setShowLeaderboard(false)}
                className="absolute top-4 right-4 z-10 w-10 h-10 bg-white/80 rounded-full flex items-center justify-center text-xl shadow-sm"
            >
                âœ•
            </button>

            {/* å†…å®¹åŒº */}
            <div className="flex-1 overflow-y-auto p-6 pt-10">
                <Leaderboard />
            </div>

            {/* åº•éƒ¨æŒ‰é’® */}
            <div className="p-6 bg-white border-t border-slate-100 rounded-b-[40px]">
                <button 
                    onClick={() => setShowLeaderboard(false)}
                    className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg active:scale-95 transition-transform"
                >
                    æˆ‘çŸ¥é“å•¦
                </button>
            </div>
        </div>
    </div>
)}

                    </div>
                );
            }

            const wordInfo = dbData && currentKey ? (Object.values(dbData).find(l => l.words[currentKey])?.words[currentKey]) : null;

            return (
                <div className="max-w-md mx-auto h-screen flex flex-col p-6 bg-white overflow-hidden" onTouchStart={handleTouchStart} onTouchEnd={handleTouchEnd}>
                   <header className="flex flex-col gap-4 mb-6">
   {/* ç¬¬ä¸€è¡Œï¼šè¿”å›æŒ‰é’® + æ˜Ÿæ˜Ÿè¿›åº¦ */}
<div className="flex justify-between items-center">
    <button 
        onClick={() => setView('menu')} 
        className="bg-slate-50 h-10 px-4 rounded-2xl font-black text-slate-400 text-[11px] uppercase border border-slate-100 btn-active flex items-center justify-center"
    >
        â† è¿”å›
    </button>

    {/* âœ… åªæœ‰åœ¨ Card æ¨¡å¼ æˆ– Test æ¨¡å¼ä¸‹æ‰æ˜¾ç¤ºæ˜Ÿæ˜Ÿè¿›åº¦æ¡ */}
    {(view === 'card' && !isWrongSetMode && !isChallenge) || isTest ? (
        <div className="bg-slate-50/50 border border-slate-100 px-3 py-1.5 rounded-2xl flex items-center gap-1.5 shadow-inner">
            {[0, 1, 2, 3, 4].map(starIdx => {
                const levelWords = Object.keys(dbData[currentLevel].words);
                const learnedInLevel = learnedWords.filter(w => levelWords.includes(w)).length;
                const earnedStars = Math.floor(learnedInLevel / 20);
                const isActive = starIdx < earnedStars;
                
                return (
                    <div key={starIdx} className="relative w-6 h-6 flex items-center justify-center">
                        <span className="text-slate-200 text-lg absolute">â˜†</span>
                        {isActive && (
                            <span 
                                className="text-amber-400 text-lg absolute animate-in zoom-in duration-500 drop-shadow-[0_0_8px_rgba(251,191,36,0.4)]"
                                style={{ animationDelay: `${starIdx * 100}ms` }}
                            >
                                â­
                            </span>
                        )}
                    </div>
                );
            })}
        </div>
    ) : (
        /* é Card/Test æ¨¡å¼æ—¶ï¼Œä¸­é—´ç•™ç©ºä»¥ä¿æŒå¸ƒå±€å¹³è¡¡ */
        <div className="flex-1"></div>
    )}

    {/* å³ä¾§å ä½ */}
    <div className="w-[60px]"></div> 
</div>

    {/* ç¬¬äºŒè¡Œï¼šå·¦ä¾§æ˜¾ç¤ºå…³å¡åï¼Œå³ä¾§æ˜¾ç¤ºè¿›åº¦æ•°å­— */}
    <div className="flex justify-between items-end px-1">
        <div className="flex flex-col">
            <span className="text-[9px] font-black text-slate-300 uppercase tracking-widest leading-none mb-1">{isChallenge ? "Survival Mode" : (isWrongSetMode ?"Review Mode":"Current Progress")}</span>
            <div className="text-[14px] font-black text-slate-600">
                {isChallenge ? "æŒ‘æˆ° 1000 è©" : (isWrongSetMode ? "éŒ¯é¡Œè¤‡ç¿’" : `LEVEL ${currentLevel}`)}
		
            </div>
        </div>
        <div className="text-right">
            <span className="text-[9px] font-black text-slate-300 uppercase tracking-widest leading-none mb-1">{isChallenge ? "Total Attempt" : "Word Count"}</span>
            <div className="text-[14px] font-black text-indigo-600">
                {idx + 1} <span className="text-slate-300">/</span> {isChallenge ? fullList.length : currentList.length}
            </div>
        </div>
    </div>
</header>
                    <div className="flex-1 flex flex-col items-center justify-center relative">
                        {wordInfo && (
                            view === 'card' ? (
                                <div className="w-full flex flex-col items-center">
                     
					<div className={`card-inner ${flipped ? 'flipped' : ''}`} onClick={() => setFlipped(!flipped)}>
                                        <div className="card-face bg-white border-slate-50">
                                           
											{/* ç»Ÿä¸€å®¹å™¨ï¼šé«˜åº¦å›ºå®šåœ¨ 130px å·¦å³ */}
                                            <div 
        										className="h-32 mb-4 flex items-end justify-center select-none cursor-pointer"
       											 onClick={(e) => { e.stopPropagation(); speak(currentKey); }}
    											>
       											 {renderMedia(wordInfo[0])}
    										</div>

  											  <div className="text-5xl font-black text-slate-800 uppercase tracking-tighter">
        										{currentKey}
   											 </div>

                                            <button onClick={(e) => { e.stopPropagation(); speak(currentKey); }} className="mt-8 w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center text-2xl btn-active border border-slate-100">ğŸ”Š</button>
                                        </div>
                                        <div className="card-face card-back">
                                            <div className="text-4xl font-black mb-2 text-center px-4">{wordInfo[1]}</div>
                                            <div className="text-indigo-100 text-sm italic mb-8 opacity-80">{wordInfo[2]}</div>
                                            <div onClick={(e) => { e.stopPropagation(); speak(wordInfo[3]); }} className="bg-white/10 p-6 rounded-[32px] mb-8 italic text-sm leading-relaxed text-center border border-white/10 cursor-pointer">
                                                "{wordInfo[3]}"
                                            </div>
                                            <button onClick={(e) => { 
                                                e.stopPropagation(); 

// 1. è·å–å½“å‰å…³å¡æ‰€æœ‰å•è¯åŠå…¶å­¦ä¼šçŠ¶æ€
        const levelWords = Object.keys(dbData[currentLevel].words);
        const countInCurrentLevel = learnedWords.filter(w => levelWords.includes(w)).length;
        const isLevelCompleted = countInCurrentLevel >= 100;

        // 2. å¦‚æœå·²ç»å…¨å­¦å®Œäº†ï¼Œç›´æ¥åˆ‡åˆ°ä¸‹ä¸€ä¸ªï¼Œä¸æ‰§è¡ŒåŠ å…¥åˆ—è¡¨é€»è¾‘
        if (isLevelCompleted) {
            setFlipped(false);
            handleNext();
            return;
        }





setIsChecking(true); playSound('correct');
                                                setTimeout(() => { 
     
const isNewWord = !learnedWords.includes(currentKey);
if (isNewWord) {
    // 1. âœ…å…ˆæ›´æ–°å…¨å±€å­¦ä¼šåˆ—è¡¨
    const newTotalLearned = [...learnedWords, currentKey];
    setLearnedWords(newTotalLearned);

    // 2. âœ… è·å–ã€å½“å‰å…³å¡ã€‘çš„æ‰€æœ‰å•è¯ Key
    const levelWords = Object.keys(dbData[currentLevel].words);
    
    // 3. âœ… è®¡ç®—ã€å½“å‰å…³å¡ã€‘é‡Œå·²ç»å­¦ä¼šäº†å¤šå°‘ä¸ª
    const countInCurrentLevel = newTotalLearned.filter(w => levelWords.includes(w)).length;

    // 4. âœ… åˆ¤æ–­æ˜¯å¦è¾¾åˆ°å½“å‰å…³å¡çš„ 20 å€æ•°
    if (countInCurrentLevel > 0 && countInCurrentLevel % 20 === 0) {
	
    // 5. âœ…è®¡ç®—ç´¢å¼•ï¼š(å½“å‰å…³å¡-1)*5 + (å½“å‰é¢˜æ•°/20 - 1)
        const quoteIdx = (parseInt(currentLevel) - 1) * 5 + (Math.floor(idx / 20) - 1);
        const quote = MOTIVATIONAL_QUOTES[quoteIdx] || "Keep it up!";

    // 6. âœ…æ›´æ–°æ–‡å­—çŠ¶æ€å¹¶æ˜¾ç¤ºå¼¹çª—
        setCurrentQuote(quote);
 	playSound('star');
	triggerStars();
        setShowStageClear(true);

    // 7. âœ…åŒæ­¥è¯­éŸ³æœ—è¯» (å»¶è¿Ÿ 0.5s ç­‰éŸ³æ•ˆæ’­å®Œ)
        setTimeout(() => speak(quote), 500);
    }
}
                                                    setFlipped(false); setIsChecking(false); handleNext();
                                                }, 800);
                                            }} 

className={`mt-8 w-20 h-20 rounded-full border-4 flex items-center justify-center transition-all ${
        (learnedWords.filter(w => Object.keys(dbData[currentLevel].words).includes(w)).length >= 100)
            ? 'bg-slate-300 border-slate-300 opacity-50 cursor-default' // å·²å­¦å®Œï¼šç°è‰²
            : (isChecking ? 'bg-emerald-400 border-emerald-400 scale-110 btn-active' : 'bg-white/20 border-white btn-active') // å­¦ä¹ ä¸­
    }`}
>                                                <svg className="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="4" d="M5 13l4 4L19 7"/>
    </svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div className="swipe-hint"><span>â† æ»‘å‹•ä¸‹å€‹</span><span>å›çœ‹ä¸Šå€‹ â†’</span></div>
                                </div>
                            ) : (
                                <div className="w-full px-4 text-center">
                                    {/* åŠ¨æ€è®¡ç®—å­—å·ï¼š1ä¸ªEmojiç”¨120pxï¼Œ2ä¸ªç”¨80pxï¼Œ3ä¸ªåŠä»¥ä¸Šç”¨60px */}
                                            <div 
        										className="h-32 mb-16 flex items-end justify-center select-none cursor-pointer"
        										onClick={(e) => { e.stopPropagation(); speak(currentKey); }}
                                                >
                                                  {renderMedia(wordInfo[0])}
                                            </div>
                                   			<div className="grid grid-cols-2 gap-4">
												
                                        {shuffledOptions.map((opt, i) => (
                                            <button key={`${currentKey}-${opt}-${i}`} onClick={() => handleChoice(opt)}
                                                className={`p-6 rounded-[32px] font-black text-lg border-b-[6px] transition-all btn-active ${
                                                    testFeedback === 'correct' && opt === currentKey ? 'bg-emerald-500 text-white border-emerald-700' :
                                                    testFeedback === 'wrong' && opt !== currentKey ? 'bg-rose-50 text-rose-300 border-rose-100' : 
                                                    (testFeedback === 'wrong' && opt === currentKey ? 'bg-emerald-100 text-emerald-500 border-emerald-200' : 'bg-white text-slate-600 border-slate-100 shadow-sm')
                                                }`}
                                            >{opt}</button>
                                        ))}
                                    </div>
                                </div>
                            )
                        )}


                    </div>



{/* é˜¶æ®µæ€§å¥–åŠ±å¼¹çª— */}
{showStageClear && (
    <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-6">
        <div className="bg-white rounded-[40px] p-8 flex flex-col items-center shadow-2xl animate-in zoom-in duration-300 w-full max-w-sm border-2 border-slate-100">
            
            {/* åŠ¨æ€ Emoji åŠ¨ç”» */}
            <div className="text-8xl mb-4 animate-bounce drop-shadow-xl">
                {getStageInfo().emoji}
            </div>

            <div className="text-center mb-6">
                <h2 className="text-2xl font-black text-slate-800">{currentQuote}</h2>
                <p className="text-indigo-600 font-bold uppercase text-[10px] tracking-widest mt-1">è·å¾—é˜¶æ®µå‹‹ç« </p>
            </div>
            
            {/* 5æ ¼è¿›åº¦æŒ‡ç¤ºå™¨ */}
            <div className="flex gap-3 mb-8">
                {[1, 2, 3, 4, 5].map((s) => (
                    <div 
                        key={s}
                        className={`w-4 h-4 rounded-full border-2 transition-all duration-500 ${
                            s <= getStageInfo().stage ? 'bg-indigo-500 border-indigo-200 scale-110' : 'bg-slate-100 border-slate-50'
                        }`}
                    ></div>
                ))}
            </div>

            <p className="text-slate-500 font-bold mb-8 text-center text-sm">
                ä½ å·²åœ¨ Level {currentLevel} å­¦å®Œ <span className="text-indigo-600 text-xl">{getStageInfo().count}</span> è¯<br/>
		
                <span className="text-indigo-600 font-bold text-center mb-6 text-lg px-4">{getStageInfo().count >= 100 ? "æœ¬å…³æ‰“å¡æˆåŠŸ!" : "å†å­¦20ä¸ªå•è¯è§£é”æ–°å‹‹ç« å“¦!"} </span> 
            </p>

            <button 
                onClick={() => setShowStageClear(false)}
                className="w-full bg-slate-900 text-white text-lg font-black py-4 rounded-3xl shadow-lg active:scale-95 transition-all"
            >
                ç»§ç»­ä¸‹ä¸€ç»„
            </button>
        </div>
    </div>
)}
                    
{showGameOver && (
    <div className="fixed inset-0 z-[200] flex items-center justify-center bg-slate-900/90 backdrop-blur-xl p-6">
        {/* åˆ¤æ–­æ˜¯å¦ä¸ºæ™®é€šé—¯å…³æ¨¡å¼ (Cardæ¨¡å¼) */}
        {(!isChallenge && !isTest && !isWrongSetMode) ? (
            /* ==========================================
               1. CARD æ¨¡å¼ (é¢†å–å‹‹ç« ç•Œé¢)
               ========================================== */
            <div className="bg-white rounded-[56px] p-10 flex flex-col items-center shadow-2xl w-full max-w-sm border-2 border-amber-100 relative animate-in fade-in zoom-in duration-300">
                {/* ç»ˆæå‹‹ç«  */}
                <div className="relative mb-6 medal-main">
                    <div className="text-[120px] leading-none filter drop-shadow-2xl animate-float">
                        {MISSION_REWARDS[currentLevel] ? MISSION_REWARDS[currentLevel][4] : "ğŸ†"}
                    </div>
                </div>

                {/* äº”æ˜ŸåŠ¨æ€å¼¹å‡º */}
                <div className="flex gap-1 mb-6">
                    {[1, 2, 3, 4, 5].map((s) => (
                        <span key={s} className="text-4xl star-animated" style={{ animationDelay: `${s * 0.15}s` }}>â­</span>
                    ))}
                </div>

                <div className="text-center mb-10">
                    <h2 className="text-3xl font-black text-slate-800 tracking-tight leading-none mb-2">LEVEL {currentLevel}</h2>
                    <div className="bg-amber-100 text-amber-700 text-[10px] font-black px-4 py-1 rounded-full uppercase tracking-widest inline-block">
                        å‹‹ç« å·²æ”¶å…¥æ”¶è—å¤¹
                    </div>
                    <p className="text-amber-500 font-black mt-4 text-xl">å·²å­¦å®Œ 100 ä¸ªå•è¯ï¼</p>
                </div>

                <button 
                    onClick={() => { setShowGameOver(false); setView('menu'); setIdx(0); }}
                    className="w-full bg-indigo-600 text-white py-5 rounded-[28px] font-black text-xl shadow-xl active:scale-95 transition-all"
                >
                    é¢†å–å¹¶è¿”å›
                </button>
            </div>
        ) : (
            /* ==========================================
               2. å…¶ä»–æ¨¡å¼ (Challenge, Test, WrongSet)
               ========================================== */
            <div className={`bg-white p-10 rounded-[56px] text-center w-full max-w-[380px] shadow-2xl transform transition-all ${score >= 1000 ? 'gold-glow' : ''}`}>
                {isChallenge && score >= 1000 ? (
                    /* ç‰¹æ®Šæƒ…å†µï¼šæŒ‘æˆ˜æ¨¡å¼å¤§æ»¡è´¯ */
                    <>
                        <div className="text-8xl mb-6 floating-emoji">ğŸ‘‘</div>
                        <h2 className="text-2xl font-black mb-4 tracking-tight leading-tight">
                            Congratulations, <span className="text-yellow-500">{userName || 'Steve'}</span>!
                        </h2>
                        <p className="text-slate-600 font-bold mb-8 leading-relaxed">
                            ç¥è³€ä½ åœ¨ <span className="text-emerald-500 text-xl">{streak}</span> å¤©å…§å®Œæˆäº† <span className="text-indigo-600 text-xl">1000è©</span> å¤§æŒ‘æˆ°ï¼
                        </p>
                    </>
                ) : (
                    /* å¸¸è§„æµ‹è¯•/é”™é¢˜/æ™®é€šæŒ‘æˆ˜ç»“æœ */
                    <>
                        <div className="text-8xl mb-6">
                            {isChallenge ? (score > highScore ? "ğŸ†" : "ğŸ‰") : "âœ…"}
                        </div>
                        <h2 className="text-2xl font-black mb-2">
                            {isChallenge ? (score >= highScore ? "æ‰“ç ´ç´€éŒ„!" : "å¤ªæ£’äº†!") : (isWrongSetMode ? "è¨‚æ­£å®Œæˆ!" : (isTest ? "æ¸¬è©¦å®Œæˆï¼" : "å­¸ç¿’å®Œæˆ!"))}
                        </h2>
                        <div className="mb-8">
                            {isChallenge ? (
                                <p className="font-black text-slate-400 text-lg uppercase tracking-widest">
                                    Score: {score}
                                </p>
                            ) : (
                                <div className="flex flex-col items-center gap-2">
                                    <p className="font-black text-slate-400 text-sm uppercase tracking-widest">
                                        {isWrongSetMode ? "é”™é¢˜è¤‡ç¿’é€²åº¦" : "æœ¬æ¬¡æ¸¬è©¦æˆæœ"}
                                    </p>
                                    <p className="text-4xl font-black text-indigo-600">
                                        {isWrongSetMode ? `å·²è¨‚æ­£ ${currentList.length} å€‹å–®å­—` : `å·²è¤‡ç¿’å®Œ ${currentList.length} å€‹å•å­—`}
                                    </p>
                                    <p className="text-[11px] font-bold text-slate-400 uppercase tracking-tight mt-1">
                                        {isWrongSetMode ? "Review Mode Completed" : "Test Session Finished"}
                                    </p>
                                </div>
                            )}
                        </div>
                    </>
                )}
                <button 
                    onClick={() => { setShowGameOver(false); setView('menu'); setIdx(0); }} 
                    className="w-full bg-slate-900 text-white py-5 rounded-[28px] font-black btn-active shadow-lg"
                >
                    å›åˆ°é¦–é 
                </button>
            </div>
        )}
    </div>
)}



                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
// --- æ³¨å†Œ Service Worker å¼€å§‹ ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // æ³¨æ„ï¼šsw.js å¿…é¡»å­˜æ”¾åœ¨ä½ æœåŠ¡å™¨çš„æ ¹ç›®å½•ä¸‹
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('æœåŠ¡å·¥ä½œçº¿ç¨‹å·²å°±ç»ªï¼èŒƒå›´:', reg.scope))
                    .catch(err => console.error('æ³¨å†Œå¤±è´¥:', err));
            });
        }
        // --- æ³¨å†Œ Service Worker ç»“æŸ ---
    </script>
<script src="https://fastly.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</body>
</html>
